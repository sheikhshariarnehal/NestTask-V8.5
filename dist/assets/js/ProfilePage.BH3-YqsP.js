import{s as e,r as t,j as a,u as r}from"./index.Cm-yHY8f.js";import{u as s}from"./useAuth.CKw94YvF.js";import{L as o}from"./loader-2.Crm8zINe.js";import{X as l}from"./x.DlZiqKh9.js";import{U as n}from"./upload.B5AqJj85.js";import{U as i}from"./user.BO76aa4u.js";import{M as d}from"./mail.D0WRi2By.js";import{P as m}from"./phone.C94Sq2Se.js";import{C as c}from"./credit-card.DpDsXGEH.js";import{S as u}from"./save.CcVrGbmB.js";import{G as g}from"./graduation-cap.B-G9tw2G.js";import{S as x}from"./shield.DN2hC7Mb.js";import{L as p}from"./lock.CR-xncOG.js";import"./dataCache.jSzv44up.js";import"./authErrors.BDay5vyW.js";import"./createLucideIcon.D4ev3ovP.js";async function h(t,a){try{const r={};void 0!==a.name&&(r.name=a.name),void 0!==a.phone&&(r.phone=a.phone),void 0!==a.studentId&&(r.student_id=a.studentId),void 0!==a.avatar&&(r.avatar=a.avatar);const{data:s,error:o}=await e.from("users").update(r).eq("id",t).select("\n        id,\n        email,\n        name,\n        phone,\n        student_id,\n        role,\n        created_at,\n        last_active,\n        avatar,\n        department_id,\n        batch_id,\n        section_id\n      ").single();if(o)throw console.error("Update error:",o),new Error(`Failed to update profile: ${o.message}`);return{id:s.id,email:s.email,name:s.name,phone:s.phone,studentId:s.student_id,role:s.role,createdAt:s.created_at,lastActive:s.last_active,avatar:s.avatar,departmentId:s.department_id,batchId:s.batch_id,sectionId:s.section_id}}catch(r){throw console.error("Error updating user profile:",r),r}}function b({userId:r,currentPhotoUrl:s,onPhotoUpdate:i,userName:d}){const[m,c]=t.useState(!1),[u,g]=t.useState(s||null),[x,p]=t.useState(null),h=t.useRef(null),b=(null==d?void 0:d.charAt(0).toUpperCase())||"?";return a.jsxs("div",{className:"flex flex-col items-center gap-4 sm:gap-5",children:[a.jsxs("div",{className:"relative group",children:[a.jsx("div",{className:"w-28 h-28 sm:w-32 sm:h-32 rounded-full overflow-hidden ring-4 ring-blue-100 dark:ring-blue-900/30 bg-gradient-to-br from-blue-500 to-indigo-600 shadow-md",children:u?a.jsx("img",{src:u,alt:d,className:"w-full h-full object-cover transition-transform group-hover:scale-105 duration-300"}):a.jsx("div",{className:"w-full h-full flex items-center justify-center text-white text-4xl sm:text-5xl font-bold select-none",children:b})}),m&&a.jsx("div",{className:"absolute inset-0 bg-black/50 rounded-full flex items-center justify-center z-10",children:a.jsx(o,{className:"w-8 h-8 text-white animate-spin"})}),u&&!m&&a.jsx("button",{onClick:async()=>{if(confirm("Are you sure you want to remove your profile photo?")){c(!0),p(null);try{await async function(t){try{const{data:a,error:r}=await e.storage.from("profile-photos").list(t);if(r)throw new Error(`Failed to list files: ${r.message}`);if(a&&a.length>0){const r=a.map((e=>`${t}/${e.name}`)),{error:s}=await e.storage.from("profile-photos").remove(r);if(s)throw new Error(`Failed to delete files: ${s.message}`)}const{error:s}=await e.from("users").update({avatar:null}).eq("id",t);if(s)throw new Error(`Failed to update user record: ${s.message}`)}catch(x){throw console.error("Error deleting profile photo:",x),x}}(r),g(null),i(null)}catch(t){console.error("Delete failed:",t),p(t.message||"Failed to delete photo")}finally{c(!1)}}},className:"absolute top-0 right-0 p-2 sm:p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-all hover:scale-110 touch-manipulation focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800",title:"Remove photo","aria-label":"Remove photo",children:a.jsx(l,{className:"w-4 h-4"})})]}),a.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 w-full sm:w-auto px-4 sm:px-0",children:[a.jsx("input",{ref:h,type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:t=>{var a;const o=null==(a=t.target.files)?void 0:a[0];if(!o)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(o.type))return void p("Please upload a valid image file (JPEG, PNG, GIF, or WebP)");if(o.size>5242880)return void p("File size must be less than 5MB");p(null);const l=new FileReader;l.onloadend=()=>{g(l.result)},l.readAsDataURL(o),(async t=>{c(!0),p(null);try{const a=await async function(t,a){try{if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(a.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, GIF, or WebP image.");const r=5242880;if(a.size>r)throw new Error("File size exceeds 5MB limit.");const s=a.name.split(".").pop(),o=`${t}/avatar-${Date.now()}.${s}`,{data:l}=await e.storage.from("profile-photos").list(t);if(l&&l.length>0){const a=l.map((e=>`${t}/${e.name}`));await e.storage.from("profile-photos").remove(a)}const{error:n}=await e.storage.from("profile-photos").upload(o,a,{cacheControl:"3600",upsert:!0});if(n)throw console.error("Upload error:",n),new Error(`Failed to upload profile photo: ${n.message}`);const{data:{publicUrl:i}}=e.storage.from("profile-photos").getPublicUrl(o);return i}catch(x){throw console.error("Error uploading profile photo:",x),x}}(r,t);g(a),i(a)}catch(a){console.error("Upload failed:",a),p(a.message||"Failed to upload photo"),g(s||null)}finally{c(!1)}})(o)},className:"hidden"}),a.jsxs("button",{onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},disabled:m,className:"w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-2.5 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white rounded-lg transition-colors font-medium touch-manipulation shadow-sm text-sm sm:text-base",children:[m?a.jsx(o,{className:"w-4 h-4 animate-spin"}):a.jsx(n,{className:"w-4 h-4 sm:w-5 sm:h-5"}),u?"Change Photo":"Upload Photo"]})]}),x&&a.jsx("div",{className:"text-sm text-red-600 dark:text-red-400 text-center max-w-xs animate-fade-in px-4",children:x}),a.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center max-w-xs px-4",children:["Recommended: Square image, max 5MB",a.jsx("br",{}),"Formats: JPEG, PNG, GIF, WebP"]})]})}function f(){const{user:l,refreshUser:n,loading:f}=s(),y=r(),[w,j]=t.useState(l),[,v]=t.useState(!1),[N,k]=t.useState(!1),[P,E]=t.useState(null),[_,S]=t.useState(null),[I,F]=t.useState((null==l?void 0:l.name)||""),[C,A]=t.useState((null==l?void 0:l.phone)||""),[U,$]=t.useState((null==l?void 0:l.studentId)||""),[G,q]=t.useState(!1),[,z]=t.useState(""),[D,R]=t.useState(""),[L,B]=t.useState("");t.useEffect((()=>{f||l||y("/auth")}),[l,f,y]),t.useEffect((()=>{l&&M()}),[l]);const M=async()=>{if(null==l?void 0:l.id){v(!0);try{const t=await async function(t){var a,r,s,o,l,n;try{const{data:i,error:d}=await e.from("users").select("\n        id,\n        email,\n        name,\n        phone,\n        student_id,\n        role,\n        created_at,\n        last_active,\n        avatar,\n        department_id,\n        batch_id,\n        section_id,\n        departments:department_id(name),\n        batches:batch_id(name),\n        sections:section_id(name)\n      ").eq("id",t).single();if(d)throw new Error(`Failed to fetch profile: ${d.message}`);return{id:i.id,email:i.email,name:i.name,phone:i.phone,studentId:i.student_id,role:i.role,createdAt:i.created_at,lastActive:i.last_active,avatar:i.avatar,departmentId:i.department_id,batchId:i.batch_id,sectionId:i.section_id,departmentName:Array.isArray(i.departments)?null==(a=i.departments[0])?void 0:a.name:null==(r=i.departments)?void 0:r.name,batchName:Array.isArray(i.batches)?null==(s=i.batches[0])?void 0:s.name:null==(o=i.batches)?void 0:o.name,sectionName:Array.isArray(i.sections)?null==(l=i.sections[0])?void 0:l.name:null==(n=i.sections)?void 0:n.name}}catch(P){throw console.error("Error fetching user profile:",P),P}}(l.id);j(t),F(t.name||""),A(t.phone||""),$(t.studentId||"")}catch(t){console.error("Failed to load profile:",t),E(t.message)}finally{v(!1)}}};return f||!w&&l?a.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:a.jsx(o,{className:"w-8 h-8 text-blue-500 animate-spin"})}):w?a.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 pb-20 md:pb-8",children:a.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6 sm:py-8 space-y-6 safe-area-bottom",children:[_&&a.jsx("div",{className:"p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-green-800 dark:text-green-200 text-sm sm:text-base animate-fade-in",children:_}),P&&a.jsx("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-800 dark:text-red-200 text-sm sm:text-base animate-fade-in",children:P}),a.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[a.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[a.jsx("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4 sm:mb-6",children:"Profile Photo"}),a.jsx(b,{userId:w.id,currentPhotoUrl:w.avatar,onPhotoUpdate:async e=>{if(null==w?void 0:w.id)try{await h(w.id,{avatar:e}),j({...w,avatar:e||void 0}),n&&await n(),S("Profile photo updated successfully"),setTimeout((()=>S(null)),3e3)}catch(t){E(t.message)}},userName:w.name})]}),a.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),null==w?void 0:w.id){k(!0),E(null),S(null);try{if(!I.trim())throw new Error("Name is required");const e=await h(w.id,{name:I.trim(),phone:C.trim()||void 0,studentId:U.trim()||void 0});j(e),n&&await n(),S("Profile updated successfully!"),setTimeout((()=>S(null)),3e3)}catch(t){console.error("Failed to update profile:",t),E(t.message)}finally{k(!1)}}},className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[a.jsx("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4 sm:mb-6",children:"Personal Information"}),a.jsxs("div",{className:"space-y-4 sm:space-y-5",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2",children:[a.jsx(i,{className:"w-4 h-4"}),"Full Name *"]}),a.jsx("input",{type:"text",value:I,onChange:e=>F(e.target.value),required:!0,className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Enter your full name"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2",children:[a.jsx(d,{className:"w-4 h-4"}),"Email Address"]}),a.jsx("input",{type:"email",value:w.email,disabled:!0,className:"w-full px-3 sm:px-4 py-2.5 bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-500 dark:text-gray-400 cursor-not-allowed text-sm sm:text-base"}),a.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Email cannot be changed"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2",children:[a.jsx(m,{className:"w-4 h-4"}),"Phone Number"]}),a.jsx("input",{type:"tel",value:C,onChange:e=>A(e.target.value),className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Enter your phone number"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2",children:[a.jsx(c,{className:"w-4 h-4"}),"Student ID"]}),a.jsx("input",{type:"text",value:U,onChange:e=>$(e.target.value),className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Enter your student ID"})]}),a.jsx("button",{type:"submit",disabled:N,className:"w-full sm:w-auto mt-2 flex items-center justify-center gap-2 px-6 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white font-medium rounded-lg transition-colors touch-manipulation shadow-sm text-sm sm:text-base",children:N?a.jsxs(a.Fragment,{children:[a.jsx(o,{className:"w-4 h-4 animate-spin"}),"Saving..."]}):a.jsxs(a.Fragment,{children:[a.jsx(u,{className:"w-4 h-4"}),"Save Changes"]})})]})]}),a.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[a.jsxs("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4 sm:mb-6 flex items-center gap-2",children:[a.jsx(g,{className:"w-5 h-5"}),"Academic Information"]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 block mb-1",children:"Department"}),a.jsx("p",{className:"text-sm sm:text-base text-gray-900 dark:text-white font-medium break-words",children:w.departmentName||"Not assigned"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 block mb-1",children:"Batch"}),a.jsx("p",{className:"text-sm sm:text-base text-gray-900 dark:text-white font-medium break-words",children:w.batchName||"Not assigned"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 block mb-1",children:"Section"}),a.jsx("p",{className:"text-sm sm:text-base text-gray-900 dark:text-white font-medium break-words",children:w.sectionName||"Not assigned"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 block mb-1 flex items-center gap-1",children:[a.jsx(x,{className:"w-3.5 h-3.5"}),"Role"]}),a.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 capitalize",children:w.role.replace("-"," ")})]})]}),a.jsx("p",{className:"mt-4 sm:mt-6 text-xs text-gray-500 dark:text-gray-400",children:"Contact your administrator to update academic information"})]}),a.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4 sm:mb-6",children:[a.jsxs("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2",children:[a.jsx(p,{className:"w-5 h-5"}),"Password & Security"]}),!G&&a.jsx("button",{onClick:()=>q(!0),className:"text-sm text-blue-500 hover:text-blue-600 font-medium self-start sm:self-auto px-3 py-1.5 -ml-3 sm:ml-0 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors",children:"Change Password"})]}),G?a.jsxs("form",{onSubmit:async t=>{t.preventDefault(),E(null),S(null);try{if(!D||D.length<6)throw new Error("Password must be at least 6 characters");if(D!==L)throw new Error("Passwords do not match");k(!0),await async function(t){try{const{error:a}=await e.auth.updateUser({password:t});if(a)throw new Error(`Failed to change password: ${a.message}`)}catch(P){throw console.error("Error changing password:",P),P}}(D),S("Password changed successfully!"),z(""),R(""),B(""),q(!1),setTimeout((()=>S(null)),3e3)}catch(a){console.error("Failed to change password:",a),E(a.message)}finally{k(!1)}},className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2 block",children:"New Password *"}),a.jsx("input",{type:"password",value:D,onChange:e=>R(e.target.value),required:!0,minLength:6,className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Enter new password"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2 block",children:"Confirm New Password *"}),a.jsx("input",{type:"password",value:L,onChange:e=>B(e.target.value),required:!0,minLength:6,className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Confirm new password"})]}),a.jsxs("div",{className:"flex flex-col-reverse sm:flex-row gap-3 pt-2",children:[a.jsx("button",{type:"button",onClick:()=>{q(!1),R(""),B("")},className:"w-full sm:w-auto px-4 py-2.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm sm:text-base font-medium",children:"Cancel"}),a.jsx("button",{type:"submit",disabled:N,className:"w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-2.5 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white font-medium rounded-lg transition-colors touch-manipulation shadow-sm text-sm sm:text-base",children:N?a.jsxs(a.Fragment,{children:[a.jsx(o,{className:"w-4 h-4 animate-spin"}),"Updating..."]}):"Update Password"})]}),a.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:"Password must be at least 6 characters long"})]}):a.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Keep your account secure by using a strong password"})]})]})]})}):null}export{f as ProfilePage};
