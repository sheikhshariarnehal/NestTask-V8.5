import{s as c}from"./index.BsUn6o1f.js";const h=e=>{const t=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/,i=e.match(t);if(i)return`https://www.youtube.com/embed/${i[1]}`;const n=/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,a=e.match(n);return a?`https://drive.google.com/file/d/${a[1]}/preview`:null},v=e=>e.includes("youtube.com")||e.includes("youtu.be")?"youtube":e.includes("drive.google.com")?"google-drive":"other",L=e=>{try{return new URL(e),h(e)!==null}catch(t){return!1}},b=e=>{try{return new URL(e),!0}catch(t){return!1}},_=[".pdf",".ppt",".pptx",".doc",".docx",".txt",".rtf",".md",".xls",".xlsx",".jpg",".jpeg",".png",".gif",".svg"],w=e=>{const t=e.toLowerCase().substring(e.lastIndexOf("."));return _.includes(t)},k=e=>{switch(e.toLowerCase().substring(e.lastIndexOf("."))){case".pdf":return"ðŸ“„";case".ppt":case".pptx":return"ðŸ“Š";case".doc":case".docx":return"ðŸ“";case".xls":case".xlsx":return"ðŸ“ˆ";case".jpg":case".jpeg":case".png":case".gif":case".svg":return"ðŸ–¼ï¸";default:return"ðŸ“"}};function p(e){return{id:e.id,title:e.title,description:e.description||"",sectionId:e.section_id,fileUrls:e.file_urls||[],originalFileNames:e.original_file_names||[],slideLinks:e.slide_links||[],videoLinks:e.video_links||[],createdAt:e.created_at,createdBy:e.created_by,updatedAt:e.updated_at,section:e.section?{id:e.section.id,name:e.section.name,batch:e.section.batch?{id:e.section.batch.id,name:e.section.batch.name,department:e.section.batch.department?{id:e.section.batch.department.id,name:e.section.batch.department.name}:void 0}:void 0}:void 0,creator:e.creator?{id:e.creator.id,name:e.creator.name,email:e.creator.email}:void 0}}async function g(e,t){try{const i=e.name.split(".").pop(),n=`${crypto.randomUUID()}.${i}`,a=`${t}/${n}`,{error:r}=await c.storage.from("lecture-slides").upload(a,e,{cacheControl:"3600",upsert:!1});if(r)throw r;const{data:{publicUrl:s}}=c.storage.from("lecture-slides").getPublicUrl(a);return{url:s,originalName:e.name}}catch(i){throw console.error("Error uploading file:",i),i}}async function m(e){try{const{data:{user:t}}=await c.auth.getUser();if(!t)return!1;const{data:i}=await c.from("users").select("role, section_id").eq("id",t.id).single();return i?i.role==="super-admin"||i.role==="section_admin"&&i.section_id===e:!1}catch(t){return console.error("Error checking manage permission:",t),!1}}async function x(e){try{let t=c.from("lecture_slides").select("*").order("created_at",{ascending:!1});e!=null&&e.sectionId&&(t=t.eq("section_id",e.sectionId)),e!=null&&e.createdBy&&(t=t.eq("created_by",e.createdBy)),e!=null&&e.dateFrom&&(t=t.gte("created_at",e.dateFrom)),e!=null&&e.dateTo&&(t=t.lte("created_at",e.dateTo));const{data:i,error:n}=await t;if(n){if(n.code==="PGRST106"||n.message.includes('relation "lecture_slides" does not exist'))return console.warn("Lecture slides table does not exist yet. Please run the migration."),[];throw n}let a=(i||[]).map(r=>({id:r.id,title:r.title,description:r.description||"",sectionId:r.section_id,fileUrls:r.file_urls||[],originalFileNames:r.original_file_names||[],slideLinks:r.slide_links||[],videoLinks:r.video_links||[],createdAt:r.created_at,createdBy:r.created_by,updatedAt:r.updated_at,section:null,creator:null}));if(e!=null&&e.searchTerm){const r=e.searchTerm.toLowerCase();a=a.filter(s=>s.title.toLowerCase().includes(r)||s.description.toLowerCase().includes(r))}return a}catch(t){throw console.error("Error fetching lecture slides:",t),t}}async function P(e,t=[]){try{if(!await m(e.sectionId))throw new Error("Permission denied: You cannot create lecture slides for this section");let n=[],a=[];if(t.length>0){const d=await Promise.all(t.map(l=>g(l,e.sectionId)));n=d.map(l=>l.url),a=d.map(l=>l.originalName)}const r={title:e.title,description:e.description,section_id:e.sectionId,file_urls:[...e.fileUrls,...n],original_file_names:[...e.originalFileNames,...a],slide_links:e.slideLinks,video_links:e.videoLinks},{data:s,error:o}=await c.from("lecture_slides").insert(r).select("*").single();if(o)throw o.code==="PGRST106"||o.message.includes('relation "lecture_slides" does not exist')?new Error("Lecture slides table does not exist. Please run the database migration first."):o;if(!s)throw new Error("No data returned from lecture slide creation");return{id:s.id,title:s.title,description:s.description||"",sectionId:s.section_id,fileUrls:s.file_urls||[],originalFileNames:s.original_file_names||[],slideLinks:s.slide_links||[],videoLinks:s.video_links||[],createdAt:s.created_at,createdBy:s.created_by,updatedAt:s.updated_at,section:null,creator:null}}catch(i){throw console.error("Error creating lecture slide:",i),i}}async function E(e,t,i=[]){try{const{data:n}=await c.from("lecture_slides").select("section_id").eq("id",e).single();if(!n)throw new Error("Lecture slide not found");if(!await m(n.section_id))throw new Error("Permission denied: You cannot update this lecture slide");let r=[],s=[];if(i.length>0){const f=await Promise.all(i.map(u=>g(u,n.section_id)));r=f.map(u=>u.url),s=f.map(u=>u.originalName)}const o={};t.title!==void 0&&(o.title=t.title),t.description!==void 0&&(o.description=t.description),t.slideLinks!==void 0&&(o.slide_links=t.slideLinks),t.videoLinks!==void 0&&(o.video_links=t.videoLinks),i.length>0?(o.file_urls=[...t.fileUrls||[],...r],o.original_file_names=[...t.originalFileNames||[],...s]):t.fileUrls!==void 0&&(o.file_urls=t.fileUrls,o.original_file_names=t.originalFileNames||[]);const{data:d,error:l}=await c.from("lecture_slides").update(o).eq("id",e).select("*").single();if(l)throw l;if(!d)throw new Error("No data returned from lecture slide update");return p(d)}catch(n){throw console.error("Error updating lecture slide:",n),n}}async function U(e){try{const{data:t}=await c.from("lecture_slides").select("section_id, file_urls").eq("id",e).single();if(!t)throw new Error("Lecture slide not found");if(!await m(t.section_id))throw new Error("Permission denied: You cannot delete this lecture slide");if(t.file_urls&&t.file_urls.length>0){const a=t.file_urls.map(r=>{const s=r.split("/"),o=s[s.length-1];return`${t.section_id}/${o}`});try{await c.storage.from("lecture-slides").remove(a)}catch(r){console.warn("Error deleting files from storage:",r)}}const{error:n}=await c.from("lecture_slides").delete().eq("id",e);if(n)throw n}catch(t){throw console.error("Error deleting lecture slide:",t),t}}function F(e,t){const i=new URL(e);return i.searchParams.set("download",t),i.toString()}export{k as a,h as b,v as c,L as d,w as e,x as f,F as g,P as h,b as i,U as j,E as u};
