import{s as e,r as a,j as r,u as t}from"./index.CZiJqP2g.js";import{u as s}from"./useAuth.jlIkuF25.js";import{L as n}from"./loader-2.DRHkfZSD.js";import{X as d}from"./x.Dn_QyU__.js";import{U as i}from"./upload.CK9-V-H7.js";import{A as l,L as o}from"./lock.CqAdcTAb.js";import{U as c}from"./user.DEE9vQqD.js";import{M as m}from"./mail.DhPCihaR.js";import{P as g}from"./phone.L-E8oz6J.js";import{C as u}from"./credit-card.DAQ_yraQ.js";import{S as x}from"./save.BkFnYED4.js";import{G as h}from"./graduation-cap.DT6cVKhS.js";import{S as p}from"./shield.BZPinmRF.js";import"./dataCache.DP4PyhNH.js";import"./authErrors.BDay5vyW.js";import"./createLucideIcon.Chj3Q81j.js";async function b(a,r){try{const t={};void 0!==r.name&&(t.name=r.name),void 0!==r.phone&&(t.phone=r.phone),void 0!==r.studentId&&(t.student_id=r.studentId),void 0!==r.avatar&&(t.avatar=r.avatar);const{data:s,error:n}=await e.from("users").update(t).eq("id",a).select("\n        id,\n        email,\n        name,\n        phone,\n        student_id,\n        role,\n        created_at,\n        last_active,\n        avatar,\n        department_id,\n        batch_id,\n        section_id\n      ").single();if(n)throw new Error(`Failed to update profile: ${n.message}`);return{id:s.id,email:s.email,name:s.name,phone:s.phone,studentId:s.student_id,role:s.role,createdAt:s.created_at,lastActive:s.last_active,avatar:s.avatar,departmentId:s.department_id,batchId:s.batch_id,sectionId:s.section_id}}catch(t){throw t}}function f({userId:t,currentPhotoUrl:s,onPhotoUpdate:l,userName:o}){const[c,m]=a.useState(!1),[g,u]=a.useState(s||null),[x,h]=a.useState(null),p=a.useRef(null),b=(null==o?void 0:o.charAt(0).toUpperCase())||"?";return r.jsxs("div",{className:"flex flex-col items-center gap-4",children:[r.jsxs("div",{className:"relative",children:[r.jsx("div",{className:"w-32 h-32 rounded-full overflow-hidden ring-4 ring-blue-100 dark:ring-blue-900/30 bg-gradient-to-br from-blue-500 to-indigo-600",children:g?r.jsx("img",{src:g,alt:o,className:"w-full h-full object-cover"}):r.jsx("div",{className:"w-full h-full flex items-center justify-center text-white text-4xl font-bold",children:b})}),c&&r.jsx("div",{className:"absolute inset-0 bg-black/50 rounded-full flex items-center justify-center",children:r.jsx(n,{className:"w-8 h-8 text-white animate-spin"})}),g&&!c&&r.jsx("button",{onClick:async()=>{if(confirm("Are you sure you want to remove your profile photo?")){m(!0),h(null);try{await async function(a){try{const{data:r,error:t}=await e.storage.from("profile-photos").list(a);if(t)throw new Error(`Failed to list files: ${t.message}`);if(r&&r.length>0){const t=r.map((e=>`${a}/${e.name}`)),{error:s}=await e.storage.from("profile-photos").remove(t);if(s)throw new Error(`Failed to delete files: ${s.message}`)}const{error:s}=await e.from("users").update({avatar:null}).eq("id",a);if(s)throw new Error(`Failed to update user record: ${s.message}`)}catch(x){throw x}}(t),u(null),l(null)}catch(a){h(a.message||"Failed to delete photo")}finally{m(!1)}}},className:"absolute top-0 right-0 p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-colors",title:"Remove photo",children:r.jsx(d,{className:"w-4 h-4"})})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{ref:p,type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:a=>{var r;const n=null==(r=a.target.files)?void 0:r[0];if(!n)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(n.type))return void h("Please upload a valid image file (JPEG, PNG, GIF, or WebP)");if(n.size>5242880)return void h("File size must be less than 5MB");h(null);const d=new FileReader;d.onloadend=()=>{u(d.result)},d.readAsDataURL(n),(async a=>{m(!0),h(null);try{const r=await async function(a,r){try{if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, GIF, or WebP image.");const t=5242880;if(r.size>t)throw new Error("File size exceeds 5MB limit.");const s=r.name.split(".").pop(),n=`${a}/avatar-${Date.now()}.${s}`,{data:d}=await e.storage.from("profile-photos").list(a);if(d&&d.length>0){const r=d.map((e=>`${a}/${e.name}`));await e.storage.from("profile-photos").remove(r)}const{data:i,error:l}=await e.storage.from("profile-photos").upload(n,r,{cacheControl:"3600",upsert:!0});if(l)throw new Error(`Failed to upload profile photo: ${l.message}`);const{data:{publicUrl:o}}=e.storage.from("profile-photos").getPublicUrl(n);return o}catch(x){throw x}}(t,a);u(r),l(r)}catch(r){h(r.message||"Failed to upload photo"),u(s||null)}finally{m(!1)}})(n)},className:"hidden"}),r.jsxs("button",{onClick:()=>{var e;return null==(e=p.current)?void 0:e.click()},disabled:c,className:"flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white rounded-lg transition-colors font-medium",children:[c?r.jsx(n,{className:"w-4 h-4 animate-spin"}):r.jsx(i,{className:"w-4 h-4"}),g?"Change Photo":"Upload Photo"]})]}),x&&r.jsx("div",{className:"text-sm text-red-600 dark:text-red-400 text-center max-w-xs",children:x}),r.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center max-w-xs",children:["Recommended: Square image, max 5MB",r.jsx("br",{}),"Formats: JPEG, PNG, GIF, WebP"]})]})}function y(){const{user:d,refreshUser:i}=s(),y=t(),[w,j]=a.useState(d),[v,N]=a.useState(!1),[k,P]=a.useState(!1),[_,S]=a.useState(null),[I,E]=a.useState(null),[C,F]=a.useState((null==d?void 0:d.name)||""),[U,$]=a.useState((null==d?void 0:d.phone)||""),[A,G]=a.useState((null==d?void 0:d.studentId)||""),[q,z]=a.useState(!1),[D,B]=a.useState(""),[L,R]=a.useState(""),[M,W]=a.useState("");a.useEffect((()=>{J()}),[]);const J=async()=>{if(null==d?void 0:d.id){N(!0);try{const a=await async function(a){var r,t,s;try{const{data:n,error:d}=await e.from("users").select("\n        id,\n        email,\n        name,\n        phone,\n        student_id,\n        role,\n        created_at,\n        last_active,\n        avatar,\n        department_id,\n        batch_id,\n        section_id,\n        departments:department_id(name),\n        batches:batch_id(name),\n        sections:section_id(name)\n      ").eq("id",a).single();if(d)throw new Error(`Failed to fetch profile: ${d.message}`);return{id:n.id,email:n.email,name:n.name,phone:n.phone,studentId:n.student_id,role:n.role,createdAt:n.created_at,lastActive:n.last_active,avatar:n.avatar,departmentId:n.department_id,batchId:n.batch_id,sectionId:n.section_id,departmentName:null==(r=n.departments)?void 0:r.name,batchName:null==(t=n.batches)?void 0:t.name,sectionName:null==(s=n.sections)?void 0:s.name}}catch(_){throw _}}(d.id);j(a),F(a.name||""),$(a.phone||""),G(a.studentId||"")}catch(a){S(a.message)}finally{N(!1)}}};return w?r.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[r.jsx("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700",children:r.jsx("div",{className:"max-w-4xl mx-auto px-4 py-4",children:r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsx("button",{onClick:()=>y(-1),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors",children:r.jsx(l,{className:"w-5 h-5"})}),r.jsxs("div",{children:[r.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Profile Settings"}),r.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Manage your personal information and preferences"})]})]})})}),r.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[I&&r.jsx("div",{className:"mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-green-800 dark:text-green-200",children:I}),_&&r.jsx("div",{className:"mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-800 dark:text-red-200",children:_}),r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:[r.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-6",children:"Profile Photo"}),r.jsx(f,{userId:w.id,currentPhotoUrl:w.avatar,onPhotoUpdate:async e=>{if(null==w?void 0:w.id)try{await b(w.id,{avatar:e}),j({...w,avatar:e}),i&&await i(),E("Profile photo updated successfully"),setTimeout((()=>E(null)),3e3)}catch(a){S(a.message)}},userName:w.name})]}),r.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),null==w?void 0:w.id){P(!0),S(null),E(null);try{if(!C.trim())throw new Error("Name is required");const e=await b(w.id,{name:C.trim(),phone:U.trim()||void 0,studentId:A.trim()||void 0});j(e),i&&await i(),E("Profile updated successfully!"),setTimeout((()=>E(null)),3e3)}catch(a){S(a.message)}finally{P(!1)}}},className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:[r.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-6",children:"Personal Information"}),r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:[r.jsx(c,{className:"w-4 h-4"}),"Full Name *"]}),r.jsx("input",{type:"text",value:C,onChange:e=>F(e.target.value),required:!0,className:"w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white",placeholder:"Enter your full name"})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:[r.jsx(m,{className:"w-4 h-4"}),"Email Address"]}),r.jsx("input",{type:"email",value:w.email,disabled:!0,className:"w-full px-4 py-2.5 bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-500 dark:text-gray-400 cursor-not-allowed"}),r.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Email cannot be changed"})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:[r.jsx(g,{className:"w-4 h-4"}),"Phone Number"]}),r.jsx("input",{type:"tel",value:U,onChange:e=>$(e.target.value),className:"w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white",placeholder:"Enter your phone number"})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:[r.jsx(u,{className:"w-4 h-4"}),"Student ID"]}),r.jsx("input",{type:"text",value:A,onChange:e=>G(e.target.value),className:"w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white",placeholder:"Enter your student ID"})]}),r.jsx("button",{type:"submit",disabled:k,className:"w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white font-medium rounded-lg transition-colors",children:k?r.jsxs(r.Fragment,{children:[r.jsx(n,{className:"w-4 h-4 animate-spin"}),"Saving..."]}):r.jsxs(r.Fragment,{children:[r.jsx(x,{className:"w-4 h-4"}),"Save Changes"]})})]})]}),r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:[r.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center gap-2",children:[r.jsx(h,{className:"w-5 h-5"}),"Academic Information"]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Department"}),r.jsx("p",{className:"mt-1 text-gray-900 dark:text-white",children:w.departmentName||"Not assigned"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Batch"}),r.jsx("p",{className:"mt-1 text-gray-900 dark:text-white",children:w.batchName||"Not assigned"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Section"}),r.jsx("p",{className:"mt-1 text-gray-900 dark:text-white",children:w.sectionName||"Not assigned"})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 flex items-center gap-1",children:[r.jsx(p,{className:"w-4 h-4"}),"Role"]}),r.jsx("p",{className:"mt-1 text-gray-900 dark:text-white capitalize",children:w.role.replace("-"," ")})]})]}),r.jsx("p",{className:"mt-4 text-xs text-gray-500 dark:text-gray-400",children:"Contact your administrator to update academic information"})]}),r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:[r.jsxs("div",{className:"flex items-center justify-between mb-6",children:[r.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2",children:[r.jsx(o,{className:"w-5 h-5"}),"Password & Security"]}),!q&&r.jsx("button",{onClick:()=>z(!0),className:"text-sm text-blue-500 hover:text-blue-600 font-medium",children:"Change Password"})]}),q?r.jsxs("form",{onSubmit:async a=>{a.preventDefault(),S(null),E(null);try{if(!L||L.length<6)throw new Error("Password must be at least 6 characters");if(L!==M)throw new Error("Passwords do not match");P(!0),await async function(a){try{const{error:r}=await e.auth.updateUser({password:a});if(r)throw new Error(`Failed to change password: ${r.message}`)}catch(_){throw _}}(L),E("Password changed successfully!"),B(""),R(""),W(""),z(!1),setTimeout((()=>E(null)),3e3)}catch(r){S(r.message)}finally{P(!1)}},className:"space-y-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block",children:"New Password *"}),r.jsx("input",{type:"password",value:L,onChange:e=>R(e.target.value),required:!0,minLength:6,className:"w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white",placeholder:"Enter new password"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block",children:"Confirm New Password *"}),r.jsx("input",{type:"password",value:M,onChange:e=>W(e.target.value),required:!0,minLength:6,className:"w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white",placeholder:"Confirm new password"})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"submit",disabled:k,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white font-medium rounded-lg transition-colors",children:k?r.jsxs(r.Fragment,{children:[r.jsx(n,{className:"w-4 h-4 animate-spin"}),"Updating..."]}):"Update Password"}),r.jsx("button",{type:"button",onClick:()=>{z(!1),R(""),W("")},className:"px-4 py-2.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:"Cancel"})]}),r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Password must be at least 6 characters long"})]}):r.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Keep your account secure by using a strong password"})]})]})]})]}):r.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:r.jsx(n,{className:"w-8 h-8 text-blue-500 animate-spin"})})}export{y as ProfilePage};
