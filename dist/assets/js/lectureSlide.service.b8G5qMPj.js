import{s as e}from"./index.DHgWRtD1.js";const t=e=>{const t=e.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);if(t)return`https://www.youtube.com/embed/${t[1]}`;const i=e.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);return i?`https://drive.google.com/file/d/${i[1]}/preview`:null},i=e=>e.includes("youtube.com")||e.includes("youtu.be")?"youtube":e.includes("drive.google.com")?"google-drive":"other",r=e=>{try{return new URL(e),null!==t(e)}catch(i){return!1}},s=e=>{try{return new URL(e),!0}catch(t){return!1}},o=[".pdf",".ppt",".pptx",".doc",".docx",".txt",".rtf",".md",".xls",".xlsx",".jpg",".jpeg",".png",".gif",".svg"],n=e=>{const t=e.toLowerCase().substring(e.lastIndexOf("."));return o.includes(t)},a=e=>{switch(e.toLowerCase().substring(e.lastIndexOf("."))){case".pdf":return"ðŸ“„";case".ppt":case".pptx":return"ðŸ“Š";case".doc":case".docx":return"ðŸ“";case".xls":case".xlsx":return"ðŸ“ˆ";case".jpg":case".jpeg":case".png":case".gif":case".svg":return"ðŸ–¼ï¸";default:return"ðŸ“"}};async function l(t,i){try{const r=t.name.split(".").pop(),s=`${i}/${crypto.randomUUID()}.${r}`,{error:o}=await e.storage.from("lecture-slides").upload(s,t,{cacheControl:"3600",upsert:!1});if(o)throw o;const{data:{publicUrl:n}}=e.storage.from("lecture-slides").getPublicUrl(s);return{url:n,originalName:t.name}}catch(r){throw r}}async function d(t){try{const{data:{user:i}}=await e.auth.getUser();if(!i)return!1;const{data:r}=await e.from("users").select("role, section_id").eq("id",i.id).single();return!!r&&("super-admin"===r.role||"section_admin"===r.role&&r.section_id===t)}catch(i){return!1}}async function c(t){try{let i=e.from("lecture_slides").select("*").order("created_at",{ascending:!1});(null==t?void 0:t.sectionId)&&(i=i.eq("section_id",t.sectionId)),(null==t?void 0:t.createdBy)&&(i=i.eq("created_by",t.createdBy)),(null==t?void 0:t.dateFrom)&&(i=i.gte("created_at",t.dateFrom)),(null==t?void 0:t.dateTo)&&(i=i.lte("created_at",t.dateTo));const{data:r,error:s}=await i;if(s){if("PGRST106"===s.code||s.message.includes('relation "lecture_slides" does not exist'))return[];throw s}let o=(r||[]).map((e=>({id:e.id,title:e.title,description:e.description||"",sectionId:e.section_id,fileUrls:e.file_urls||[],originalFileNames:e.original_file_names||[],slideLinks:e.slide_links||[],videoLinks:e.video_links||[],createdAt:e.created_at,createdBy:e.created_by,updatedAt:e.updated_at,section:null,creator:null})));if(null==t?void 0:t.searchTerm){const e=t.searchTerm.toLowerCase();o=o.filter((t=>t.title.toLowerCase().includes(e)||t.description.toLowerCase().includes(e)))}return o}catch(i){throw i}}async function u(t,i=[]){try{if(!(await d(t.sectionId)))throw new Error("Permission denied: You cannot create lecture slides for this section");let r=[],s=[];if(i.length>0){const e=await Promise.all(i.map((e=>l(e,t.sectionId))));r=e.map((e=>e.url)),s=e.map((e=>e.originalName))}const o={title:t.title,description:t.description,section_id:t.sectionId,file_urls:[...t.fileUrls,...r],original_file_names:[...t.originalFileNames,...s],slide_links:t.slideLinks,video_links:t.videoLinks},{data:n,error:a}=await e.from("lecture_slides").insert(o).select("*").single();if(a){if("PGRST106"===a.code||a.message.includes('relation "lecture_slides" does not exist'))throw new Error("Lecture slides table does not exist. Please run the database migration first.");throw a}if(!n)throw new Error("No data returned from lecture slide creation");return{id:n.id,title:n.title,description:n.description||"",sectionId:n.section_id,fileUrls:n.file_urls||[],originalFileNames:n.original_file_names||[],slideLinks:n.slide_links||[],videoLinks:n.video_links||[],createdAt:n.created_at,createdBy:n.created_by,updatedAt:n.updated_at,section:null,creator:null}}catch(r){throw r}}async function m(t,i,r=[]){try{const{data:o}=await e.from("lecture_slides").select("section_id").eq("id",t).single();if(!o)throw new Error("Lecture slide not found");if(!(await d(o.section_id)))throw new Error("Permission denied: You cannot update this lecture slide");let n=[],a=[];if(r.length>0){const e=await Promise.all(r.map((e=>l(e,o.section_id))));n=e.map((e=>e.url)),a=e.map((e=>e.originalName))}const c={};void 0!==i.title&&(c.title=i.title),void 0!==i.description&&(c.description=i.description),void 0!==i.slideLinks&&(c.slide_links=i.slideLinks),void 0!==i.videoLinks&&(c.video_links=i.videoLinks),r.length>0?(c.file_urls=[...i.fileUrls||[],...n],c.original_file_names=[...i.originalFileNames||[],...a]):void 0!==i.fileUrls&&(c.file_urls=i.fileUrls,c.original_file_names=i.originalFileNames||[]);const{data:u,error:m}=await e.from("lecture_slides").update(c).eq("id",t).select("*").single();if(m)throw m;if(!u)throw new Error("No data returned from lecture slide update");return{id:(s=u).id,title:s.title,description:s.description||"",sectionId:s.section_id,fileUrls:s.file_urls||[],originalFileNames:s.original_file_names||[],slideLinks:s.slide_links||[],videoLinks:s.video_links||[],createdAt:s.created_at,createdBy:s.created_by,updatedAt:s.updated_at,section:s.section?{id:s.section.id,name:s.section.name,batch:s.section.batch?{id:s.section.batch.id,name:s.section.batch.name,department:s.section.batch.department?{id:s.section.batch.department.id,name:s.section.batch.department.name}:void 0}:void 0}:void 0,creator:s.creator?{id:s.creator.id,name:s.creator.name,email:s.creator.email}:void 0}}catch(o){throw o}var s}async function f(t){try{const{data:r}=await e.from("lecture_slides").select("section_id, file_urls").eq("id",t).single();if(!r)throw new Error("Lecture slide not found");if(!(await d(r.section_id)))throw new Error("Permission denied: You cannot delete this lecture slide");if(r.file_urls&&r.file_urls.length>0){const t=r.file_urls.map((e=>{const t=e.split("/"),i=t[t.length-1];return`${r.section_id}/${i}`}));try{await e.storage.from("lecture-slides").remove(t)}catch(i){}}const{error:s}=await e.from("lecture_slides").delete().eq("id",t);if(s)throw s}catch(r){throw r}}function _(e,t){const i=new URL(e);return i.searchParams.set("download",t),i.toString()}export{a,t as b,i as c,r as d,n as e,c as f,_ as g,u as h,s as i,f as j,m as u};
