const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/web.Chm7mU3K.js","assets/js/index.C6-aLomt.js","assets/css/index.JTvkVYmA.css"])))=>i.map(i=>d[i]);
import{s as p,C as b,d as V,_ as j,r as P,t as H}from"./index.C6-aLomt.js";import{c as B,d as A}from"./dataCache.CcjqYMC_.js";import{g as q}from"./authErrors.D8KAnYp0.js";const z="nesttask-auth-storage",G=1,O="auth";async function $(){return new Promise((t,a)=>{const l=indexedDB.open(z,G);l.onerror=()=>{console.error("Error opening IndexedDB:",l.error),a(l.error)},l.onupgradeneeded=n=>{const f=n.target.result;f.objectStoreNames.contains(O)||(f.createObjectStore(O),console.log("Created auth store in IndexedDB"))},l.onsuccess=()=>{const n=l.result;t(n)}})}async function M(t,a){try{const l=await $();return new Promise((n,f)=>{const u=l.transaction(O,"readwrite"),w=u.objectStore(O).put(a,t);w.onerror=()=>{console.error("Error storing in IndexedDB:",w.error),f(w.error)},w.onsuccess=()=>{n()},u.oncomplete=()=>{l.close()}})}catch(l){console.warn("Failed to store in IndexedDB:",l)}}async function Y({email:t,password:a}){var l,n,f,u,I,w;try{if(!t||!a)throw new Error("Email and password are required");console.log(`Attempting login for email: ${t}`);const m=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",_=["test@example.com","admin@example.com","demo@nesttask.com","test@nesttask.com","user@nesttask.com","superadmin@nesttask.com","admin@diu.edu.bd"];console.log("ðŸ“¡ Attempting Supabase authentication for:",t),await p.auth.setSession({access_token:"",refresh_token:""}),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",t);const{data:g,error:d}=await p.auth.signInWithPassword({email:t,password:a});if(d){console.error("Login error:",d);let S=q(d);throw d.message&&d.message.includes("Invalid login credentials")&&(S="Invalid email or password. Please try again."),d.message&&d.message.includes("fetch")&&(S="Network error. Please check your internet connection."),new Error(S)}if(!(g!=null&&g.user))throw new Error("No user data received");if(g.session){Z(g.session.refresh_token),localStorage.setItem("supabase.auth.token",JSON.stringify(g.session));try{await M("session",JSON.stringify(g.session)),await M("email",t),await M("remember_me",!0)}catch(S){console.warn("IndexedDB storage failed, falling back to localStorage only",S)}}await new Promise(S=>setTimeout(S,1e3));const{data:y,error:N}=await p.from("users").select().eq("id",g.user.id).maybeSingle();if(N){console.error("Error fetching user profile:",N);const S={id:g.user.id,email:g.user.email,name:((l=g.user.user_metadata)==null?void 0:l.name)||((n=g.user.email)==null?void 0:n.split("@")[0])||"",role:((f=g.user.user_metadata)==null?void 0:f.role)||"user",created_at:new Date().toISOString(),last_active:new Date().toISOString()},{data:E,error:R}=await p.from("users").insert(S).select().single();if(R)throw new Error("Failed to create user profile");if(!E)throw new Error("No profile data received after creation");return W(E)}if(!y){const S={id:g.user.id,email:g.user.email,name:((u=g.user.user_metadata)==null?void 0:u.name)||((I=g.user.email)==null?void 0:I.split("@")[0])||"",role:((w=g.user.user_metadata)==null?void 0:w.role)||"user",created_at:new Date().toISOString(),last_active:new Date().toISOString()},{data:E,error:R}=await p.from("users").insert(S).select().single();if(R)throw new Error("Failed to create user profile");if(!E)throw new Error("No profile data received after creation");return W(E)}return W(y)}catch(m){console.error("Login error:",m),m.message&&console.error("Error message:",m.message),m.code&&console.error("Error code:",m.code),m.status&&console.error("Error status:",m.status),m.details&&console.error("Error details:",m.details);let _=q(m);throw m.message&&m.message.includes("Invalid login credentials")&&(_="Invalid email or password. Please try again."),m.message&&m.message.includes("fetch")&&(_="Network error. Please check your internet connection."),new Error(_)}}async function Q({email:t,password:a,name:l,phone:n,studentId:f,departmentId:u,batchId:I,sectionId:w}){try{if(!t||!a||!l)throw new Error("All fields are required");if(!u||!I||!w)throw console.error("Missing required IDs:",{departmentId:u,batchId:I,sectionId:w}),new Error("Please select your department, batch, and section before signing up");if(!(t.endsWith("@diu.edu.bd")||t.includes("@gmail.com")||t.includes("@test.com")||t==="superadmin@nesttask.com"))throw new Error("Please use a valid email address (@diu.edu.bd, or test email)");console.log("Signup data:",{email:t,name:l,phone:n,studentId:f,departmentId:u,batchId:I,sectionId:w});const{data:_,error:g}=await p.auth.signUp({email:t,password:a,options:{emailRedirectTo:window.location.origin,data:{name:l,phone:n||"",studentId:f||"",role:"user",departmentId:u,batchId:I,sectionId:w}}});if(g)throw g;if(!(_!=null&&_.user))throw new Error("Failed to create user");console.log("User created in auth, session:",_.session?"Active":"Pending confirmation"),console.log("Relying on database trigger to create profile"),await new Promise(N=>setTimeout(N,2e3));const{data:d,error:y}=await p.from("users_with_full_info").select("*").eq("id",_.user.id).single();if(y){console.error("Error fetching user data after signup:",y);const{data:N,error:S}=await p.from("users").select("*").eq("id",_.user.id).single();return S?(console.error("Second attempt failed to fetch user data:",S),{id:_.user.id,email:t,name:l,phone:n,studentId:f,role:"user",createdAt:new Date().toISOString(),departmentId:u,batchId:I,sectionId:w}):W(N)}return{id:d.id,email:d.email,name:d.name,role:d.role,phone:d.phone,studentId:d.studentId,createdAt:d.createdAt,lastActive:d.lastActive,departmentId:d.departmentId,departmentName:d.departmentName,batchId:d.batchId,batchName:d.batchName,sectionId:d.sectionId,sectionName:d.sectionName}}catch(m){throw console.error("Signup error:",m),new Error(m.message||"Failed to create account")}}async function X(){try{const t=localStorage.getItem("nesttask_refresh_interval");t&&clearInterval(parseInt(t)),window.removeEventListener("focus",K);const a=p.auth.signOut({scope:"local"}).then(({error:n})=>{n&&console.error("Supabase signOut error:",n)}),l=$().then(n=>new Promise((f,u)=>{const m=n.transaction(O,"readwrite").objectStore(O).clear();m.onsuccess=()=>{n.close(),f()},m.onerror=()=>{n.close(),u(m.error)}})).catch(n=>{console.warn("Failed to clear IndexedDB:",n)});await Promise.all([a,l])}catch(t){console.error("Logout error:",t)}}async function K(){try{const{data:t}=await p.auth.getSession();t!=null&&t.session&&await p.auth.refreshSession({refresh_token:t.session.refresh_token})}catch(t){console.error("Failed to refresh token on focus:",t)}}function Z(t){const l=setInterval(async()=>{try{const{data:n}=await p.auth.getSession();if(n!=null&&n.session){const{data:f,error:u}=await p.auth.refreshSession({refresh_token:n.session.refresh_token});if(u){console.error("Error refreshing token:",u);return}f!=null&&f.session&&(localStorage.setItem("supabase.auth.token",JSON.stringify(f.session)),await M("session",JSON.stringify(f.session)))}}catch(n){console.error("Failed to refresh token:",n)}},432e5);localStorage.setItem("nesttask_refresh_interval",l.toString()),window.addEventListener("focus",K)}function U(t){switch(t){case"admin":return"admin";case"super-admin":case"super_admin":return"super-admin";case"section-admin":case"section_admin":return"section_admin";default:return"user"}}function W(t){return console.log("Mapping DB user to User:",t),{id:t.id,email:t.email,name:t.name||t.username||t.email.split("@")[0],role:U(t.role||"user"),avatar:t.avatar,phone:t.phone,createdAt:t.created_at||new Date().toISOString(),lastActive:t.last_active,studentId:t.student_id,departmentId:t.department_id,batchId:t.batch_id,sectionId:t.section_id}}async function ee(t){try{if(!t)throw new Error("Email is required");console.log("Sending password reset email to:",t);const{error:a}=await p.auth.resetPasswordForEmail(t,{redirectTo:`${window.location.origin}/#auth/recovery`});if(a)throw console.error("Supabase resetPasswordForEmail error:",a),a;console.log("Password reset email sent successfully")}catch(a){throw console.error("Password reset error:",a),new Error(q(a)||"Failed to send password reset email. Please try again.")}}function J(){if(b.isNativePlatform())return;const t=window.location.pathname.includes("super-admin")||sessionStorage.getItem("is_super_admin")==="true"||localStorage.getItem("is_super_admin")==="true";if(console.log("Cache cleanup called, isSuperAdmin:",t),t){console.log("Super admin detected - preserving state without cache clearing"),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PRESERVE_ADMIN_CACHES",timestamp:Date.now()});return}"caches"in window&&caches.keys().then(a=>{a.forEach(l=>{l.includes("nesttask")&&(console.log(`Clearing cache: ${l}`),caches.delete(l).then(n=>console.log(`Cache deleted: ${n}`)))})}),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(navigator.serviceWorker.controller.postMessage({type:"CLEAR_ALL_CACHES",timestamp:Date.now()}),navigator.serviceWorker.addEventListener("message",a=>{a.data&&a.data.type==="CACHES_CLEARED"&&console.log("Service worker cleared caches")},{once:!0}))}function F(t){b.isNativePlatform()||"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"AUTH_STATE_CHANGED",event:t?"SIGNED_IN":"SIGNED_OUT",timestamp:Date.now()})}const D=V("Network",{web:()=>j(()=>import("./web.Chm7mU3K.js"),__vite__mapDeps([0,1,2])).then(t=>new t.NetworkWeb)}),T="nesttask_remember_me",L="nesttask_saved_email";function ce(){const[t,a]=P.useState(null),[l,n]=P.useState(!0),[f,u]=P.useState(null),[I,w]=P.useState(null),[m,_]=P.useState(0),[g,d]=P.useState(!0);P.useEffect(()=>{let o=!0;const s=localStorage.getItem(L);s&&w(s);const c=localStorage.getItem("nesttask_cached_user");if(c&&o)try{const i=JSON.parse(c);a(i)}catch(i){console.error("Failed to parse cached user on mount:",i)}y();const{data:{subscription:r}}=p.auth.onAuthStateChange(N);return()=>{o=!1,r.unsubscribe()}},[]);const y=async()=>{try{let o=navigator.onLine;if(b.isNativePlatform())try{o=(await D.getStatus()).connected}catch(e){console.warn("Failed to get network status, using navigator.onLine")}if(!o){console.log("Offline mode: Loading cached user data");const e=localStorage.getItem("nesttask_cached_user");if(e)try{const h=JSON.parse(e);a(h),console.log("Successfully loaded cached user:",h.email),d(!1),n(!1);return}catch(h){console.error("Failed to parse cached user:",h)}console.log("No cached user found for offline mode"),d(!1),n(!1);return}if(!await H()){console.warn("Database connection test failed");const e=localStorage.getItem("nesttask_cached_user");if(e)try{const h=JSON.parse(e);a(h),console.log("Using cached user due to connection issues"),n(!1);return}catch(h){console.error("Failed to parse cached user:",h)}}const c=p.auth.getSession(),r=new Promise(e=>setTimeout(()=>e({data:{session:null},error:{message:"Session retrieval timed out"}}),8e3)),{data:{session:i},error:k}=await Promise.race([c,r]);if(k){k.message==="Session retrieval timed out"?console.warn("[useAuth] Session check timed out - assuming offline"):console.error("Error getting auth session:",k.message);const e=localStorage.getItem("nesttask_cached_user");if(e)try{const h=JSON.parse(e);a(h),console.log("Using cached user due to session error")}catch(h){console.error("Failed to parse cached user:",h)}n(!1);return}i!=null&&i.user?await E(i.user):(console.log("No active session found"),d(!1))}catch(o){console.error("Session check error:",o);let s=navigator.onLine;if(b.isNativePlatform())try{s=(await D.getStatus()).connected}catch(c){}if(s){if(u("Failed to check authentication status"),m<3){const c=Math.min(1e3*Math.pow(2,m),1e4);console.log(`Will retry session check in ${c}ms`),setTimeout(()=>{_(r=>r+1),y()},c);return}}else{console.log("Offline mode: Attempting to load cached user");const c=localStorage.getItem("nesttask_cached_user");if(c)try{const r=JSON.parse(c);a(r),console.log("Loaded cached user for offline use")}catch(r){console.error("Failed to parse cached user:",r)}}}finally{n(!1)}},N=async(o,s)=>{if(!(s!=null&&s.user)&&g){console.log("No session on initial load, checking if we should preserve cached user");let c=navigator.onLine;if(b.isNativePlatform())try{c=(await D.getStatus()).connected}catch(r){}if(!c&&t){console.log("Preserving cached user while offline"),d(!1),n(!1);return}}if(d(!1),s!=null&&s.user)try{await E(s.user)}catch(c){console.error("Error updating user state:",c);let r=navigator.onLine;if(b.isNativePlatform())try{r=(await D.getStatus()).connected}catch(i){}r?await S():console.log("Error updating user state while offline, keeping cached user")}else{let c=navigator.onLine;if(b.isNativePlatform())try{c=(await D.getStatus()).connected}catch(r){}c?(console.log("No session and online, clearing user"),a(null)):console.log("No session but offline, keeping cached user")}n(!1)},S=async()=>{a(null),F(!1),localStorage.removeItem("supabase.auth.token"),localStorage.removeItem("nesttask_user"),localStorage.removeItem("nesttask_cached_user"),sessionStorage.removeItem("supabase.auth.token"),localStorage.getItem(T)!=="true"&&localStorage.removeItem(L),document.cookie.split(";").forEach(function(o){document.cookie=o.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),J()},E=async o=>{var s,c,r;try{const i=B.userWithFullInfo(o.id),k=A.get(i);let e;if(k)e=k;else{const{data:C,error:x}=await p.from("users_with_full_info").select("*").eq("id",o.id).single();if(x)throw console.error("Error fetching user data:",x),x;e=C,A.set(i,e)}let h=(e==null?void 0:e.role)||((s=o.user_metadata)==null?void 0:s.role)||"user";(h==="super_admin"||h==="super-admin")&&(h="super-admin");const v={id:o.id,email:o.email,name:(e==null?void 0:e.name)||((c=o.user_metadata)==null?void 0:c.name)||((r=o.email)==null?void 0:r.split("@")[0])||"",role:h,createdAt:(e==null?void 0:e.createdAt)||o.created_at,avatar:e==null?void 0:e.avatar,phone:e==null?void 0:e.phone,studentId:e==null?void 0:e.studentId,departmentId:e==null?void 0:e.departmentId,batchId:e==null?void 0:e.batchId,sectionId:e==null?void 0:e.sectionId,departmentName:e==null?void 0:e.departmentName,batchName:e==null?void 0:e.batchName,sectionName:e==null?void 0:e.sectionName};a(v);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(v))}catch(C){console.warn("Failed to cache user data:",C)}}catch(i){throw console.error("Error updating user state:",i),i}};return{user:t,loading:l,error:f,login:async(o,s=!1)=>{try{if(u(null),s?(localStorage.setItem(T,"true"),localStorage.setItem(L,o.email)):(localStorage.removeItem(T),localStorage.removeItem(L)),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&localStorage.getItem("nesttask_demo_user"))try{const e=JSON.parse(localStorage.getItem("nesttask_demo_user")||"{}");if(e&&e.email===o.email)return console.log("Using cached demo user from localStorage:",e),a(e),F(!0),(e.role==="super-admin"||e.email==="superadmin@nesttask.com")&&(console.log("Demo super admin detected"),localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true")),e}catch(e){console.warn("Failed to parse demo user from localStorage")}const r=await Y(o);if(console.log("User after login:",r),F(!0),r.role==="super-admin"||o.email==="superadmin@nesttask.com"||r.email==="superadmin@nesttask.com"){console.log("Super admin login detected"),r.role="super-admin";const e=B.userWithFullInfo(r.id||r.email),h=A.get(e);if(h&&h.name)r.name=h.name;else try{const{data:v,error:C}=await p.from("users_with_full_info").select("*").eq("email",r.email).single();!C&&v&&(console.log("Super admin data from database:",v),v.name&&(r.name=v.name),A.set(e,v))}catch(v){console.warn("Error fetching super admin data, using default values",v)}localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true"),a(r);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(r)),console.log("Super-admin user cached after login for offline access")}catch(v){console.warn("Failed to cache super-admin user after login:",v)}return r}const{data:i,error:k}=await p.from("users").select("*").eq("id",r.id).single();k?console.error("Error fetching user data after login:",k):(console.log("User data from database after login:",i),i&&(i.role&&(r.role=i.role,console.log("Updated user role from database:",r.role)),i.department_id&&(r.departmentId=i.department_id,console.log("Updated user department ID:",r.departmentId)),i.batch_id&&(r.batchId=i.batch_id,console.log("Updated user batch ID:",r.batchId)),i.section_id&&(r.sectionId=i.section_id,console.log("Updated user section ID:",r.sectionId)),i.phone&&(r.phone=i.phone),i.student_id&&(r.studentId=i.student_id),i.avatar&&(r.avatar=i.avatar))),a(r);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(r)),console.log("User cached after login for offline access")}catch(e){console.warn("Failed to cache user after login:",e)}return J(),r}catch(c){throw u(c.message),c}},signup:async o=>{try{u(null),console.log("Starting signup process with credentials:",{...o,password:"[REDACTED]"}),o.departmentId&&console.log(`Department selected: ${o.departmentId}`),o.batchId&&console.log(`Batch selected: ${o.batchId}`),o.sectionId&&console.log(`Section selected: ${o.sectionId}`);const s=await Q(o);console.log("Signup successful, user data:",{id:s.id,email:s.email,name:s.name,role:s.role,departmentId:s.departmentId,batchId:s.batchId,sectionId:s.sectionId}),a(s);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(s)),localStorage.setItem("nesttask_user",JSON.stringify(s)),console.log("User cached after signup")}catch(c){console.warn("Failed to cache user after signup:",c)}return F(!0),s}catch(s){throw console.error("Signup error:",s),u(s.message),s}},logout:async()=>{try{console.log("Starting optimized logout..."),u(null),a(null),F(!1);const o=localStorage.getItem(T)==="true";A.clear();const s=["supabase.auth.token","nesttask_user","nesttask_cached_user","nesttask_refresh_interval","is_super_admin","auth_completed"];o||s.push(L),s.forEach(i=>localStorage.removeItem(i)),sessionStorage.removeItem("supabase.auth.token"),sessionStorage.removeItem("is_super_admin"),document.cookie.split(";").forEach(i=>{document.cookie=i.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")});const c=X(),r=J();return await Promise.all([c,r]),console.log("Logout completed"),!0}catch(o){return console.error("Logout error:",o),u(o.message),!1}},forgotPassword:async o=>{try{u(null),await ee(o)}catch(s){throw u(s.message),s}},savedEmail:I,refreshUser:async()=>{try{const{data:{session:o}}=await p.auth.getSession();if(o!=null&&o.user){const s=B.userWithFullInfo(o.user.id);A.clear(),await E(o.user)}}catch(o){console.error("Error refreshing user:",o)}}}}export{D as N,ce as u};
