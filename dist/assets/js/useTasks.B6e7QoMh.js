import{s as e,r as t,t as r}from"./index.DKgkbjjM.js";import{s as a}from"./telegram.service.BTr96-Tu.js";function n(e,t){let r=null,a=!1;return()=>{r&&clearTimeout(r),a||(r=setTimeout((async()=>{a=!0;try{await e()}finally{a=!1}}),t))}}function s(){const[r,a]=t.useState([]),[s,o]=t.useState(!0),[i,c]=t.useState(null),d=t.useRef(0),u=t.useRef(!1),l=t.useCallback((async(t=!1)=>{if(!u.current||t){if(t);else if(Date.now()-d.current<1e4)return;try{u.current=!0,o(!0),c(null);const t=await async function(){try{const{data:{user:t}}=await e.auth.getUser();if(!t)return[];const{data:r}=await e.from("users").select("role, section_id").eq("id",t.id).single();let a=e.from("users").select("\n        id, \n        email, \n        name, \n        role, \n        created_at, \n        last_active, \n        phone,\n        student_id,\n        section_id\n      ").order("created_at",{ascending:!1});"admin"!==(null==r?void 0:r.role)&&"super-admin"!==(null==r?void 0:r.role)&&(null==r?void 0:r.section_id)&&(a=a.eq("section_id",r.section_id));const{data:n,error:s}=await a;if(s)return[];const o=(null==n?void 0:n.filter((e=>e.section_id)).map((e=>e.section_id)))||[];let i={};if(o.length>0){const{data:t,error:r}=await e.from("sections").select("id, name").in("id",o);!r&&t&&(i=t.reduce(((e,t)=>(e[t.id]=t.name,e)),{}))}return(null==n?void 0:n.map((e=>{var t;return{id:e.id,email:e.email||"",name:e.name||(null==(t=e.email)?void 0:t.split("@")[0])||"",role:e.role||"user",createdAt:e.created_at,lastActive:e.last_active,phone:e.phone||"",studentId:e.student_id||"",sectionId:e.section_id||"",sectionName:e.section_id&&i[e.section_id]||""}})))||[]}catch(i){return[]}}();a(t),d.current=Date.now()}catch(r){c(r.message)}finally{o(!1),u.current=!1}}}),[]);t.useEffect((()=>{l(!0)}),[l]);const m=t.useRef();return t.useEffect((()=>{m.current=async()=>{try{const e=new Promise((e=>{const t=setTimeout((()=>e()),2e3),r=()=>{clearTimeout(t),window.removeEventListener("supabase-session-validated",r),e()};window.addEventListener("supabase-session-validated",r,{once:!0})}));window.dispatchEvent(new CustomEvent("request-session-validation")),await e,l(!0)}catch(e){l(!0)}}}),[l]),t.useEffect((()=>{const e=n((()=>{var e;null==(e=m.current)||e.call(m)}),1e3);return window.addEventListener("app-resume",e),window.addEventListener("supabase-session-refreshed",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-session-refreshed",e)}}),[]),{users:r,loading:s,error:i,refreshUsers:()=>l(!0),deleteUser:async t=>{try{c(null),await async function(t){try{const{data:{user:a}}=await e.auth.getUser();if(!a)throw new Error("Unauthorized: You must be logged in");const{data:n,error:s}=await e.from("users").select("role, section_id").eq("id",a.id).single();if(s||!n)throw new Error("Failed to get user role");const{data:o,error:i}=await e.from("users").select("section_id").eq("id",t).single();if(i)throw new Error("Failed to get target user information");if("section-admin"===(r=n.role)||"section_admin"===r){if(n.section_id!==(null==o?void 0:o.section_id))throw new Error("You can only delete users from your own section");const{error:r}=await e.rpc("delete_section_user",{user_id:t});if(r)throw new Error(r.message||"Failed to delete user")}else{if("admin"!==n.role&&"super-admin"!==n.role)throw new Error("Unauthorized: Only administrators can delete users");{const{error:r}=await e.from("users").delete().eq("id",t);if(r)throw new Error(r.message||"Failed to delete user")}}}catch(i){throw new Error(i.message||"Failed to delete user")}var r}(t),a((e=>e.filter((e=>e.id!==t))))}catch(r){throw c(r.message),await l(!0),r}},promoteUser:async(t,r)=>{try{c(null),await async function(t,r){try{const{data:{user:a}}=await e.auth.getUser();if(!a)throw new Error("Unauthorized: You must be logged in");const{data:n}=await e.from("users").select("role").eq("id",a.id).single();if("admin"!==(null==n?void 0:n.role)&&"super-admin"!==(null==n?void 0:n.role))throw new Error("Unauthorized: Only admins can promote users");const{error:s}=await e.from("users").update({role:r}).eq("id",t);if(s)throw new Error(s.message||"Failed to promote user")}catch(i){throw new Error(i.message||"Failed to promote user")}}(t,r),a((e=>e.map((e=>e.id===t?{...e,role:r}:e))))}catch(n){throw c(n.message),await l(!0),n}},demoteUser:async(t,r)=>{try{c(null),await async function(t,r){try{const{data:{user:a}}=await e.auth.getUser();if(!a)throw new Error("Unauthorized: You must be logged in");const{data:n}=await e.from("users").select("role").eq("id",a.id).single();if("admin"!==(null==n?void 0:n.role)&&"super-admin"!==(null==n?void 0:n.role))throw new Error("Unauthorized: Only admins can demote users");const{error:s}=await e.from("users").update({role:r}).eq("id",t);if(s)throw new Error(s.message||"Failed to demote user")}catch(i){throw new Error(i.message||"Failed to demote user")}}(t,r),a((e=>e.map((e=>e.id===t?{...e,role:r}:e))))}catch(n){throw c(n.message),await l(!0),n}}}}function o(e){return{id:e.id,name:e.name,category:e.category,dueDate:e.due_date,description:e.description,status:e.status,createdAt:e.created_at,isAdminTask:e.is_admin_task,sectionId:e.section_id||null,googleDriveLinks:e.google_drive_links||[],attachments:e.attachments||[]}}async function i(t){try{const r=t.name.split(".").pop(),a=`task-files/${crypto.randomUUID()}.${r}`,{error:n}=await e.storage.from("task-attachments").upload(a,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(n)throw n;const{data:{publicUrl:s}}=e.storage.from("task-attachments").getPublicUrl(a);return{url:s,originalName:t.name,path:a}}catch(r){throw r}}const c=new Map;function d(s){const[d,u]=t.useState([]),[l,m]=t.useState(!0),[w,f]=t.useState(null),[h,g]=t.useState(0),p=t.useRef(!1),y=t.useRef(0),v=t.useRef(!0),_=t.useRef(null),E=t.useRef(s),k=t.useRef(!1),b=t.useRef(!1),T=t.useRef(Date.now()),$=t.useRef(0);t.useEffect((()=>{E.current=s}),[s]),t.useEffect((()=>{const e=()=>{if("hidden"===document.visibilityState)b.current=!0,T.current=Date.now();else if("visible"===document.visibilityState){const e=Date.now()-T.current;T.current=Date.now(),p.current&&(p.current=!1,v.current&&m(!1)),e<3e4?(b.current=!0,setTimeout((()=>{b.current=!1}),1e3)):b.current=!1}};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}}),[]);const D=t.useCallback((async(t={})=>{if(!s)return;_.current&&_.current.abort(),_.current=new AbortController;const a=_.current.signal;if(t.force&&(c.delete(s),k.current=!0,p.current=!1,v.current&&g(0)),p.current&&!t.force)return;const n=Date.now(),i=k.current?1e3:3e3;if(t.force||!(n-y.current<i))try{const t=d.length>0,n=!b.current||!t;v.current&&n&&m(!0),p.current=!0,v.current&&f(null);let s=!0;{const{data:{user:t}}=await e.auth.getUser();if(s=await r(),!s)throw new Error("Unable to connect to database");const{data:a}=await e.auth.getSession();if(!a.session)throw new Error("Session expired - please refresh the page")}if(a.aborted)return;const i=async()=>{const t=await(async()=>{var t,r;try{const a=8e3,n=new AbortController,s=setTimeout((()=>n.abort()),a),{data:{user:i}}=await e.auth.getUser(),c=(null==(t=null==i?void 0:i.user_metadata)||t.role,null==(r=null==i?void 0:i.user_metadata)?void 0:r.section_id);let d=e.from("tasks").select("id,name,description,due_date,status,category,is_admin_task,user_id,section_id,created_at");d=d.order("created_at",{ascending:!1});const{data:u,error:l}=await d;if(clearTimeout(s),l)throw l;const m=u.map(o);return c&&m.filter((e=>e.sectionId===c)).length,m}catch(w){if("AbortError"===w.name)throw new Error("Task fetch timed out. Please try again.");throw new Error(`Failed to fetch tasks: ${w.message}`)}})();return t},c=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Task fetch timeout"))),45e3)})),l=await Promise.race([i(),c]);v.current&&!a.aborted&&(u(l),f(null),y.current=Date.now(),g(0),k.current=!1)}catch(l){if(v.current&&(!_.current||!_.current.signal.aborted)){"Task fetch timeout"===l.message?f("Failed to refresh: Task fetch timeout after 45s. Network may be slow or server overloaded."):f(l.message||"Failed to load tasks");const e="Task fetch timeout"===l.message?5:3;if(h<e){const e=Math.floor(1e3*Math.random()),t=Math.min(1e3*Math.pow(2,h)+e,15e3);setTimeout((()=>{v.current&&g((e=>e+1))}),t)}else h>=e&&(k.current=!0)}}finally{p.current=!1,v.current&&m(!1)}}),[s,h]);t.useEffect((()=>{const e=n((async()=>{const e=Date.now();if(!(e-$.current<3e3)&&($.current=e,E.current))try{const e=new Promise((e=>{const t=setTimeout((()=>{e()}),2e3),r=()=>{clearTimeout(t),window.removeEventListener("supabase-session-validated",r),e()};window.addEventListener("supabase-session-validated",r,{once:!0})}));window.dispatchEvent(new CustomEvent("request-session-validation")),await e,D({force:!0})}catch(t){D({force:!0})}}),1e3);return window.addEventListener("app-resume",e),window.addEventListener("supabase-session-refreshed",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-session-refreshed",e)}}),[D]),t.useEffect((()=>s?(v.current=!0,m(!0),D(),()=>{v.current=!1,_.current&&_.current.abort()}):(u([]),void m(!1))),[s,D]);const I=t.useCallback((async(e=!1)=>{try{return await D({force:e}),!0}catch(t){return!1}}),[D]);return{tasks:d,loading:l,error:w,createTask:async(t,r)=>{if(!s)throw new Error("User ID is required");p.current&&(p.current=!1);try{const n=await(async(t,r,n)=>{var s,c,d,u;try{const{data:{user:w}}=await e.auth.getUser(),v=null==(s=null==w?void 0:w.user_metadata)?void 0:s.role,_=null==(c=null==w?void 0:w.user_metadata)?void 0:c.section_id,E=r._mobileFiles,k=!!E&&E.length>0,b=!!r._isSectionAdminMobile;r._sectionId;let T=r.description;const $=[];let D=null,I=0;const U=async(t,r=6e4)=>new Promise((async(a,n)=>{const s=new AbortController,o=s.signal,i=setTimeout((()=>{s.abort(),n(new Error(`Upload timed out for file ${t.name} after ${r/1e3}s`))}),r);try{const r=async()=>{if(!t.name||0===t.size)throw new Error(`Invalid file: ${t.name||"unnamed"} (${t.size} bytes)`);if(t.size>26214400)throw new Error(`File too large: ${t.name} (${Math.round(t.size/1024/1024)}MB). Mobile file limit is 25MB.`);const r=t.name.split(".").pop(),a=`task-files/${crypto.randomUUID()}.${r}`,{error:n}=await e.storage.from("task-attachments").upload(a,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(n)throw n;const{data:{publicUrl:s}}=e.storage.from("task-attachments").getPublicUrl(a);return s},n=await r();clearTimeout(i),a(n)}catch(c){clearTimeout(i),o.aborted?n(new Error(`Upload timed out for file ${t.name}`)):n(c)}}));if(k&&E)try{const e=E.reduce(((e,t)=>e+t.size),0);if(e>104857600)throw new Error(`Total upload size too large: ${Math.round(e/1024/1024)}MB exceeds 100MB limit for mobile uploads`);for(const t of E)if(t.name&&0!==t.size)try{let e=null,r=0,a=null;for(;r<3&&!e;)try{r++;const a=Math.min(3e4+t.size/1024/10,6e4),n=await U(t,a);e={url:n,originalName:t.name,path:new URL(n).pathname.split("/").pop()||""},$.push(e),I+=t.size;break}catch(l){if(a=l instanceof Error?l:new Error(String(l)),r<3){const e=1e3*Math.pow(2,r-1);await new Promise((t=>setTimeout(t,e)))}}if(!e)throw D=a||new Error(`Failed to upload file after 3 attempts: ${t.name}`),D;const n=new RegExp(`\\[${t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\]\\(attachment:${t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`,"g"),s=`[${t.name}](${e.url})`,o=T;T=T.replace(n,s),o===T&&(T=T.replace(/\[(.*?)\]\(attachment:(.*?)\)/g,((r,a,n)=>a===t.name?`[${a}](${e.url})`:r)),o===T&&b&&(T.includes(`[${t.name}]`)||(T+=`\n[${t.name}](${e.url})`)))}catch(m){D||(D=m instanceof Error?m:new Error(String(m)));continue}if(D&&0===$.length)throw D;T=T.replace(/\n<!-- mobile-uploads -->\n/g,"")}catch(f){try{$&&$.length>0&&await Promise.allSettled($.map((async t=>{if(t.path)try{const{error:r}=await e.storage.from("task-attachments").remove([`task-files/${t.path}`])}catch(r){}})))}catch(h){}throw f}else{const e=T.match(/\[([^\]]+)\]\((blob:.*?)\)/g)||[];for(const t of e)try{const e=t.match(/\[(.*?)\]\((blob:(.*?))\)/);if(!e)continue;const[,r,a]=e;if(r&&a)try{const e=new Promise((async(e,t)=>{try{const r=await fetch(a);if(!r.ok)return void t(new Error(`Failed to fetch blob: ${r.status}`));e(await r.blob())}catch(r){t(r)}})),n=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Blob fetch timed out"))),1e4)})),s=await Promise.race([e,n]),o=new File([s],r,{type:s.type}),c=await i(o);$.push(c),T=T.replace(t,`[${r}](${c.url})`)}catch(g){}}catch(p){}}const F={name:r.name,category:r.category,due_date:r.dueDate,description:T,status:r.status,user_id:t,is_admin_task:"admin"===v||"section_admin"===v||"section-admin"===v||!1};let L,S;$.length>0&&(F.attachments=$.map((e=>e.url)),F.original_file_names=$.map((e=>e.name))),r.googleDriveLinks&&r.googleDriveLinks.length>0&&(F.google_drive_links=r.googleDriveLinks),"section_admin"!==v&&"section-admin"!==v||!_?n?F.section_id=n:_&&"user"===v&&(F.section_id=_):(F.section_id=_,T.includes("For section:")||T.includes("Section ID:")||(F.description+=`\n\nFor section: ${_}`));try{const t=await e.from("tasks").insert(F).select().single();L=t.data,S=t.error}catch(y){if(!(null==(d=y.message)?void 0:d.includes("google_drive_links"))&&!(null==(u=y.message)?void 0:u.includes("schema cache")))throw y;{const{google_drive_links:t,...r}=F,a=await e.from("tasks").insert(r).select().single();L=a.data,S=a.error}}if(S)throw new Error(`Failed to create task: ${S.message}`);if(!L)throw new Error("No data returned from task creation");const z=o(L);if(z.isAdminTask){try{await async function(e){try{const t="https://nglfbbdoyyfslzyjarqs.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbGZiYmRveXlmc2x6eWphcnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTgyMTQsImV4cCI6MjA4MzE3NDIxNH0.3sXujO3rtin57rTcHpXHi6Zfi9XJCEX3-mmcnnB8cJE",a=new Date(e.dueDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),n={taskId:e.id,title:"New Task",body:`${e.name} - Due: ${a}`,sectionId:e.sectionId||void 0,data:{category:e.category,priority:e.priority||"medium"}},s=await fetch(`${t}/functions/v1/send-fcm-push`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(n)});if(!s.ok){const e=await s.json().catch((()=>({})));throw new Error(`FCM push failed: ${JSON.stringify(e)}`)}await s.json()}catch(S){throw S}}(z)}catch(g){}await a(z)}return z}catch(w){throw new Error(`Task creation failed: ${w.message}`)}})(s,t,r);if(v.current&&(u((e=>[...e,n])),c.has(s))){const e=c.get(s);c.set(s,{tasks:[...e.tasks,n],timestamp:Date.now()})}return n}catch(n){throw n}},updateTask:async(t,r)=>{try{const a=await async function(t,r){var a,n;try{const o={};let i,c;void 0!==r.name&&(o.name=r.name),void 0!==r.category&&(o.category=r.category),void 0!==r.dueDate&&(o.due_date=r.dueDate),void 0!==r.description&&(o.description=r.description),void 0!==r.status&&(o.status=r.status),void 0!==r.sectionId&&(o.section_id=r.sectionId),void 0!==r.googleDriveLinks&&r.googleDriveLinks.length>0&&(o.google_drive_links=r.googleDriveLinks);try{const r=await e.from("tasks").update(o).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();i=r.data,c=r.error}catch(s){if(!(null==(a=s.message)?void 0:a.includes("google_drive_links"))&&!(null==(n=s.message)?void 0:n.includes("schema cache")))throw s;{const{google_drive_links:r,...a}=o,n=await e.from("tasks").update(a).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();i=n.data,c=n.error}}if(c)throw new Error("Failed to update task");if(!i)throw new Error("Task not found");return{id:i.id,name:i.name,category:i.category,dueDate:i.due_date,description:i.description,status:i.status,createdAt:i.created_at,isAdminTask:i.is_admin_task,sectionId:i.section_id}}catch(w){throw w}}(t,r);if(v.current&&(u((e=>e.map((e=>e.id===t?{...e,...a}:e)))),s&&c.has(s))){const e=c.get(s);c.set(s,{tasks:e.tasks.map((e=>e.id===t?{...e,...a}:e)),timestamp:Date.now()})}return a}catch(a){throw a}},deleteTask:async t=>{try{if(await async function(t){try{const{error:r}=await e.from("tasks").delete().eq("id",t);if(r)throw r}catch(w){throw new Error(w.message||"Failed to delete task")}}(t),v.current&&(u((e=>e.filter((e=>e.id!==t)))),s&&c.has(s))){const e=c.get(s);c.set(s,{tasks:e.tasks.filter((e=>e.id!==t)),timestamp:Date.now()})}return!0}catch(r){throw r}},refreshTasks:I}}export{d as a,s as u};
