import{s as f,r as d,j as e,u as L}from"./index.CLWRcQ38.js";import{u as R}from"./useAuth.CPwpnppD.js";import{L as N}from"./loader-2.BLXy3AUY.js";import{X as T}from"./x.DW-R0F77.js";import{U as q}from"./upload.DHAF8ls0.js";import{U as z}from"./user.DiCSScgz.js";import{M}from"./mail.CM0xZtNA.js";import{P as B}from"./phone.CtlUCkwr.js";import{C as J}from"./credit-card.DGjE-2TX.js";import{S as W}from"./save.BprRC_fg.js";import{G as K}from"./graduation-cap.DZ4dY2ZK.js";import{S as X}from"./shield.RKvnYdpD.js";import{L as H}from"./lock.BvE88Uxq.js";import"./dataCache.CcjqYMC_.js";import"./authErrors.D8KAnYp0.js";import"./createLucideIcon.BgXn53aF.js";async function O(a,r){try{if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, GIF, or WebP image.");const o=5*1024*1024;if(r.size>o)throw new Error("File size exceeds 5MB limit.");const s=r.name.split(".").pop(),i=`${a}/avatar-${Date.now()}.${s}`,{data:m}=await f.storage.from("profile-photos").list(a);if(m&&m.length>0){const g=m.map(p=>`${a}/${p.name}`);await f.storage.from("profile-photos").remove(g)}const{error:t}=await f.storage.from("profile-photos").upload(i,r,{cacheControl:"3600",upsert:!0});if(t)throw console.error("Upload error:",t),new Error(`Failed to upload profile photo: ${t.message}`);const{data:{publicUrl:u}}=f.storage.from("profile-photos").getPublicUrl(i);return u}catch(l){throw console.error("Error uploading profile photo:",l),l}}async function Q(a){try{const{data:r,error:l}=await f.storage.from("profile-photos").list(a);if(l)throw new Error(`Failed to list files: ${l.message}`);if(r&&r.length>0){const s=r.map(m=>`${a}/${m.name}`),{error:i}=await f.storage.from("profile-photos").remove(s);if(i)throw new Error(`Failed to delete files: ${i.message}`)}const{error:o}=await f.from("users").update({avatar:null}).eq("id",a);if(o)throw new Error(`Failed to update user record: ${o.message}`)}catch(r){throw console.error("Error deleting profile photo:",r),r}}async function I(a,r){try{const l={};r.name!==void 0&&(l.name=r.name),r.phone!==void 0&&(l.phone=r.phone),r.studentId!==void 0&&(l.student_id=r.studentId),r.avatar!==void 0&&(l.avatar=r.avatar);const{data:o,error:s}=await f.from("users").update(l).eq("id",a).select(`
        id,
        email,
        name,
        phone,
        student_id,
        role,
        created_at,
        last_active,
        avatar,
        department_id,
        batch_id,
        section_id
      `).single();if(s)throw console.error("Update error:",s),new Error(`Failed to update profile: ${s.message}`);return{id:o.id,email:o.email,name:o.name,phone:o.phone,studentId:o.student_id,role:o.role,createdAt:o.created_at,lastActive:o.last_active,avatar:o.avatar,departmentId:o.department_id,batchId:o.batch_id,sectionId:o.section_id}}catch(l){throw console.error("Error updating user profile:",l),l}}async function V(a){var r,l,o,s,i,m;try{const{data:t,error:u}=await f.from("users").select(`
        id,
        email,
        name,
        phone,
        student_id,
        role,
        created_at,
        last_active,
        avatar,
        department_id,
        batch_id,
        section_id,
        departments:department_id(name),
        batches:batch_id(name),
        sections:section_id(name)
      `).eq("id",a).single();if(u)throw new Error(`Failed to fetch profile: ${u.message}`);return{id:t.id,email:t.email,name:t.name,phone:t.phone,studentId:t.student_id,role:t.role,createdAt:t.created_at,lastActive:t.last_active,avatar:t.avatar,departmentId:t.department_id,batchId:t.batch_id,sectionId:t.section_id,departmentName:Array.isArray(t.departments)?(r=t.departments[0])==null?void 0:r.name:(l=t.departments)==null?void 0:l.name,batchName:Array.isArray(t.batches)?(o=t.batches[0])==null?void 0:o.name:(s=t.batches)==null?void 0:s.name,sectionName:Array.isArray(t.sections)?(i=t.sections[0])==null?void 0:i.name:(m=t.sections)==null?void 0:m.name}}catch(t){throw console.error("Error fetching user profile:",t),t}}async function Y(a){try{const{error:r}=await f.auth.updateUser({password:a});if(r)throw new Error(`Failed to change password: ${r.message}`)}catch(r){throw console.error("Error changing password:",r),r}}function Z({userId:a,currentPhotoUrl:r,onPhotoUpdate:l,userName:o}){const[s,i]=d.useState(!1),[m,t]=d.useState(r||null),[u,g]=d.useState(null),p=d.useRef(null),k=x=>{var v;const c=(v=x.target.files)==null?void 0:v[0];if(!c)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(c.type)){g("Please upload a valid image file (JPEG, PNG, GIF, or WebP)");return}if(c.size>5*1024*1024){g("File size must be less than 5MB");return}g(null);const y=new FileReader;y.onloadend=()=>{t(y.result)},y.readAsDataURL(c),h(c)},h=async x=>{i(!0),g(null);try{const c=await O(a,x);t(c),l(c)}catch(c){console.error("Upload failed:",c),g(c.message||"Failed to upload photo"),t(r||null)}finally{i(!1)}},w=async()=>{if(confirm("Are you sure you want to remove your profile photo?")){i(!0),g(null);try{await Q(a),t(null),l(null)}catch(x){console.error("Delete failed:",x),g(x.message||"Failed to delete photo")}finally{i(!1)}}},P=(o==null?void 0:o.charAt(0).toUpperCase())||"?";return e.jsxs("div",{className:"flex flex-col items-center gap-4 sm:gap-5",children:[e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"w-28 h-28 sm:w-32 sm:h-32 rounded-full overflow-hidden ring-4 ring-blue-100 dark:ring-blue-900/30 bg-gradient-to-br from-blue-500 to-indigo-600 shadow-md",children:m?e.jsx("img",{src:m,alt:o,className:"w-full h-full object-cover transition-transform group-hover:scale-105 duration-300"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-white text-4xl sm:text-5xl font-bold select-none",children:P})}),s&&e.jsx("div",{className:"absolute inset-0 bg-black/50 rounded-full flex items-center justify-center z-10",children:e.jsx(N,{className:"w-8 h-8 text-white animate-spin"})}),m&&!s&&e.jsx("button",{onClick:w,className:"absolute top-0 right-0 p-2 sm:p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-all hover:scale-110 touch-manipulation focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800",title:"Remove photo","aria-label":"Remove photo",children:e.jsx(T,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 w-full sm:w-auto px-4 sm:px-0",children:[e.jsx("input",{ref:p,type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:k,className:"hidden"}),e.jsxs("button",{onClick:()=>{var x;return(x=p.current)==null?void 0:x.click()},disabled:s,className:"w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-2.5 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white rounded-lg transition-colors font-medium touch-manipulation shadow-sm text-sm sm:text-base",children:[s?e.jsx(N,{className:"w-4 h-4 animate-spin"}):e.jsx(q,{className:"w-4 h-4 sm:w-5 sm:h-5"}),m?"Change Photo":"Upload Photo"]})]}),u&&e.jsx("div",{className:"text-sm text-red-600 dark:text-red-400 text-center max-w-xs animate-fade-in px-4",children:u}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center max-w-xs px-4",children:["Recommended: Square image, max 5MB",e.jsx("br",{}),"Formats: JPEG, PNG, GIF, WebP"]})]})}function he(){const{user:a,refreshUser:r,loading:l}=R(),o=L(),[s,i]=d.useState(a),[,m]=d.useState(!1),[t,u]=d.useState(!1),[g,p]=d.useState(null),[k,h]=d.useState(null),[w,P]=d.useState((a==null?void 0:a.name)||""),[x,c]=d.useState((a==null?void 0:a.phone)||""),[S,y]=d.useState((a==null?void 0:a.studentId)||""),[v,E]=d.useState(!1),[,U]=d.useState(""),[j,_]=d.useState(""),[F,C]=d.useState("");d.useEffect(()=>{!l&&!a&&o("/auth")},[a,l,o]),d.useEffect(()=>{a&&A()},[a]);const A=async()=>{if(a!=null&&a.id){m(!0);try{const n=await V(a.id);i(n),P(n.name||""),c(n.phone||""),y(n.studentId||"")}catch(n){console.error("Failed to load profile:",n),p(n.message)}finally{m(!1)}}},$=async n=>{if(s!=null&&s.id)try{await I(s.id,{avatar:n}),i({...s,avatar:n||void 0}),r&&await r(),h("Profile photo updated successfully"),setTimeout(()=>h(null),3e3)}catch(b){p(b.message)}},D=async n=>{if(n.preventDefault(),!!(s!=null&&s.id)){u(!0),p(null),h(null);try{if(!w.trim())throw new Error("Name is required");const b=await I(s.id,{name:w.trim(),phone:x.trim()||void 0,studentId:S.trim()||void 0});i(b),r&&await r(),h("Profile updated successfully!"),setTimeout(()=>h(null),3e3)}catch(b){console.error("Failed to update profile:",b),p(b.message)}finally{u(!1)}}},G=async n=>{n.preventDefault(),p(null),h(null);try{if(!j||j.length<6)throw new Error("Password must be at least 6 characters");if(j!==F)throw new Error("Passwords do not match");u(!0),await Y(j),h("Password changed successfully!"),U(""),_(""),C(""),E(!1),setTimeout(()=>h(null),3e3)}catch(b){console.error("Failed to change password:",b),p(b.message)}finally{u(!1)}};return l||!s&&a?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsx(N,{className:"w-8 h-8 text-blue-500 animate-spin"})}):s?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 pb-20 md:pb-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6 sm:py-8 space-y-6 safe-area-bottom",children:[k&&e.jsx("div",{className:"p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-green-800 dark:text-green-200 text-sm sm:text-base animate-fade-in",children:k}),g&&e.jsx("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-800 dark:text-red-200 text-sm sm:text-base animate-fade-in",children:g}),e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[e.jsx("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4 sm:mb-6",children:"Profile Photo"}),e.jsx(Z,{userId:s.id,currentPhotoUrl:s.avatar,onPhotoUpdate:$,userName:s.name})]}),e.jsxs("form",{onSubmit:D,className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[e.jsx("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4 sm:mb-6",children:"Personal Information"}),e.jsxs("div",{className:"space-y-4 sm:space-y-5",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2",children:[e.jsx(z,{className:"w-4 h-4"}),"Full Name *"]}),e.jsx("input",{type:"text",value:w,onChange:n=>P(n.target.value),required:!0,className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Enter your full name"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2",children:[e.jsx(M,{className:"w-4 h-4"}),"Email Address"]}),e.jsx("input",{type:"email",value:s.email,disabled:!0,className:"w-full px-3 sm:px-4 py-2.5 bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-500 dark:text-gray-400 cursor-not-allowed text-sm sm:text-base"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Email cannot be changed"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2",children:[e.jsx(B,{className:"w-4 h-4"}),"Phone Number"]}),e.jsx("input",{type:"tel",value:x,onChange:n=>c(n.target.value),className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Enter your phone number"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2",children:[e.jsx(J,{className:"w-4 h-4"}),"Student ID"]}),e.jsx("input",{type:"text",value:S,onChange:n=>y(n.target.value),className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Enter your student ID"})]}),e.jsx("button",{type:"submit",disabled:t,className:"w-full sm:w-auto mt-2 flex items-center justify-center gap-2 px-6 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white font-medium rounded-lg transition-colors touch-manipulation shadow-sm text-sm sm:text-base",children:t?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"w-4 h-4 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"w-4 h-4"}),"Save Changes"]})})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[e.jsxs("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4 sm:mb-6 flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5"}),"Academic Information"]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 block mb-1",children:"Department"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-900 dark:text-white font-medium break-words",children:s.departmentName||"Not assigned"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 block mb-1",children:"Batch"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-900 dark:text-white font-medium break-words",children:s.batchName||"Not assigned"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 block mb-1",children:"Section"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-900 dark:text-white font-medium break-words",children:s.sectionName||"Not assigned"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 block mb-1 flex items-center gap-1",children:[e.jsx(X,{className:"w-3.5 h-3.5"}),"Role"]}),e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 capitalize",children:s.role.replace("-"," ")})]})]}),e.jsx("p",{className:"mt-4 sm:mt-6 text-xs text-gray-500 dark:text-gray-400",children:"Contact your administrator to update academic information"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4 sm:mb-6",children:[e.jsxs("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2",children:[e.jsx(H,{className:"w-5 h-5"}),"Password & Security"]}),!v&&e.jsx("button",{onClick:()=>E(!0),className:"text-sm text-blue-500 hover:text-blue-600 font-medium self-start sm:self-auto px-3 py-1.5 -ml-3 sm:ml-0 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors",children:"Change Password"})]}),v?e.jsxs("form",{onSubmit:G,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2 block",children:"New Password *"}),e.jsx("input",{type:"password",value:j,onChange:n=>_(n.target.value),required:!0,minLength:6,className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Enter new password"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2 block",children:"Confirm New Password *"}),e.jsx("input",{type:"password",value:F,onChange:n=>C(n.target.value),required:!0,minLength:6,className:"w-full px-3 sm:px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors text-gray-900 dark:text-white text-sm sm:text-base",placeholder:"Confirm new password"})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:()=>{E(!1),_(""),C("")},className:"w-full sm:w-auto px-4 py-2.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm sm:text-base font-medium",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:t,className:"w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-2.5 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white font-medium rounded-lg transition-colors touch-manipulation shadow-sm text-sm sm:text-base",children:t?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"w-4 h-4 animate-spin"}),"Updating..."]}):"Update Password"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:"Password must be at least 6 characters long"})]}):e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Keep your account secure by using a strong password"})]})]})]})}):null}export{he as ProfilePage};
