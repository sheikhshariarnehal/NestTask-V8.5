const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/web.CZhzXTXE.js","assets/js/index.B83KeBCs.js","assets/css/index.JTvkVYmA.css"])))=>i.map(i=>d[i]);
import{s as e,C as t,d as a,_ as r,r as s,t as o}from"./index.B83KeBCs.js";import{c as n,d as i}from"./dataCache.yGM8Zd45.js";import{g as c}from"./authErrors.BDay5vyW.js";const l="auth";async function d(){return new Promise(((e,t)=>{const a=indexedDB.open("nesttask-auth-storage",1);a.onerror=()=>{t(a.error)},a.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(l)||t.createObjectStore(l)},a.onsuccess=()=>{const t=a.result;e(t)}}))}async function u(e,t){try{const a=await d();return new Promise(((r,s)=>{const o=a.transaction(l,"readwrite"),n=o.objectStore(l).put(t,e);n.onerror=()=>{s(n.error)},n.onsuccess=()=>{r()},o.oncomplete=()=>{a.close()}}))}catch(a){}}async function m(){try{const{data:t}=await e.auth.getSession();(null==t?void 0:t.session)&&await e.auth.refreshSession({refresh_token:t.session.refresh_token})}catch(t){}}function h(e){switch(e){case"admin":return"admin";case"super-admin":case"super_admin":return"super-admin";case"section-admin":case"section_admin":return"section_admin";default:return"user"}}function g(e){return{id:e.id,email:e.email,name:e.name||e.username||e.email.split("@")[0],role:h(e.role||"user"),avatar:e.avatar,phone:e.phone,createdAt:e.created_at||(new Date).toISOString(),lastActive:e.last_active,studentId:e.student_id,departmentId:e.department_id,batchId:e.batch_id,sectionId:e.section_id}}function w(){t.isNativePlatform()||(window.location.pathname.includes("super-admin")||"true"===sessionStorage.getItem("is_super_admin")||"true"===localStorage.getItem("is_super_admin")?"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PRESERVE_ADMIN_CACHES",timestamp:Date.now()}):("caches"in window&&caches.keys().then((e=>{e.forEach((e=>{e.includes("nesttask")&&caches.delete(e).then((e=>{}))}))})),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(navigator.serviceWorker.controller.postMessage({type:"CLEAR_ALL_CACHES",timestamp:Date.now()}),navigator.serviceWorker.addEventListener("message",(e=>{e.data&&e.data.type}),{once:!0}))))}function f(e){t.isNativePlatform()||"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"AUTH_STATE_CHANGED",event:e?"SIGNED_IN":"SIGNED_OUT",timestamp:Date.now()})}const p=a("Network",{web:()=>r((()=>import("./web.CZhzXTXE.js")),__vite__mapDeps([0,1,2])).then((e=>new e.NetworkWeb))}),_="nesttask_remember_me",v="nesttask_saved_email";function I(){const[a,r]=s.useState(null),[h,I]=s.useState(!0),[S,y]=s.useState(null),[k,N]=s.useState(null),[b,E]=s.useState(0),[P,O]=s.useState(!0);s.useEffect((()=>{let t=!0;const a=localStorage.getItem(v);a&&N(a);const s=localStorage.getItem("nesttask_cached_user");if(s&&t)try{const e=JSON.parse(s);r(e)}catch(n){}A();const{data:{subscription:o}}=e.auth.onAuthStateChange(D);return()=>{t=!1,o.unsubscribe()}}),[]);const A=async()=>{try{let s=navigator.onLine;if(t.isNativePlatform())try{s=(await p.getStatus()).connected}catch(a){}if(!s){const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);return r(t),O(!1),void I(!1)}catch(a){}return O(!1),void I(!1)}if(!(await o())){const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);return r(t),void I(!1)}catch(a){}}const{data:{session:n},error:i}=await e.auth.getSession();if(i){const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);r(t)}catch(a){}return void I(!1)}(null==n?void 0:n.user)?await J(n.user):O(!1)}catch(a){let e=navigator.onLine;if(t.isNativePlatform())try{e=(await p.getStatus()).connected}catch(s){}if(e){if(y("Failed to check authentication status"),b<3){const e=Math.min(1e3*Math.pow(2,b),1e4);return void setTimeout((()=>{E((e=>e+1)),A()}),e)}}else{const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);r(t)}catch(n){}}}finally{I(!1)}},D=async(e,s)=>{if(!(null==s?void 0:s.user)&&P){let e=navigator.onLine;if(t.isNativePlatform())try{e=(await p.getStatus()).connected}catch(o){}if(!e&&a)return O(!1),void I(!1)}if(O(!1),null==s?void 0:s.user)try{await J(s.user)}catch(n){let e=navigator.onLine;if(t.isNativePlatform())try{e=(await p.getStatus()).connected}catch(o){}e&&await W()}else{let e=navigator.onLine;if(t.isNativePlatform())try{e=(await p.getStatus()).connected}catch(o){}e&&r(null)}I(!1)},W=async()=>{r(null),f(!1),localStorage.removeItem("supabase.auth.token"),localStorage.removeItem("nesttask_user"),localStorage.removeItem("nesttask_cached_user"),sessionStorage.removeItem("supabase.auth.token"),"true"!==localStorage.getItem(_)&&localStorage.removeItem(v),document.cookie.split(";").forEach((function(e){document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")})),w()},J=async t=>{var a,s,o;try{const l=n.userWithFullInfo(t.id),d=i.get(l);let u;if(d)u=d;else{const{data:a,error:r}=await e.from("users_with_full_info").select("*").eq("id",t.id).single();if(r)throw r;u=a,i.set(l,u)}let m=(null==u?void 0:u.role)||(null==(a=t.user_metadata)?void 0:a.role)||"user";"super_admin"!==m&&"super-admin"!==m||(m="super-admin");const h={id:t.id,email:t.email,name:(null==u?void 0:u.name)||(null==(s=t.user_metadata)?void 0:s.name)||(null==(o=t.email)?void 0:o.split("@")[0])||"",role:m,createdAt:(null==u?void 0:u.createdAt)||t.created_at,avatar:null==u?void 0:u.avatar,phone:null==u?void 0:u.phone,studentId:null==u?void 0:u.studentId,departmentId:null==u?void 0:u.departmentId,batchId:null==u?void 0:u.batchId,sectionId:null==u?void 0:u.sectionId,departmentName:null==u?void 0:u.departmentName,batchName:null==u?void 0:u.batchName,sectionName:null==u?void 0:u.sectionName};r(h);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(h))}catch(c){}}catch(c){throw c}};return{user:a,loading:h,error:S,login:async(t,a=!1)=>{try{if(y(null),a?(localStorage.setItem(_,"true"),localStorage.setItem(v,t.email)):(localStorage.removeItem(_),localStorage.removeItem(v)),("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname)&&localStorage.getItem("nesttask_demo_user"))try{const e=JSON.parse(localStorage.getItem("nesttask_demo_user")||"{}");if(e&&e.email===t.email)return r(e),f(!0),"super-admin"!==e.role&&"superadmin@nesttask.com"!==e.email||(localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true")),e}catch(s){}const l=await async function({email:t,password:a}){var r,o,n,i,l,d;try{if(!t||!a)throw new Error("Email and password are required");"localhost"===window.location.hostname||window.location.hostname,await e.auth.setSession({access_token:"",refresh_token:""}),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",t);const{data:w,error:f}=await e.auth.signInWithPassword({email:t,password:a});if(f){let e=c(f);throw f.message&&f.message.includes("Invalid login credentials")&&(e="Invalid email or password. Please try again."),f.message&&f.message.includes("fetch")&&(e="Network error. Please check your internet connection."),new Error(e)}if(!(null==w?void 0:w.user))throw new Error("No user data received");if(w.session){!function(){const t=setInterval((async()=>{try{const{data:t}=await e.auth.getSession();if(null==t?void 0:t.session){const{data:a,error:r}=await e.auth.refreshSession({refresh_token:t.session.refresh_token});if(r)return;(null==a?void 0:a.session)&&(localStorage.setItem("supabase.auth.token",JSON.stringify(a.session)),await u("session",JSON.stringify(a.session)))}}catch(s){}}),432e5);localStorage.setItem("nesttask_refresh_interval",t.toString()),window.addEventListener("focus",m)}(w.session.refresh_token),localStorage.setItem("supabase.auth.token",JSON.stringify(w.session));try{await u("session",JSON.stringify(w.session)),await u("email",t),await u("remember_me",!0)}catch(h){}}await new Promise((e=>setTimeout(e,1e3)));const{data:p,error:_}=await e.from("users").select().eq("id",w.user.id).maybeSingle();if(_){const t={id:w.user.id,email:w.user.email,name:(null==(r=w.user.user_metadata)?void 0:r.name)||(null==(o=w.user.email)?void 0:o.split("@")[0])||"",role:(null==(n=w.user.user_metadata)?void 0:n.role)||"user",created_at:(new Date).toISOString(),last_active:(new Date).toISOString()},{data:a,error:s}=await e.from("users").insert(t).select().single();if(s)throw new Error("Failed to create user profile");if(!a)throw new Error("No profile data received after creation");return g(a)}if(!p){const t={id:w.user.id,email:w.user.email,name:(null==(i=w.user.user_metadata)?void 0:i.name)||(null==(l=w.user.email)?void 0:l.split("@")[0])||"",role:(null==(d=w.user.user_metadata)?void 0:d.role)||"user",created_at:(new Date).toISOString(),last_active:(new Date).toISOString()},{data:a,error:r}=await e.from("users").insert(t).select().single();if(r)throw new Error("Failed to create user profile");if(!a)throw new Error("No profile data received after creation");return g(a)}return g(p)}catch(S){S.message,S.code,S.status,S.details;let t=c(S);throw S.message&&S.message.includes("Invalid login credentials")&&(t="Invalid email or password. Please try again."),S.message&&S.message.includes("fetch")&&(t="Network error. Please check your internet connection."),new Error(t)}}(t);if(f(!0),"super-admin"===l.role||"superadmin@nesttask.com"===t.email||"superadmin@nesttask.com"===l.email){l.role="super-admin";const t=n.userWithFullInfo(l.id||l.email),a=i.get(t);if(a&&a.name)l.name=a.name;else try{const{data:a,error:r}=await e.from("users_with_full_info").select("*").eq("email",l.email).single();!r&&a&&(a.name&&(l.name=a.name),i.set(t,a))}catch(s){}localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true"),r(l);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(l))}catch(o){}return l}const{data:d,error:h}=await e.from("users").select("*").eq("id",l.id).single();h||d&&(d.role&&(l.role=d.role),d.department_id&&(l.departmentId=d.department_id),d.batch_id&&(l.batchId=d.batch_id),d.section_id&&(l.sectionId=d.section_id),d.phone&&(l.phone=d.phone),d.student_id&&(l.studentId=d.student_id),d.avatar&&(l.avatar=d.avatar)),r(l);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(l))}catch(o){}return w(),l}catch(s){throw y(s.message),s}},signup:async t=>{try{y(null),t.departmentId,t.batchId,t.sectionId;const s=await async function({email:t,password:a,name:r,phone:s,studentId:o,departmentId:n,batchId:i,sectionId:c}){try{if(!t||!a||!r)throw new Error("All fields are required");if(!n||!i||!c)throw new Error("Please select your department, batch, and section before signing up");if(!(t.endsWith("@diu.edu.bd")||t.includes("@gmail.com")||t.includes("@test.com")||"superadmin@nesttask.com"===t))throw new Error("Please use a valid email address (@diu.edu.bd, or test email)");const{data:l,error:d}=await e.auth.signUp({email:t,password:a,options:{emailRedirectTo:window.location.origin,data:{name:r,phone:s||"",studentId:o||"",role:"user",departmentId:n,batchId:i,sectionId:c}}});if(d)throw d;if(!(null==l?void 0:l.user))throw new Error("Failed to create user");await new Promise((e=>setTimeout(e,2e3)));const{data:u,error:m}=await e.from("users_with_full_info").select("*").eq("id",l.user.id).single();if(m){const{data:a,error:d}=await e.from("users").select("*").eq("id",l.user.id).single();return d?{id:l.user.id,email:t,name:r,phone:s,studentId:o,role:"user",createdAt:(new Date).toISOString(),departmentId:n,batchId:i,sectionId:c}:g(a)}return{id:u.id,email:u.email,name:u.name,role:u.role,phone:u.phone,studentId:u.studentId,createdAt:u.createdAt,lastActive:u.lastActive,departmentId:u.departmentId,departmentName:u.departmentName,batchId:u.batchId,batchName:u.batchName,sectionId:u.sectionId,sectionName:u.sectionName}}catch(S){throw new Error(S.message||"Failed to create account")}}(t);r(s);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(s)),localStorage.setItem("nesttask_user",JSON.stringify(s))}catch(a){}return f(!0),s}catch(s){throw y(s.message),s}},logout:async()=>{try{y(null),r(null),f(!1);const t="true"===localStorage.getItem(_);i.clear();const a=["supabase.auth.token","nesttask_user","nesttask_cached_user","nesttask_refresh_interval","is_super_admin","auth_completed"];t||a.push(v),a.forEach((e=>localStorage.removeItem(e))),sessionStorage.removeItem("supabase.auth.token"),sessionStorage.removeItem("is_super_admin"),document.cookie.split(";").forEach((e=>{document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")}));const s=async function(){try{const t=localStorage.getItem("nesttask_refresh_interval");t&&clearInterval(parseInt(t)),window.removeEventListener("focus",m);const a=e.auth.signOut({scope:"local"}).then((({error:e})=>{})),r=d().then((e=>new Promise(((t,a)=>{const r=e.transaction(l,"readwrite").objectStore(l).clear();r.onsuccess=()=>{e.close(),t()},r.onerror=()=>{e.close(),a(r.error)}})))).catch((e=>{}));await Promise.all([a,r])}catch(S){}}(),o=w();return await Promise.all([s,o]),!0}catch(t){return y(t.message),!1}},forgotPassword:async t=>{try{y(null),await async function(t){try{if(!t)throw new Error("Email is required");const{error:a}=await e.auth.resetPasswordForEmail(t,{redirectTo:`${window.location.origin}/#auth/recovery`});if(a)throw a}catch(S){throw new Error(c(S)||"Failed to send password reset email. Please try again.")}}(t)}catch(a){throw y(a.message),a}},savedEmail:k,refreshUser:async()=>{try{const{data:{session:t}}=await e.auth.getSession();(null==t?void 0:t.user)&&(n.userWithFullInfo(t.user.id),i.clear(),await J(t.user))}catch(t){}}}}export{p as N,I as u};
