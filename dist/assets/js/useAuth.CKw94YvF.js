const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/web.ZC7oJB9d.js","assets/js/index.Cm-yHY8f.js","assets/css/index.CYisyyCB.css"])))=>i.map(i=>d[i]);
import{s as e,C as t,c as o,_ as r,r as a,t as s}from"./index.Cm-yHY8f.js";import{c as n,d as i}from"./dataCache.jSzv44up.js";import{g as c}from"./authErrors.BDay5vyW.js";const l="auth";async function d(){return new Promise(((e,t)=>{const o=indexedDB.open("nesttask-auth-storage",1);o.onerror=()=>{console.error("Error opening IndexedDB:",o.error),t(o.error)},o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(l)||(t.createObjectStore(l),console.log("Created auth store in IndexedDB"))},o.onsuccess=()=>{const t=o.result;e(t)}}))}async function u(e,t){try{const o=await d();return new Promise(((r,a)=>{const s=o.transaction(l,"readwrite"),n=s.objectStore(l).put(t,e);n.onerror=()=>{console.error("Error storing in IndexedDB:",n.error),a(n.error)},n.onsuccess=()=>{r()},s.oncomplete=()=>{o.close()}}))}catch(o){console.warn("Failed to store in IndexedDB:",o)}}async function m(){try{const{data:t}=await e.auth.getSession();(null==t?void 0:t.session)&&await e.auth.refreshSession({refresh_token:t.session.refresh_token})}catch(t){console.error("Failed to refresh token on focus:",t)}}function g(e){switch(e){case"admin":return"admin";case"super-admin":case"super_admin":return"super-admin";case"section-admin":case"section_admin":return"section_admin";default:return"user"}}function h(e){return console.log("Mapping DB user to User:",e),{id:e.id,email:e.email,name:e.name||e.username||e.email.split("@")[0],role:g(e.role||"user"),avatar:e.avatar,phone:e.phone,createdAt:e.created_at||(new Date).toISOString(),lastActive:e.last_active,studentId:e.student_id,departmentId:e.department_id,batchId:e.batch_id,sectionId:e.section_id}}function f(){if(t.isNativePlatform())return;const e=window.location.pathname.includes("super-admin")||"true"===sessionStorage.getItem("is_super_admin")||"true"===localStorage.getItem("is_super_admin");if(console.log("Cache cleanup called, isSuperAdmin:",e),e)return console.log("Super admin detected - preserving state without cache clearing"),void("serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PRESERVE_ADMIN_CACHES",timestamp:Date.now()}));"caches"in window&&caches.keys().then((e=>{e.forEach((e=>{e.includes("nesttask")&&(console.log(`Clearing cache: ${e}`),caches.delete(e).then((e=>console.log(`Cache deleted: ${e}`))))}))})),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(navigator.serviceWorker.controller.postMessage({type:"CLEAR_ALL_CACHES",timestamp:Date.now()}),navigator.serviceWorker.addEventListener("message",(e=>{e.data&&"CACHES_CLEARED"===e.data.type&&console.log("Service worker cleared caches")}),{once:!0}))}function p(e){t.isNativePlatform()||"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"AUTH_STATE_CHANGED",event:e?"SIGNED_IN":"SIGNED_OUT",timestamp:Date.now()})}const w=o("Network",{web:()=>r((()=>import("./web.ZC7oJB9d.js")),__vite__mapDeps([0,1,2])).then((e=>new e.NetworkWeb))}),I="nesttask_remember_me",S="nesttask_saved_email";function v(){const[o,r]=a.useState(null),[g,v]=a.useState(!0),[_,k]=a.useState(null),[y,b]=a.useState(null),[E,N]=a.useState(0),[D,O]=a.useState(!0);a.useEffect((()=>{let t=!0;const o=localStorage.getItem(S);o&&b(o);const a=localStorage.getItem("nesttask_cached_user");if(a&&t)try{const e=JSON.parse(a);r(e)}catch(n){console.error("Failed to parse cached user on mount:",n)}A();const{data:{subscription:s}}=e.auth.onAuthStateChange(P);return()=>{t=!1,s.unsubscribe()}}),[]);const A=async()=>{try{let a=navigator.onLine;if(t.isNativePlatform())try{a=(await w.getStatus()).connected}catch(o){console.warn("Failed to get network status, using navigator.onLine")}if(!a){console.log("Offline mode: Loading cached user data");const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);return r(t),console.log("Successfully loaded cached user:",t.email),O(!1),void v(!1)}catch(o){console.error("Failed to parse cached user:",o)}return console.log("No cached user found for offline mode"),O(!1),void v(!1)}if(!(await s())){console.warn("Database connection test failed");const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);return r(t),console.log("Using cached user due to connection issues"),void v(!1)}catch(o){console.error("Failed to parse cached user:",o)}}const{data:{session:n},error:i}=await e.auth.getSession();if(i){console.error("Error getting auth session:",i.message);const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);r(t),console.log("Using cached user due to session error")}catch(o){console.error("Failed to parse cached user:",o)}return void v(!1)}(null==n?void 0:n.user)?await C(n.user):(console.log("No active session found"),O(!1))}catch(o){console.error("Session check error:",o);let e=navigator.onLine;if(t.isNativePlatform())try{e=(await w.getStatus()).connected}catch(a){}if(e){if(k("Failed to check authentication status"),E<3){const e=Math.min(1e3*Math.pow(2,E),1e4);return console.log(`Will retry session check in ${e}ms`),void setTimeout((()=>{N((e=>e+1)),A()}),e)}}else{console.log("Offline mode: Attempting to load cached user");const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);r(t),console.log("Loaded cached user for offline use")}catch(n){console.error("Failed to parse cached user:",n)}}}finally{v(!1)}},P=async(e,a)=>{if(!(null==a?void 0:a.user)&&D){console.log("No session on initial load, checking if we should preserve cached user");let e=navigator.onLine;if(t.isNativePlatform())try{e=(await w.getStatus()).connected}catch(s){}if(!e&&o)return console.log("Preserving cached user while offline"),O(!1),void v(!1)}if(O(!1),null==a?void 0:a.user)try{await C(a.user)}catch(n){console.error("Error updating user state:",n);let e=navigator.onLine;if(t.isNativePlatform())try{e=(await w.getStatus()).connected}catch(s){}e?await F():console.log("Error updating user state while offline, keeping cached user")}else{let e=navigator.onLine;if(t.isNativePlatform())try{e=(await w.getStatus()).connected}catch(s){}e?(console.log("No session and online, clearing user"),r(null)):console.log("No session but offline, keeping cached user")}v(!1)},F=async()=>{r(null),p(!1),localStorage.removeItem("supabase.auth.token"),localStorage.removeItem("nesttask_user"),localStorage.removeItem("nesttask_cached_user"),sessionStorage.removeItem("supabase.auth.token"),"true"!==localStorage.getItem(I)&&localStorage.removeItem(S),document.cookie.split(";").forEach((function(e){document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")})),f()},C=async t=>{var o,a,s;try{const l=n.userWithFullInfo(t.id),d=i.get(l);let u;if(d)u=d;else{const{data:o,error:r}=await e.from("users_with_full_info").select("*").eq("id",t.id).single();if(r)throw console.error("Error fetching user data:",r),r;u=o,i.set(l,u)}let m=(null==u?void 0:u.role)||(null==(o=t.user_metadata)?void 0:o.role)||"user";"super_admin"!==m&&"super-admin"!==m||(m="super-admin");const g={id:t.id,email:t.email,name:(null==u?void 0:u.name)||(null==(a=t.user_metadata)?void 0:a.name)||(null==(s=t.email)?void 0:s.split("@")[0])||"",role:m,createdAt:(null==u?void 0:u.createdAt)||t.created_at,avatar:null==u?void 0:u.avatar,phone:null==u?void 0:u.phone,studentId:null==u?void 0:u.studentId,departmentId:null==u?void 0:u.departmentId,batchId:null==u?void 0:u.batchId,sectionId:null==u?void 0:u.sectionId,departmentName:null==u?void 0:u.departmentName,batchName:null==u?void 0:u.batchName,sectionName:null==u?void 0:u.sectionName};r(g);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(g))}catch(c){console.warn("Failed to cache user data:",c)}}catch(c){throw console.error("Error updating user state:",c),c}};return{user:o,loading:g,error:_,login:async(t,o=!1)=>{try{if(k(null),o?(localStorage.setItem(I,"true"),localStorage.setItem(S,t.email)):(localStorage.removeItem(I),localStorage.removeItem(S)),("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname)&&localStorage.getItem("nesttask_demo_user"))try{const e=JSON.parse(localStorage.getItem("nesttask_demo_user")||"{}");if(e&&e.email===t.email)return console.log("Using cached demo user from localStorage:",e),r(e),p(!0),"super-admin"!==e.role&&"superadmin@nesttask.com"!==e.email||(console.log("Demo super admin detected"),localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true")),e}catch(a){console.warn("Failed to parse demo user from localStorage")}const l=await async function({email:t,password:o}){var r,s,n,i,l,d;try{if(!t||!o)throw new Error("Email and password are required");console.log(`Attempting login for email: ${t}`);const f="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname;if(f&&["test@example.com","admin@example.com","demo@nesttask.com","test@nesttask.com","user@nesttask.com","superadmin@nesttask.com","admin@diu.edu.bd"].includes(t)){console.log("ðŸ”§ [DEV MODE] Using demo login for:",t);const e={id:`dev-${Math.random().toString(36).substring(2,9)}`,email:t,name:t.split("@")[0],role:t.includes("superadmin")?"super-admin":t.includes("admin")?"admin":t.includes("section")?"section-admin":"user",createdAt:(new Date).toISOString(),avatar:void 0,phone:"+1234567890",lastActive:(new Date).toISOString(),studentId:"12345",departmentId:"dept-1",batchId:"batch-1",sectionId:"section-1"};return console.log("ðŸ”§ [DEV MODE] Created mock user with role:",e.role),localStorage.setItem("nesttask_demo_user",JSON.stringify(e)),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",t),localStorage.setItem("nesttask_auth_bypass","true"),localStorage.setItem("nesttask_cached_user",JSON.stringify(e)),e}console.log("ðŸ“¡ Attempting Supabase authentication for:",t),await e.auth.setSession({access_token:"",refresh_token:""}),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",t);const{data:p,error:w}=await e.auth.signInWithPassword({email:t,password:o});if(w){if(f){console.warn("Development mode: Creating fallback user after failed login attempt"),console.warn("Error from auth service:",w.message);const e={id:`dev-fallback-${Math.random().toString(36).substring(2,9)}`,email:t,name:t.split("@")[0],role:t.includes("admin")?"admin":"user",createdAt:(new Date).toISOString(),avatar:void 0,phone:"+1234567890",lastActive:(new Date).toISOString(),studentId:"DEV12345",departmentId:"dev-dept-1",batchId:"dev-batch-1",sectionId:"dev-section-1"};return localStorage.setItem("nesttask_demo_user",JSON.stringify(e)),localStorage.setItem("nesttask_auth_bypass","true"),e}console.error("Login error:",w);let e=c(w);throw w.message&&w.message.includes("Invalid login credentials")&&(e="Invalid email or password. Please try again."),w.message&&w.message.includes("fetch")&&(e="Network error. Please check your internet connection."),new Error(e)}if(!(null==p?void 0:p.user))throw new Error("No user data received");if(p.session){!function(){const t=setInterval((async()=>{try{const{data:t}=await e.auth.getSession();if(null==t?void 0:t.session){const{data:o,error:r}=await e.auth.refreshSession({refresh_token:t.session.refresh_token});if(r)return void console.error("Error refreshing token:",r);(null==o?void 0:o.session)&&(localStorage.setItem("supabase.auth.token",JSON.stringify(o.session)),await u("session",JSON.stringify(o.session)))}}catch(a){console.error("Failed to refresh token:",a)}}),432e5);localStorage.setItem("nesttask_refresh_interval",t.toString()),window.addEventListener("focus",m)}(p.session.refresh_token),localStorage.setItem("supabase.auth.token",JSON.stringify(p.session));try{await u("session",JSON.stringify(p.session)),await u("email",t),await u("remember_me",!0)}catch(g){console.warn("IndexedDB storage failed, falling back to localStorage only",g)}}await new Promise((e=>setTimeout(e,1e3)));const{data:I,error:S}=await e.from("users").select().eq("id",p.user.id).maybeSingle();if(S){console.error("Error fetching user profile:",S);const t={id:p.user.id,email:p.user.email,name:(null==(r=p.user.user_metadata)?void 0:r.name)||(null==(s=p.user.email)?void 0:s.split("@")[0])||"",role:(null==(n=p.user.user_metadata)?void 0:n.role)||"user",created_at:(new Date).toISOString(),last_active:(new Date).toISOString()},{data:o,error:a}=await e.from("users").insert(t).select().single();if(a)throw new Error("Failed to create user profile");if(!o)throw new Error("No profile data received after creation");return h(o)}if(!I){const t={id:p.user.id,email:p.user.email,name:(null==(i=p.user.user_metadata)?void 0:i.name)||(null==(l=p.user.email)?void 0:l.split("@")[0])||"",role:(null==(d=p.user.user_metadata)?void 0:d.role)||"user",created_at:(new Date).toISOString(),last_active:(new Date).toISOString()},{data:o,error:r}=await e.from("users").insert(t).select().single();if(r)throw new Error("Failed to create user profile");if(!o)throw new Error("No profile data received after creation");return h(o)}return h(I)}catch(_){console.error("Login error:",_),_.message&&console.error("Error message:",_.message),_.code&&console.error("Error code:",_.code),_.status&&console.error("Error status:",_.status),_.details&&console.error("Error details:",_.details);let t=c(_);throw _.message&&_.message.includes("Invalid login credentials")&&(t="Invalid email or password. Please try again."),_.message&&_.message.includes("fetch")&&(t="Network error. Please check your internet connection."),new Error(t)}}(t);if(console.log("User after login:",l),p(!0),"super-admin"===l.role||"superadmin@nesttask.com"===t.email||"superadmin@nesttask.com"===l.email){console.log("Super admin login detected"),l.role="super-admin";const t=n.userWithFullInfo(l.id||l.email),o=i.get(t);if(o&&o.name)l.name=o.name;else try{const{data:o,error:r}=await e.from("users_with_full_info").select("*").eq("email",l.email).single();!r&&o&&(console.log("Super admin data from database:",o),o.name&&(l.name=o.name),i.set(t,o))}catch(a){console.warn("Error fetching super admin data, using default values",a)}localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true"),r(l);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(l)),console.log("Super-admin user cached after login for offline access")}catch(s){console.warn("Failed to cache super-admin user after login:",s)}return l}const{data:d,error:g}=await e.from("users").select("*").eq("id",l.id).single();g?console.error("Error fetching user data after login:",g):(console.log("User data from database after login:",d),d&&(d.role&&(l.role=d.role,console.log("Updated user role from database:",l.role)),d.department_id&&(l.departmentId=d.department_id,console.log("Updated user department ID:",l.departmentId)),d.batch_id&&(l.batchId=d.batch_id,console.log("Updated user batch ID:",l.batchId)),d.section_id&&(l.sectionId=d.section_id,console.log("Updated user section ID:",l.sectionId)),d.phone&&(l.phone=d.phone),d.student_id&&(l.studentId=d.student_id),d.avatar&&(l.avatar=d.avatar))),r(l);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(l)),console.log("User cached after login for offline access")}catch(s){console.warn("Failed to cache user after login:",s)}return f(),l}catch(a){throw k(a.message),a}},signup:async t=>{try{k(null),console.log("Starting signup process with credentials:",{...t,password:"[REDACTED]"}),t.departmentId&&console.log(`Department selected: ${t.departmentId}`),t.batchId&&console.log(`Batch selected: ${t.batchId}`),t.sectionId&&console.log(`Section selected: ${t.sectionId}`);const a=await async function({email:t,password:o,name:r,phone:a,studentId:s,departmentId:n,batchId:i,sectionId:c}){try{if(!t||!o||!r)throw new Error("All fields are required");if(!n||!i||!c)throw console.error("Missing required IDs:",{departmentId:n,batchId:i,sectionId:c}),new Error("Please select your department, batch, and section before signing up");if(!(t.endsWith("@diu.edu.bd")||t.includes("@gmail.com")||t.includes("@test.com")||"superadmin@nesttask.com"===t))throw new Error("Please use a valid email address (@diu.edu.bd, or test email)");console.log("Signup data:",{email:t,name:r,phone:a,studentId:s,departmentId:n,batchId:i,sectionId:c});const{data:l,error:d}=await e.auth.signUp({email:t,password:o,options:{emailRedirectTo:window.location.origin,data:{name:r,phone:a||"",studentId:s||"",role:"user",departmentId:n,batchId:i,sectionId:c}}});if(d)throw d;if(!(null==l?void 0:l.user))throw new Error("Failed to create user");console.log("User created in auth, session:",l.session?"Active":"Pending confirmation"),console.log("Relying on database trigger to create profile"),await new Promise((e=>setTimeout(e,2e3)));const{data:u,error:m}=await e.from("users_with_full_info").select("*").eq("id",l.user.id).single();if(m){console.error("Error fetching user data after signup:",m);const{data:o,error:d}=await e.from("users").select("*").eq("id",l.user.id).single();return d?(console.error("Second attempt failed to fetch user data:",d),{id:l.user.id,email:t,name:r,phone:a,studentId:s,role:"user",createdAt:(new Date).toISOString(),departmentId:n,batchId:i,sectionId:c}):h(o)}return{id:u.id,email:u.email,name:u.name,role:u.role,phone:u.phone,studentId:u.studentId,createdAt:u.createdAt,lastActive:u.lastActive,departmentId:u.departmentId,departmentName:u.departmentName,batchId:u.batchId,batchName:u.batchName,sectionId:u.sectionId,sectionName:u.sectionName}}catch(_){throw console.error("Signup error:",_),new Error(_.message||"Failed to create account")}}(t);console.log("Signup successful, user data:",{id:a.id,email:a.email,name:a.name,role:a.role,departmentId:a.departmentId,batchId:a.batchId,sectionId:a.sectionId}),r(a);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(a)),localStorage.setItem("nesttask_user",JSON.stringify(a)),console.log("User cached after signup")}catch(o){console.warn("Failed to cache user after signup:",o)}return p(!0),a}catch(a){throw console.error("Signup error:",a),k(a.message),a}},logout:async()=>{try{console.log("Starting optimized logout..."),k(null),r(null),p(!1);const t="true"===localStorage.getItem(I);i.clear();const o=["supabase.auth.token","nesttask_user","nesttask_cached_user","nesttask_refresh_interval","is_super_admin","auth_completed"];t||o.push(S),o.forEach((e=>localStorage.removeItem(e))),sessionStorage.removeItem("supabase.auth.token"),sessionStorage.removeItem("is_super_admin"),document.cookie.split(";").forEach((e=>{document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")}));const a=async function(){try{const t=localStorage.getItem("nesttask_refresh_interval");t&&clearInterval(parseInt(t)),window.removeEventListener("focus",m);const o=e.auth.signOut({scope:"local"}).then((({error:e})=>{e&&console.error("Supabase signOut error:",e)})),r=d().then((e=>new Promise(((t,o)=>{const r=e.transaction(l,"readwrite").objectStore(l).clear();r.onsuccess=()=>{e.close(),t()},r.onerror=()=>{e.close(),o(r.error)}})))).catch((e=>{console.warn("Failed to clear IndexedDB:",e)}));await Promise.all([o,r])}catch(_){console.error("Logout error:",_)}}(),s=f();return await Promise.all([a,s]),console.log("Logout completed"),!0}catch(t){return console.error("Logout error:",t),k(t.message),!1}},forgotPassword:async t=>{try{k(null),await async function(t){try{if(!t)throw new Error("Email is required");console.log("Sending password reset email to:",t);const{error:o}=await e.auth.resetPasswordForEmail(t,{redirectTo:`${window.location.origin}/#auth/recovery`});if(o)throw console.error("Supabase resetPasswordForEmail error:",o),o;console.log("Password reset email sent successfully")}catch(_){throw console.error("Password reset error:",_),new Error(c(_)||"Failed to send password reset email. Please try again.")}}(t)}catch(o){throw k(o.message),o}},savedEmail:y,refreshUser:async()=>{try{const{data:{session:t}}=await e.auth.getSession();(null==t?void 0:t.user)&&(n.userWithFullInfo(t.user.id),i.clear(),await C(t.user))}catch(t){console.error("Error refreshing user:",t)}}}}export{w as N,v as u};
