import{s as y,r as p,g as G,C as H,t as j}from"./index.CFfqBDDG.js";import{s as K}from"./telegram.service.B5vX6-Oo.js";async function Q(){try{const{data:{user:e}}=await y.auth.getUser();if(!e)return console.warn("No authenticated user found"),[];const{data:t}=await y.from("users").select("role, section_id").eq("id",e.id).single();let r=y.from("users").select(`
        id, 
        email, 
        name, 
        role, 
        created_at, 
        last_active, 
        phone,
        student_id,
        section_id
      `).order("created_at",{ascending:!1});(t==null?void 0:t.role)!=="admin"&&(t==null?void 0:t.role)!=="super-admin"&&(t!=null&&t.section_id)&&(r=r.eq("section_id",t.section_id));const{data:s,error:n}=await r;if(n)return console.error("Error fetching users:",n),[];const u=(s==null?void 0:s.filter(o=>o.section_id).map(o=>o.section_id))||[];let b={};if(u.length>0){const{data:o,error:E}=await y.from("sections").select("id, name").in("id",u);!E&&o&&(b=o.reduce((g,_)=>(g[_.id]=_.name,g),{}))}return(s==null?void 0:s.map(o=>{var E;return{id:o.id,email:o.email||"",name:o.name||((E=o.email)==null?void 0:E.split("@")[0])||"",role:o.role||"user",createdAt:o.created_at,lastActive:o.last_active,phone:o.phone||"",studentId:o.student_id||"",sectionId:o.section_id||"",sectionName:o.section_id&&b[o.section_id]||""}}))||[]}catch(e){return console.error("Error fetching users:",e),[]}}async function ee(e){try{const{data:{user:t}}=await y.auth.getUser();if(!t)throw new Error("Unauthorized: You must be logged in");const{data:r,error:s}=await y.from("users").select("role, section_id").eq("id",t.id).single();if(s||!r)throw console.error("Error fetching user role:",s),new Error("Failed to get user role");const{data:n,error:u}=await y.from("users").select("section_id").eq("id",e).single();if(u)throw console.error("Error fetching target user:",u),new Error("Failed to get target user information");if((o=>o==="section-admin"||o==="section_admin")(r.role)){if(r.section_id!==(n==null?void 0:n.section_id))throw new Error("You can only delete users from your own section");console.log("Attempting to delete user as section admin:",{userId:e,adminSection:r.section_id,targetSection:n==null?void 0:n.section_id});const{error:o}=await y.rpc("delete_section_user",{user_id:e});if(o)throw console.error("Error deleting user as section admin:",o),new Error(o.message||"Failed to delete user")}else if(r.role==="admin"||r.role==="super-admin"){const{error:o}=await y.from("users").delete().eq("id",e);if(o)throw console.error("Error deleting user as admin:",o),new Error(o.message||"Failed to delete user")}else throw new Error("Unauthorized: Only administrators can delete users")}catch(t){throw console.error("Error deleting user:",t),new Error(t.message||"Failed to delete user")}}async function te(e,t){try{const{data:{user:r}}=await y.auth.getUser();if(!r)throw new Error("Unauthorized: You must be logged in");const{data:s}=await y.from("users").select("role").eq("id",r.id).single();if((s==null?void 0:s.role)!=="admin"&&(s==null?void 0:s.role)!=="super-admin")throw new Error("Unauthorized: Only admins can promote users");const{error:n}=await y.from("users").update({role:t}).eq("id",e);if(n)throw console.error("Error promoting user:",n),new Error(n.message||"Failed to promote user")}catch(r){throw console.error("Error promoting user:",r),new Error(r.message||"Failed to promote user")}}async function oe(e,t){try{const{data:{user:r}}=await y.auth.getUser();if(!r)throw new Error("Unauthorized: You must be logged in");const{data:s}=await y.from("users").select("role").eq("id",r.id).single();if((s==null?void 0:s.role)!=="admin"&&(s==null?void 0:s.role)!=="super-admin")throw new Error("Unauthorized: Only admins can demote users");const{error:n}=await y.from("users").update({role:t}).eq("id",e);if(n)throw console.error("Error demoting user:",n),new Error(n.message||"Failed to demote user")}catch(r){throw console.error("Error demoting user:",r),new Error(r.message||"Failed to demote user")}}function Z(e,t){let r=null,s=!1;return()=>{if(r&&clearTimeout(r),s){console.log("[EventDebounce] Handler already processing, skipping");return}r=setTimeout(async()=>{s=!0;try{await e()}finally{s=!1}},t)}}async function V(e=2e3){typeof window!="undefined"&&await new Promise(t=>{let r=!1;const s=()=>{r||(r=!0,window.clearTimeout(u),window.removeEventListener("supabase-session-validated",n),t())},n=()=>{s()},u=window.setTimeout(()=>{console.log("[SessionValidation] Timed out, proceeding"),s()},e);window.addEventListener("supabase-session-validated",n,{once:!0}),window.dispatchEvent(new CustomEvent("request-session-validation"))})}function me(){const[e,t]=p.useState([]),[r,s]=p.useState(!0),[n,u]=p.useState(null),b=p.useRef(0),o=p.useRef(!1),E=p.useCallback(async(k=!1)=>{if(o.current&&!k)return;const a=Date.now();if(!(!k&&a-b.current<1e4))try{o.current=!0,s(!0),u(null),await V(2500);const d=await Q();t(d),b.current=Date.now()}catch(d){u(d.message)}finally{s(!1),o.current=!1}},[]);p.useEffect(()=>{E(!0)},[E]);const g=p.useRef();return p.useEffect(()=>{g.current=async()=>{console.log("[useUsers] Resume detected, validating session first...");try{const k=new Promise(a=>{const d=setTimeout(()=>a(),2e3),v=()=>{clearTimeout(d),window.removeEventListener("supabase-session-validated",v),a()};window.addEventListener("supabase-session-validated",v,{once:!0})});window.dispatchEvent(new CustomEvent("request-session-validation")),await k,console.log("[useUsers] Session validated, refreshing users"),E(!0)}catch(k){console.error("[useUsers] Session validation failed:",k),E(!0)}}},[E]),p.useEffect(()=>{const a=Z(()=>{var d;(d=g.current)==null||d.call(g)},1e3);return window.addEventListener("app-resume",a),window.addEventListener("supabase-session-refreshed",a),()=>{window.removeEventListener("app-resume",a),window.removeEventListener("supabase-session-refreshed",a)}},[]),{users:e,loading:r,error:n,refreshUsers:()=>E(!0),deleteUser:async k=>{try{u(null),await ee(k),t(a=>a.filter(d=>d.id!==k))}catch(a){throw u(a.message),await E(!0),a}},promoteUser:async(k,a)=>{try{u(null),await te(k,a),t(d=>d.map(v=>v.id===k?{...v,role:a}:v))}catch(d){throw u(d.message),await E(!0),d}},demoteUser:async(k,a)=>{try{u(null),await oe(k,a),t(d=>d.map(v=>v.id===k?{...v,role:a}:v))}catch(d){throw u(d.message),await E(!0),d}}}}function I(e){return{id:e.id,name:e.name,category:e.category,dueDate:e.due_date,description:e.description,status:e.status,createdAt:e.created_at,isAdminTask:e.is_admin_task,sectionId:e.section_id||null,googleDriveLinks:e.google_drive_links||[],attachments:e.attachments||[]}}const re=async(e,t,r)=>{var n,u,b,o,E;let s=null;try{const g=14e3;s=new AbortController,r&&(r.aborted?s.abort((n=r.reason)!=null?n:"aborted"):r.addEventListener("abort",()=>{var L;return s==null?void 0:s.abort((L=r.reason)!=null?L:"aborted")},{once:!0}));const _=setTimeout(()=>s==null?void 0:s.abort("timeout"),g),{data:{session:w}}=await G({timeoutMs:3e3,maxAgeMs:0}),z=(b=(u=w==null?void 0:w.user)==null?void 0:u.user_metadata)==null?void 0:b.role,k=t||((E=(o=w==null?void 0:w.user)==null?void 0:o.user_metadata)==null?void 0:E.section_id);let a=y.from("tasks").select("id,name,description,due_date,status,category,is_admin_task,user_id,section_id,created_at").abortSignal(s.signal);a=a.order("created_at",{ascending:!1});const{data:d,error:v}=await a;if(clearTimeout(_),v)throw console.error("Error fetching tasks:",v),v;const q=d.map(I);if(k){const L=q.filter(T=>T.sectionId===k);console.log(`[Debug] Found ${L.length} section tasks with sectionId: ${k}`),L.length>0&&console.log("[Debug] Section task IDs:",L.map(T=>T.id))}return q}catch(g){throw g.name==="AbortError"?(s?s.signal.reason:void 0)==="timeout"?(console.error("Task fetch timed out"),new Error("Task fetch timed out. Please try again.")):new Error("Task fetch aborted"):(console.error("Error in fetchTasks:",g),new Error(`Failed to fetch tasks: ${g.message}`))}};async function se(e){try{const t=e.name.split(".").pop(),s=`task-files/${`${crypto.randomUUID()}.${t}`}`,{error:n}=await y.storage.from("task-attachments").upload(s,e,{contentType:e.type,cacheControl:"3600",upsert:!1});if(n)throw n;const{data:{publicUrl:u}}=y.storage.from("task-attachments").getPublicUrl(s);return{url:u,originalName:e.name,path:s}}catch(t){throw console.error("Error uploading file:",t),t}}const ne=async(e,t,r)=>{var s,n,u,b;try{console.log("[Debug] Creating task with data:",{userId:e,task:t,sectionId:r,hasMobileFiles:!!t._mobileFiles,isSectionAdminMobile:!!t._isSectionAdminMobile});const{data:{user:o}}=await y.auth.getUser(),E=(s=o==null?void 0:o.user_metadata)==null?void 0:s.role,g=(n=o==null?void 0:o.user_metadata)==null?void 0:n.section_id;console.log("[Debug] User role and section when creating task:",{userRole:E,userSectionId:g});const _=t._mobileFiles,w=!!_&&_.length>0,z=!!t._isSectionAdminMobile,k=t._sectionId||r;w&&(console.log("[Debug] Processing mobile file upload with",_.length,"files"),z&&console.log("[Debug] This is a section admin mobile upload with section ID:",k));let a=t.description;const d=[];let v=null,q=0;const L=async(f,m=6e4)=>new Promise(async(i,c)=>{const l=new AbortController,D=l.signal,R=setTimeout(()=>{l.abort(),c(new Error(`Upload timed out for file ${f.name} after ${m/1e3}s`))},m);try{const S=await(async()=>{if(!f.name||f.size===0)throw new Error(`Invalid file: ${f.name||"unnamed"} (${f.size} bytes)`);if(f.size>26214400)throw new Error(`File too large: ${f.name} (${Math.round(f.size/1024/1024)}MB). Mobile file limit is 25MB.`);const $=f.name.split(".").pop(),U=`task-files/${`${crypto.randomUUID()}.${$}`}`;console.log(`[Debug] Starting upload for ${f.name} (${Math.round(f.size/1024)}KB) to ${U}`);const{error:C}=await y.storage.from("task-attachments").upload(U,f,{contentType:f.type,cacheControl:"3600",upsert:!1});if(C)throw C;const{data:{publicUrl:N}}=y.storage.from("task-attachments").getPublicUrl(U);return console.log(`[Debug] Successfully uploaded ${f.name} to ${U} (${N.slice(-20)})`),N})();clearTimeout(R),i(S)}catch(P){clearTimeout(R),D.aborted?c(new Error(`Upload timed out for file ${f.name}`)):c(P)}});if(w&&_)try{console.log("[Debug] Uploading mobile files",_.map(m=>({name:m.name,size:m.size})));const f=_.reduce((m,i)=>m+i.size,0);if(console.log(`[Debug] Total mobile upload size: ${Math.round(f/1024/1024)}MB`),f>100*1024*1024)throw new Error(`Total upload size too large: ${Math.round(f/1024/1024)}MB exceeds 100MB limit for mobile uploads`);for(const m of _){if(!m.name||m.size===0){console.warn("[Warning] Skipping invalid file",m);continue}try{console.log(`[Debug] Uploading mobile file: ${m.name} (${Math.round(m.size/1024)}KB)`);let i=null,c=0,l=null;for(;c<3&&!i;)try{c++;const S=Math.min(3e4+m.size/1024/10,6e4),$=await L(m,S);i={url:$,originalName:m.name,path:new URL($).pathname.split("/").pop()||""},d.push(i),q+=m.size;break}catch(S){if(console.error(`[Error] Failed to upload mobile file (attempt ${c}/3):`,m.name,S),l=S instanceof Error?S:new Error(String(S)),c<3){const $=1e3*Math.pow(2,c-1);await new Promise(h=>setTimeout(h,$))}}if(!i)throw v=l||new Error(`Failed to upload file after 3 attempts: ${m.name}`),v;const D=new RegExp(`\\[${m.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\]\\(attachment:${m.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`,"g"),R=`[${m.name}](${i.url})`,P=a;a=a.replace(D,R),P===a&&(console.warn("[Warning] Failed to find exact attachment reference, trying general pattern"),a=a.replace(/\[(.*?)\]\(attachment:(.*?)\)/g,(S,$,h)=>$===m.name?`[${$}](${i.url})`:S),P===a&&z&&(console.log("[Debug] Using fallback for section admin mobile file:",m.name),a.includes(`[${m.name}]`)||(a+=`
[${m.name}](${i.url})`))),console.log("[Debug] Replaced attachment reference with permanent URL")}catch(i){console.error("[Error] Failed to upload mobile file:",m.name,i),v||(v=i instanceof Error?i:new Error(String(i)));continue}}if(v&&d.length===0)throw v;v&&console.warn("[Warning] Some files failed to upload, but continuing with successful uploads",{successful:d.length,failed:_.length-d.length}),console.log(`[Debug] Successfully uploaded ${d.length}/${_.length} files, total size: ${Math.round(q/1024/1024)}MB`),a=a.replace(/\n<!-- mobile-uploads -->\n/g,"")}catch(f){console.error("[Error] Mobile file upload process failed:",f);try{d&&d.length>0&&(console.log(`[Debug] Cleaning up ${d.length} uploaded files after error`),await Promise.allSettled(d.map(async m=>{if(m.path)try{const{error:i}=await y.storage.from("task-attachments").remove([`task-files/${m.path}`]);i?console.error(`[Error] Failed to clean up file ${m.path}:`,i):console.log(`[Debug] Successfully cleaned up file: ${m.path}`)}catch(i){console.error(`[Error] Error during file cleanup for ${m.path}:`,i)}})))}catch(m){console.error("[Error] Failed during cleanup after upload error:",m)}throw f}else{const f=a.match(/\[([^\]]+)\]\((blob:.*?)\)/g)||[];console.log("[Debug] Found file matches in description:",f);for(const m of f)try{const i=m.match(/\[(.*?)\]\((blob:(.*?))\)/);if(!i)continue;const[,c,l]=i;if(console.log("[Debug] Processing file match:",{match:m,fileName:c,blobUrl:l}),c&&l)try{const D=new Promise(async(h,U)=>{try{console.log("[Debug] Fetching blob URL:",l);const C=await fetch(l);if(!C.ok){U(new Error(`Failed to fetch blob: ${C.status}`));return}const N=await C.blob();h(N)}catch(C){U(C)}}),R=new Promise((h,U)=>{setTimeout(()=>U(new Error("Blob fetch timed out")),1e4)}),P=await Promise.race([D,R]),S=new File([P],c,{type:P.type}),$=await se(S);d.push($),a=a.replace(m,`[${c}](${$.url})`),console.log("[Debug] Uploaded file and replaced URL with:",$.url)}catch(D){console.error("[Error] Processing file failed:",{fileName:c,error:D})}}catch(i){console.error("[Error] Invalid file match format:",{match:m,error:i})}}const T={name:t.name,category:t.category,due_date:t.dueDate,description:a,status:t.status,user_id:e,is_admin_task:E==="admin"||E==="section_admin"||E==="section-admin"||!1};d.length>0&&(T.attachments=d.map(f=>f.url),T.original_file_names=d.map(f=>f.name),console.log("[Debug] Added attachments to task:",{count:d.length,files:d.map(f=>({name:f.name,url:f.url.slice(-30)}))})),t.googleDriveLinks&&t.googleDriveLinks.length>0&&(T.google_drive_links=t.googleDriveLinks),(E==="section_admin"||E==="section-admin")&&g?(T.section_id=g,console.log("[Debug] Section admin creating task for section:",g),!a.includes("For section:")&&!a.includes("Section ID:")&&(T.description+=`

For section: ${g}`)):r?(T.section_id=r,console.log("[Debug] Using provided section_id:",r)):g&&E==="user"&&(T.section_id=g,console.log("[Debug] Regular user creating task for their section:",g)),console.log("[Debug] Final task insert data:",T);let M,O;try{const f=await y.from("tasks").insert(T).select().single();M=f.data,O=f.error}catch(f){if((u=f.message)!=null&&u.includes("google_drive_links")||(b=f.message)!=null&&b.includes("schema cache")){console.log("[Debug] Google Drive links column not found, retrying without it...");const{google_drive_links:m,...i}=T,c=await y.from("tasks").insert(i).select().single();M=c.data,O=c.error}else throw f}if(O)throw console.error("Error creating task:",O),new Error(`Failed to create task: ${O.message}`);if(!M)throw new Error("No data returned from task creation");console.log("[Debug] Successfully created task with ID:",M.id);const x=I(M);if(x.isAdminTask){console.log("[FCM] Task is admin task, sending notifications...");try{await ce(x),console.log("[FCM] Push notification sent successfully")}catch(f){console.error("[FCM] Failed to send push notification:",f)}await K(x)}else console.log("[FCM] Task is not admin task, skipping push notification");return x}catch(o){throw console.error("Error in createTask:",o),new Error(`Task creation failed: ${o.message}`)}};async function ie(e,t){var r,s;try{const n={};t.name!==void 0&&(n.name=t.name),t.category!==void 0&&(n.category=t.category),t.dueDate!==void 0&&(n.due_date=t.dueDate),t.description!==void 0&&(n.description=t.description),t.status!==void 0&&(n.status=t.status),t.sectionId!==void 0&&(n.section_id=t.sectionId),t.googleDriveLinks!==void 0&&t.googleDriveLinks.length>0&&(n.google_drive_links=t.googleDriveLinks);let u,b;try{const o=await y.from("tasks").update(n).eq("id",e).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();u=o.data,b=o.error}catch(o){if((r=o.message)!=null&&r.includes("google_drive_links")||(s=o.message)!=null&&s.includes("schema cache")){console.log("Google Drive links column not found, retrying update without it...");const{google_drive_links:E,...g}=n,_=await y.from("tasks").update(g).eq("id",e).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();u=_.data,b=_.error}else throw o}if(b)throw console.error("Database error:",b),new Error("Failed to update task");if(!u)throw new Error("Task not found");return{id:u.id,name:u.name,category:u.category,dueDate:u.due_date,description:u.description,status:u.status,createdAt:u.created_at,isAdminTask:u.is_admin_task,sectionId:u.section_id}}catch(n){throw console.error("Error updating task:",n),n}}async function ae(e){try{const{error:t}=await y.from("tasks").delete().eq("id",e);if(t)throw t}catch(t){throw console.error("Error deleting task:",t),new Error(t.message||"Failed to delete task")}}async function ce(e){try{const t="https://nglfbbdoyyfslzyjarqs.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbGZiYmRveXlmc2x6eWphcnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTgyMTQsImV4cCI6MjA4MzE3NDIxNH0.3sXujO3rtin57rTcHpXHi6Zfi9XJCEX3-mmcnnB8cJE";console.log("[FCM] Sending push notification for task:",e.id),console.log("[FCM] Supabase URL:",t?"Set":"Missing"),console.log("[FCM] Supabase Anon Key:",r?"Set":"Missing");const s=new Date(e.dueDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),n={taskId:e.id,title:"New Task",body:`${e.name} - Due: ${s}`,sectionId:e.sectionId||void 0,data:{category:e.category,priority:e.priority||"medium"}};console.log("[FCM] Calling edge function with payload:",JSON.stringify(n));const u=await fetch(`${t}/functions/v1/send-fcm-push`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(n)});if(console.log("[FCM] Edge function response status:",u.status),!u.ok){const o=await u.json().catch(()=>({}));throw console.error("[FCM] Push notification failed:",o),new Error(`FCM push failed: ${JSON.stringify(o)}`)}const b=await u.json();console.log(`[FCM] Push notification sent: ${b.sent}/${b.total} devices`,b)}catch(t){throw console.error("[FCM] Error sending FCM push notification:",t),t}}const Y=2e4,F=new Map,le=2,ue=3;function ge(e){const[t,r]=p.useState([]),[s,n]=p.useState(!0),[u,b]=p.useState(null),[o,E]=p.useState(0),g=p.useRef(!1),_=p.useRef(0),w=p.useRef(!0),z=p.useRef(null),k=p.useRef(e),a=p.useRef(!1),d=p.useRef(!1),v=p.useRef(Date.now()),q=p.useRef(0),L=p.useRef(0),T=p.useRef(null);p.useEffect(()=>{k.current=e},[e]),p.useEffect(()=>{const i=c=>{console.log("[useTasks] Session recovered event received, retrying task load..."),g.current&&(g.current=!1,w.current&&(n(!1),setTimeout(()=>{w.current&&e&&M({force:!0})},200)))};return window.addEventListener("supabase-session-recovered",i),()=>window.removeEventListener("supabase-session-recovered",i)},[e]),p.useEffect(()=>{const i=()=>{if(document.visibilityState==="hidden")d.current=!0,v.current=Date.now();else if(document.visibilityState==="visible"){const c=Date.now()-v.current;v.current=Date.now(),c<3e4?(d.current=!0,setTimeout(()=>{d.current=!1},1e3)):d.current=!1}};return document.addEventListener("visibilitychange",i),()=>{document.removeEventListener("visibilitychange",i)}},[]);const M=p.useCallback(async(i={})=>{var P,S,$;if(!e)return;if(g.current&&!i.force){console.log("[useTasks] Loading already in progress, skipping");return}i.force&&z.current&&z.current.abort("superseded");const c=new AbortController;z.current=c;const l=c.signal;i.force&&(a.current=!0,g.current=!1,w.current&&E(0));const D=Date.now();if(!i.force&&e&&F.has(e)){const h=F.get(e);if(D-h.timestamp<2e3){console.log("[useTasks] Using immediate cache (debounce)"),w.current&&(r(h.tasks),n(!1),g.current=!1);return}}const R=a.current?1e3:3e3;if(!i.force&&D-_.current<R){console.log("Task loading throttled - too soon since last load"),w.current&&n(!1),g.current=!1;return}try{const h=t.length>0,U=!d.current||!h;e&&F.has(e)&&!i.force&&h||w.current&&U&&n(!0),g.current=!0,L.current=Date.now(),T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{if(g.current&&w.current){const A=Date.now()-L.current;console.error(`[useTasks] ZOMBIE STATE DETECTED: Loading for ${Math.round(A/1e3)}s`),g.current=!1,w.current&&n(!1),console.log("[useTasks] Zombie recovery: forcing immediate retry..."),setTimeout(()=>{w.current&&M({force:!0})},100)}},2e4),w.current&&b(null);let C=!0;{const A=H.isNativePlatform(),B=A?15e3:2e3;if(console.log(`[useTasks] Requesting session validation (timeout: ${B}ms, native: ${A})`),await V(B),C=await j(),!C){if(e&&F.has(e)){console.warn("[useTasks] Connection failed, using cache"),w.current&&(r(F.get(e).tasks),b("Device offline - showing cached tasks"));return}throw new Error("Unable to connect to database")}const J=async()=>await G({timeoutMs:8e3});let{data:W}=await J();if(W.session||(console.log("[useTasks] No session on initial fetch; requesting validation and retrying once..."),await V(4e3),{data:W}=await J()),!W.session){if(console.log("[useTasks] Still no session; checks failed"),e&&F.has(e)){console.log("[useTasks] Session failed, falling back to cache"),w.current&&(r(F.get(e).tasks),b("Offline mode: Using cached tasks"));return}console.warn("[useTasks] Proceeding to fetch despite missing session check (optimistic)")}}if(l.aborted){console.log("Task loading aborted");return}const N=window.setTimeout(()=>{try{c.abort("timeout")}catch(A){}},Y);let X;try{X=await re(e,void 0,l)}finally{window.clearTimeout(N)}w.current&&!l.aborted&&(r(X),b(null),_.current=Date.now(),E(0),a.current=!1)}catch(h){if(l.aborted&&l.reason==="superseded"){console.log("Task loading aborted");return}if(((h==null?void 0:h.name)==="AbortError"||((P=h==null?void 0:h.message)==null?void 0:P.includes("AbortError")))&&navigator.onLine&&l.aborted&&!l.reason){console.log("[useTasks] Browser aborted fetch during offlineâ†’online transition, retrying immediately..."),w.current&&(n(!1),g.current=!1),setTimeout(()=>{w.current&&M({force:!0})},100);return}const N=l.aborted&&l.reason==="timeout";if(w.current&&(!l.aborted||N)){if(console.error("Error fetching tasks:",h),(h==null?void 0:h.message)==="Task fetch timeout"||((S=h==null?void 0:h.message)==null?void 0:S.includes("timed out"))||l.aborted&&l.reason==="timeout")b(`Failed to refresh: Task fetch timeout after ${Y/1e3}s. Network may be slow or server overloaded.`);else{if((h==null?void 0:h.message)==="Task fetch aborted")return;b(h.message||"Failed to load tasks")}const A=(h==null?void 0:h.message)==="Task fetch timeout"||($=h==null?void 0:h.message)!=null&&$.includes("timed out")||l.aborted&&l.reason==="timeout"?le:ue;if(o<A){const B=Math.floor(Math.random()*1e3),J=Math.min(1e3*Math.pow(2,o)+B,15e3);console.log(`Retrying task fetch in ${J}ms (attempt ${o+1}/${A})`),setTimeout(()=>{w.current&&E(W=>W+1)},J)}else o>=A&&(console.warn(`Maximum retries (${A}) reached for task fetching.`),H.isNativePlatform()?(console.error("[useTasks] Fatal network/session error on native. Forcing app reload."),window.location.reload()):a.current=!0)}}finally{T.current&&(clearTimeout(T.current),T.current=null),g.current=!1,L.current=0,w.current&&n(!1)}},[e,o]);p.useEffect(()=>{const c=Z(async()=>{const l=Date.now();if(l-q.current<3e3){console.log("[useTasks] Resume refresh throttled");return}if(q.current=l,!!k.current){console.log("[useTasks] Resume detected, validating session first...");try{const D=new Promise(R=>{const S=H.isNativePlatform()?15e3:1e4,$=Date.now();console.log(`[useTasks] Starting validation wait (timeout: ${S}ms, timestamp: ${$})`);const h=setTimeout(()=>{console.log(`[useTasks] Session validation timeout after ${Date.now()-$}ms, proceeding anyway`),R()},S),U=C=>{var B;const N=Date.now()-$,A=(B=C.detail)==null?void 0:B.success;clearTimeout(h),window.removeEventListener("supabase-session-validated",U),console.log(`[useTasks] Session validation event received after ${N}ms (success: ${A})`),R()};window.addEventListener("supabase-session-validated",U,{once:!0})});console.log("[useTasks] Dispatching request-session-validation event"),window.dispatchEvent(new CustomEvent("request-session-validation")),console.log("[useTasks] Waiting for session validation..."),await D,console.log("[useTasks] Session validated, now fetching tasks"),M({force:!0})}catch(D){console.error("[useTasks] Session validation failed:",D),M({force:!0})}}},1e3);return window.addEventListener("app-resume",c),window.addEventListener("supabase-session-refreshed",c),window.addEventListener("supabase-visibility-refresh",c),window.addEventListener("supabase-network-reconnect",c),()=>{window.removeEventListener("app-resume",c),window.removeEventListener("supabase-session-refreshed",c),window.removeEventListener("supabase-visibility-refresh",c),window.removeEventListener("supabase-network-reconnect",c)}},[M]),p.useEffect(()=>{if(!e){r([]),n(!1);return}return w.current=!0,n(!0),M(),()=>{w.current=!1,T.current&&(clearTimeout(T.current),T.current=null),z.current&&z.current.abort()}},[e,M]);const O=async(i,c)=>{if(!e)throw new Error("User ID is required");g.current&&(console.log("[useTasks] Resetting stuck loading state before task creation"),g.current=!1);try{const l=await ne(e,i,c);if(w.current&&(r(D=>[...D,l]),F.has(e))){const D=F.get(e);F.set(e,{tasks:[...D.tasks,l],timestamp:Date.now()})}return l}catch(l){throw console.error("Error creating task:",l),l}},x=async(i,c)=>{try{const l=await ie(i,c);if(w.current&&(r(D=>D.map(R=>R.id===i?{...R,...l}:R)),e&&F.has(e))){const D=F.get(e);F.set(e,{tasks:D.tasks.map(R=>R.id===i?{...R,...l}:R),timestamp:Date.now()})}return l}catch(l){throw console.error("Error updating task:",l),l}},f=async i=>{try{if(await ae(i),w.current&&(r(c=>c.filter(l=>l.id!==i)),e&&F.has(e))){const c=F.get(e);F.set(e,{tasks:c.tasks.filter(l=>l.id!==i),timestamp:Date.now()})}return!0}catch(c){throw console.error("Error deleting task:",c),c}},m=p.useCallback(async(i=!1)=>{try{return await M({force:i}),!0}catch(c){return console.error("[useTasks] Refresh failed:",c),!1}},[M]);return{tasks:t,loading:s,error:u,createTask:O,updateTask:x,deleteTask:f,refreshTasks:m}}export{ge as a,me as u};
