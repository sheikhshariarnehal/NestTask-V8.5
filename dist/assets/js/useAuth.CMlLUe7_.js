const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/web.CqphcPz5.js","assets/js/index.C_acLESD.js","assets/css/index.BC4iM_r6.css"])))=>i.map(i=>d[i]);
import{s as p,C as O,c as j,_ as H,r as b,t as K}from"./index.C_acLESD.js";import{c as q,d as D}from"./dataCache.z_cl_fNt.js";import{g as B}from"./authErrors.D8KAnYp0.js";const z="nesttask-auth-storage",G=1,A="auth";async function $(){return new Promise((e,n)=>{const l=indexedDB.open(z,G);l.onerror=()=>{console.error("Error opening IndexedDB:",l.error),n(l.error)},l.onupgradeneeded=i=>{const h=i.target.result;h.objectStoreNames.contains(A)||(h.createObjectStore(A),console.log("Created auth store in IndexedDB"))},l.onsuccess=()=>{const i=l.result;e(i)}})}async function J(e,n){try{const l=await $();return new Promise((i,h)=>{const u=l.transaction(A,"readwrite"),S=u.objectStore(A).put(n,e);S.onerror=()=>{console.error("Error storing in IndexedDB:",S.error),h(S.error)},S.onsuccess=()=>{i()},u.oncomplete=()=>{l.close()}})}catch(l){console.warn("Failed to store in IndexedDB:",l)}}async function Y({email:e,password:n}){var l,i,h,u,v,S;try{if(!e||!n)throw new Error("Email and password are required");console.log(`Attempting login for email: ${e}`);const m=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";if(m&&["test@example.com","admin@example.com","demo@nesttask.com","test@nesttask.com","user@nesttask.com","superadmin@nesttask.com","admin@diu.edu.bd"].includes(e)){console.log("ðŸ”§ [DEV MODE] Using demo login for:",e);const f={id:`dev-${Math.random().toString(36).substring(2,9)}`,email:e,name:e.split("@")[0],role:e.includes("superadmin")?"super-admin":e.includes("admin")?"admin":e.includes("section")?"section-admin":"user",createdAt:new Date().toISOString(),avatar:void 0,phone:"+1234567890",lastActive:new Date().toISOString(),studentId:"12345",departmentId:"dept-1",batchId:"batch-1",sectionId:"section-1"};return console.log("ðŸ”§ [DEV MODE] Created mock user with role:",f.role),localStorage.setItem("nesttask_demo_user",JSON.stringify(f)),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",e),localStorage.setItem("nesttask_auth_bypass","true"),localStorage.setItem("nesttask_cached_user",JSON.stringify(f)),f}console.log("ðŸ“¡ Attempting Supabase authentication for:",e),await p.auth.setSession({access_token:"",refresh_token:""}),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",e);const{data:g,error:d}=await p.auth.signInWithPassword({email:e,password:n});if(d){if(m){console.warn("Development mode: Creating fallback user after failed login attempt"),console.warn("Error from auth service:",d.message);const E={id:`dev-fallback-${Math.random().toString(36).substring(2,9)}`,email:e,name:e.split("@")[0],role:e.includes("admin")?"admin":"user",createdAt:new Date().toISOString(),avatar:void 0,phone:"+1234567890",lastActive:new Date().toISOString(),studentId:"DEV12345",departmentId:"dev-dept-1",batchId:"dev-batch-1",sectionId:"dev-section-1"};return localStorage.setItem("nesttask_demo_user",JSON.stringify(E)),localStorage.setItem("nesttask_auth_bypass","true"),E}console.error("Login error:",d);let f=B(d);throw d.message&&d.message.includes("Invalid login credentials")&&(f="Invalid email or password. Please try again."),d.message&&d.message.includes("fetch")&&(f="Network error. Please check your internet connection."),new Error(f)}if(!(g!=null&&g.user))throw new Error("No user data received");if(g.session){X(g.session.refresh_token),localStorage.setItem("supabase.auth.token",JSON.stringify(g.session));try{await J("session",JSON.stringify(g.session)),await J("email",e),await J("remember_me",!0)}catch(f){console.warn("IndexedDB storage failed, falling back to localStorage only",f)}}await new Promise(f=>setTimeout(f,1e3));const{data:k,error:y}=await p.from("users").select().eq("id",g.user.id).maybeSingle();if(y){console.error("Error fetching user profile:",y);const f={id:g.user.id,email:g.user.email,name:((l=g.user.user_metadata)==null?void 0:l.name)||((i=g.user.email)==null?void 0:i.split("@")[0])||"",role:((h=g.user.user_metadata)==null?void 0:h.role)||"user",created_at:new Date().toISOString(),last_active:new Date().toISOString()},{data:E,error:M}=await p.from("users").insert(f).select().single();if(M)throw new Error("Failed to create user profile");if(!E)throw new Error("No profile data received after creation");return T(E)}if(!k){const f={id:g.user.id,email:g.user.email,name:((u=g.user.user_metadata)==null?void 0:u.name)||((v=g.user.email)==null?void 0:v.split("@")[0])||"",role:((S=g.user.user_metadata)==null?void 0:S.role)||"user",created_at:new Date().toISOString(),last_active:new Date().toISOString()},{data:E,error:M}=await p.from("users").insert(f).select().single();if(M)throw new Error("Failed to create user profile");if(!E)throw new Error("No profile data received after creation");return T(E)}return T(k)}catch(m){console.error("Login error:",m),m.message&&console.error("Error message:",m.message),m.code&&console.error("Error code:",m.code),m.status&&console.error("Error status:",m.status),m.details&&console.error("Error details:",m.details);let _=B(m);throw m.message&&m.message.includes("Invalid login credentials")&&(_="Invalid email or password. Please try again."),m.message&&m.message.includes("fetch")&&(_="Network error. Please check your internet connection."),new Error(_)}}async function Q({email:e,password:n,name:l,phone:i,studentId:h,departmentId:u,batchId:v,sectionId:S}){try{if(!e||!n||!l)throw new Error("All fields are required");if(!u||!v||!S)throw console.error("Missing required IDs:",{departmentId:u,batchId:v,sectionId:S}),new Error("Please select your department, batch, and section before signing up");if(!(e.endsWith("@diu.edu.bd")||e.includes("@gmail.com")||e.includes("@test.com")||e==="superadmin@nesttask.com"))throw new Error("Please use a valid email address (@diu.edu.bd, or test email)");console.log("Signup data:",{email:e,name:l,phone:i,studentId:h,departmentId:u,batchId:v,sectionId:S});const{data:_,error:g}=await p.auth.signUp({email:e,password:n,options:{emailRedirectTo:window.location.origin,data:{name:l,phone:i||"",studentId:h||"",role:"user",departmentId:u,batchId:v,sectionId:S}}});if(g)throw g;if(!(_!=null&&_.user))throw new Error("Failed to create user");console.log("User created in auth, session:",_.session?"Active":"Pending confirmation"),console.log("Relying on database trigger to create profile"),await new Promise(y=>setTimeout(y,2e3));const{data:d,error:k}=await p.from("users_with_full_info").select("*").eq("id",_.user.id).single();if(k){console.error("Error fetching user data after signup:",k);const{data:y,error:f}=await p.from("users").select("*").eq("id",_.user.id).single();return f?(console.error("Second attempt failed to fetch user data:",f),{id:_.user.id,email:e,name:l,phone:i,studentId:h,role:"user",createdAt:new Date().toISOString(),departmentId:u,batchId:v,sectionId:S}):T(y)}return{id:d.id,email:d.email,name:d.name,role:d.role,phone:d.phone,studentId:d.studentId,createdAt:d.createdAt,lastActive:d.lastActive,departmentId:d.departmentId,departmentName:d.departmentName,batchId:d.batchId,batchName:d.batchName,sectionId:d.sectionId,sectionName:d.sectionName}}catch(m){throw console.error("Signup error:",m),new Error(m.message||"Failed to create account")}}async function U(){try{const e=localStorage.getItem("nesttask_refresh_interval");e&&clearInterval(parseInt(e)),window.removeEventListener("focus",V);const n=p.auth.signOut({scope:"local"}).then(({error:i})=>{i&&console.error("Supabase signOut error:",i)}),l=$().then(i=>i.transaction(A,"readwrite").objectStore(A).clear().then(()=>i.close())).catch(i=>{console.warn("Failed to clear IndexedDB:",i)});await Promise.all([n,l])}catch(e){console.error("Logout error:",e)}}async function V(){try{const{data:e}=await p.auth.getSession();e!=null&&e.session&&await p.auth.refreshSession({refresh_token:e.session.refresh_token})}catch(e){console.error("Failed to refresh token on focus:",e)}}function X(e){const l=setInterval(async()=>{try{const{data:i}=await p.auth.getSession();if(i!=null&&i.session){const{data:h,error:u}=await p.auth.refreshSession({refresh_token:i.session.refresh_token});if(u){console.error("Error refreshing token:",u);return}h!=null&&h.session&&(localStorage.setItem("supabase.auth.token",JSON.stringify(h.session)),await J("session",JSON.stringify(h.session)))}}catch(i){console.error("Failed to refresh token:",i)}},432e5);localStorage.setItem("nesttask_refresh_interval",l.toString()),window.addEventListener("focus",V)}function Z(e){switch(e){case"admin":return"admin";case"super-admin":case"super_admin":return"super-admin";case"section-admin":case"section_admin":return"section_admin";default:return"user"}}function T(e){return console.log("Mapping DB user to User:",e),{id:e.id,email:e.email,name:e.name||e.username||e.email.split("@")[0],role:Z(e.role||"user"),avatar:e.avatar,phone:e.phone,createdAt:e.created_at||new Date().toISOString(),lastActive:e.last_active,studentId:e.student_id,departmentId:e.department_id,batchId:e.batch_id,sectionId:e.section_id}}async function ee(e){try{if(!e)throw new Error("Email is required");console.log("Sending password reset email to:",e);const{error:n}=await p.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/#auth/recovery`});if(n)throw console.error("Supabase resetPasswordForEmail error:",n),n;console.log("Password reset email sent successfully")}catch(n){throw console.error("Password reset error:",n),new Error(B(n)||"Failed to send password reset email. Please try again.")}}function W(){if(O.isNativePlatform())return;const e=window.location.pathname.includes("super-admin")||sessionStorage.getItem("is_super_admin")==="true"||localStorage.getItem("is_super_admin")==="true";if(console.log("Cache cleanup called, isSuperAdmin:",e),e){console.log("Super admin detected - preserving state without cache clearing"),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PRESERVE_ADMIN_CACHES",timestamp:Date.now()});return}"caches"in window&&caches.keys().then(n=>{n.forEach(l=>{l.includes("nesttask")&&(console.log(`Clearing cache: ${l}`),caches.delete(l).then(i=>console.log(`Cache deleted: ${i}`)))})}),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(navigator.serviceWorker.controller.postMessage({type:"CLEAR_ALL_CACHES",timestamp:Date.now()}),navigator.serviceWorker.addEventListener("message",n=>{n.data&&n.data.type==="CACHES_CLEARED"&&console.log("Service worker cleared caches")},{once:!0}))}function C(e){O.isNativePlatform()||"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"AUTH_STATE_CHANGED",event:e?"SIGNED_IN":"SIGNED_OUT",timestamp:Date.now()})}const F=j("Network",{web:()=>H(()=>import("./web.CqphcPz5.js"),__vite__mapDeps([0,1,2])).then(e=>new e.NetworkWeb)}),R="nesttask_remember_me",L="nesttask_saved_email";function ie(){const[e,n]=b.useState(null),[l,i]=b.useState(!0),[h,u]=b.useState(null),[v,S]=b.useState(null),[m,_]=b.useState(0),[g,d]=b.useState(!0);b.useEffect(()=>{let a=!0;const s=localStorage.getItem(L);s&&S(s);const c=localStorage.getItem("nesttask_cached_user");if(c&&a)try{const o=JSON.parse(c);n(o)}catch(o){console.error("Failed to parse cached user on mount:",o)}k();const{data:{subscription:r}}=p.auth.onAuthStateChange(y);return()=>{a=!1,r.unsubscribe()}},[]);const k=async()=>{try{let a=navigator.onLine;if(O.isNativePlatform())try{a=(await F.getStatus()).connected}catch(o){console.warn("Failed to get network status, using navigator.onLine")}if(!a){console.log("Offline mode: Loading cached user data");const o=localStorage.getItem("nesttask_cached_user");if(o)try{const w=JSON.parse(o);n(w),console.log("Successfully loaded cached user:",w.email),d(!1),i(!1);return}catch(w){console.error("Failed to parse cached user:",w)}console.log("No cached user found for offline mode"),d(!1),i(!1);return}if(!await K()){console.warn("Database connection test failed");const o=localStorage.getItem("nesttask_cached_user");if(o)try{const w=JSON.parse(o);n(w),console.log("Using cached user due to connection issues"),i(!1);return}catch(w){console.error("Failed to parse cached user:",w)}}const{data:{session:c},error:r}=await p.auth.getSession();if(r){console.error("Error getting auth session:",r.message);const o=localStorage.getItem("nesttask_cached_user");if(o)try{const w=JSON.parse(o);n(w),console.log("Using cached user due to session error")}catch(w){console.error("Failed to parse cached user:",w)}i(!1);return}c!=null&&c.user?await E(c.user):(console.log("No active session found"),d(!1))}catch(a){console.error("Session check error:",a);let s=navigator.onLine;if(O.isNativePlatform())try{s=(await F.getStatus()).connected}catch(c){}if(s){if(u("Failed to check authentication status"),m<3){const c=Math.min(1e3*Math.pow(2,m),1e4);console.log(`Will retry session check in ${c}ms`),setTimeout(()=>{_(r=>r+1),k()},c);return}}else{console.log("Offline mode: Attempting to load cached user");const c=localStorage.getItem("nesttask_cached_user");if(c)try{const r=JSON.parse(c);n(r),console.log("Loaded cached user for offline use")}catch(r){console.error("Failed to parse cached user:",r)}}}finally{i(!1)}},y=async(a,s)=>{if(!(s!=null&&s.user)&&g){console.log("No session on initial load, checking if we should preserve cached user");let c=navigator.onLine;if(O.isNativePlatform())try{c=(await F.getStatus()).connected}catch(r){}if(!c&&e){console.log("Preserving cached user while offline"),d(!1),i(!1);return}}if(d(!1),s!=null&&s.user)try{await E(s.user)}catch(c){console.error("Error updating user state:",c);let r=navigator.onLine;if(O.isNativePlatform())try{r=(await F.getStatus()).connected}catch(o){}r?await f():console.log("Error updating user state while offline, keeping cached user")}else{let c=navigator.onLine;if(O.isNativePlatform())try{c=(await F.getStatus()).connected}catch(r){}c?(console.log("No session and online, clearing user"),n(null)):console.log("No session but offline, keeping cached user")}i(!1)},f=async()=>{n(null),C(!1),localStorage.removeItem("supabase.auth.token"),localStorage.removeItem("nesttask_user"),localStorage.removeItem("nesttask_cached_user"),sessionStorage.removeItem("supabase.auth.token"),localStorage.getItem(R)!=="true"&&localStorage.removeItem(L),document.cookie.split(";").forEach(function(a){document.cookie=a.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),W()},E=async a=>{var s,c,r;try{const o=q.userWithFullInfo(a.id),w=D.get(o);let t;if(w)t=w;else{const{data:P,error:x}=await p.from("users_with_full_info").select("*").eq("id",a.id).single();if(x)throw console.error("Error fetching user data:",x),x;t=P,D.set(o,t)}let N=(t==null?void 0:t.role)||((s=a.user_metadata)==null?void 0:s.role)||"user";(N==="super_admin"||N==="super-admin")&&(N="super-admin");const I={id:a.id,email:a.email,name:(t==null?void 0:t.name)||((c=a.user_metadata)==null?void 0:c.name)||((r=a.email)==null?void 0:r.split("@")[0])||"",role:N,createdAt:(t==null?void 0:t.createdAt)||a.created_at,avatar:t==null?void 0:t.avatar,phone:t==null?void 0:t.phone,studentId:t==null?void 0:t.studentId,departmentId:t==null?void 0:t.departmentId,batchId:t==null?void 0:t.batchId,sectionId:t==null?void 0:t.sectionId,departmentName:t==null?void 0:t.departmentName,batchName:t==null?void 0:t.batchName,sectionName:t==null?void 0:t.sectionName};n(I);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(I))}catch(P){console.warn("Failed to cache user data:",P)}}catch(o){throw console.error("Error updating user state:",o),o}};return{user:e,loading:l,error:h,login:async(a,s=!1)=>{try{if(u(null),s?(localStorage.setItem(R,"true"),localStorage.setItem(L,a.email)):(localStorage.removeItem(R),localStorage.removeItem(L)),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&localStorage.getItem("nesttask_demo_user"))try{const t=JSON.parse(localStorage.getItem("nesttask_demo_user")||"{}");if(t&&t.email===a.email)return console.log("Using cached demo user from localStorage:",t),n(t),C(!0),(t.role==="super-admin"||t.email==="superadmin@nesttask.com")&&(console.log("Demo super admin detected"),localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true")),t}catch(t){console.warn("Failed to parse demo user from localStorage")}const r=await Y(a);if(console.log("User after login:",r),C(!0),r.role==="super-admin"||a.email==="superadmin@nesttask.com"||r.email==="superadmin@nesttask.com"){console.log("Super admin login detected"),r.role="super-admin";const t=q.userWithFullInfo(r.id||r.email),N=D.get(t);if(N&&N.name)r.name=N.name;else try{const{data:I,error:P}=await p.from("users_with_full_info").select("*").eq("email",r.email).single();!P&&I&&(console.log("Super admin data from database:",I),I.name&&(r.name=I.name),D.set(t,I))}catch(I){console.warn("Error fetching super admin data, using default values",I)}localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true"),n(r);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(r)),console.log("Super-admin user cached after login for offline access")}catch(I){console.warn("Failed to cache super-admin user after login:",I)}return r}const{data:o,error:w}=await p.from("users").select("*").eq("id",r.id).single();w?console.error("Error fetching user data after login:",w):(console.log("User data from database after login:",o),o&&(o.role&&(r.role=o.role,console.log("Updated user role from database:",r.role)),o.department_id&&(r.departmentId=o.department_id,console.log("Updated user department ID:",r.departmentId)),o.batch_id&&(r.batchId=o.batch_id,console.log("Updated user batch ID:",r.batchId)),o.section_id&&(r.sectionId=o.section_id,console.log("Updated user section ID:",r.sectionId)),o.phone&&(r.phone=o.phone),o.student_id&&(r.studentId=o.student_id),o.avatar&&(r.avatar=o.avatar))),n(r);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(r)),console.log("User cached after login for offline access")}catch(t){console.warn("Failed to cache user after login:",t)}return W(),r}catch(c){throw u(c.message),c}},signup:async a=>{try{u(null),console.log("Starting signup process with credentials:",{...a,password:"[REDACTED]"}),a.departmentId&&console.log(`Department selected: ${a.departmentId}`),a.batchId&&console.log(`Batch selected: ${a.batchId}`),a.sectionId&&console.log(`Section selected: ${a.sectionId}`);const s=await Q(a);console.log("Signup successful, user data:",{id:s.id,email:s.email,name:s.name,role:s.role,departmentId:s.departmentId,batchId:s.batchId,sectionId:s.sectionId}),n(s);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(s)),localStorage.setItem("nesttask_user",JSON.stringify(s)),console.log("User cached after signup")}catch(c){console.warn("Failed to cache user after signup:",c)}return C(!0),s}catch(s){throw console.error("Signup error:",s),u(s.message),s}},logout:async()=>{try{console.log("Starting optimized logout..."),u(null),n(null),C(!1);const a=localStorage.getItem(R)==="true";D.clear();const s=["supabase.auth.token","nesttask_user","nesttask_cached_user","nesttask_refresh_interval","is_super_admin","auth_completed"];a||s.push(L),s.forEach(o=>localStorage.removeItem(o)),sessionStorage.removeItem("supabase.auth.token"),sessionStorage.removeItem("is_super_admin"),document.cookie.split(";").forEach(o=>{document.cookie=o.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")});const c=U(),r=W();return await Promise.all([c,r]),console.log("Logout completed"),!0}catch(a){return console.error("Logout error:",a),u(a.message),!1}},forgotPassword:async a=>{try{u(null),await ee(a)}catch(s){throw u(s.message),s}},savedEmail:v}}export{F as N,ie as u};
