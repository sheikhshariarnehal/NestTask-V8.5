import{s as e,r as t,t as o}from"./index.CPrYmX88.js";import{s as r}from"./telegram.service.BTr96-Tu.js";function s(e,t){let o=null,r=!1;return()=>{o&&clearTimeout(o),r?console.log("[EventDebounce] Handler already processing, skipping"):o=setTimeout((async()=>{r=!0;try{await e()}finally{r=!1}}),t)}}function n(){const[o,r]=t.useState([]),[n,a]=t.useState(!0),[i,c]=t.useState(null),l=t.useRef(0),d=t.useRef(!1),u=t.useCallback((async(t=!1)=>{if(!d.current||t){if(t)console.log("[useUsers] Force refresh - bypassing throttle and cache");else if(Date.now()-l.current<1e4)return void console.log("[useUsers] Refresh throttled");try{d.current=!0,a(!0),c(null),console.log("[useUsers] Fetching users from database...");const t=await async function(){try{const{data:{user:t}}=await e.auth.getUser();if(!t)return console.warn("No authenticated user found"),[];const{data:o}=await e.from("users").select("role, section_id").eq("id",t.id).single();let r=e.from("users").select("\n        id, \n        email, \n        name, \n        role, \n        created_at, \n        last_active, \n        phone,\n        student_id,\n        section_id\n      ").order("created_at",{ascending:!1});"admin"!==(null==o?void 0:o.role)&&"super-admin"!==(null==o?void 0:o.role)&&(null==o?void 0:o.section_id)&&(r=r.eq("section_id",o.section_id));const{data:s,error:n}=await r;if(n)return console.error("Error fetching users:",n),[];const a=(null==s?void 0:s.filter((e=>e.section_id)).map((e=>e.section_id)))||[];let i={};if(a.length>0){const{data:t,error:o}=await e.from("sections").select("id, name").in("id",a);!o&&t&&(i=t.reduce(((e,t)=>(e[t.id]=t.name,e)),{}))}return(null==s?void 0:s.map((e=>{var t;return{id:e.id,email:e.email||"",name:e.name||(null==(t=e.email)?void 0:t.split("@")[0])||"",role:e.role||"user",createdAt:e.created_at,lastActive:e.last_active,phone:e.phone||"",studentId:e.student_id||"",sectionId:e.section_id||"",sectionName:e.section_id&&i[e.section_id]||""}})))||[]}catch(i){return console.error("Error fetching users:",i),[]}}();r(t),l.current=Date.now(),console.log(`[useUsers] Successfully loaded ${t.length} users`)}catch(o){console.error("[useUsers] Failed to load users:",o),c(o.message)}finally{a(!1),d.current=!1}}}),[]);t.useEffect((()=>{u(!0)}),[u]);const g=t.useRef();return t.useEffect((()=>{g.current=async()=>{console.log("[useUsers] Resume detected, validating session first...");try{const e=new Promise((e=>{const t=setTimeout((()=>e()),2e3),o=()=>{clearTimeout(t),window.removeEventListener("supabase-session-validated",o),e()};window.addEventListener("supabase-session-validated",o,{once:!0})}));window.dispatchEvent(new CustomEvent("request-session-validation")),await e,console.log("[useUsers] Session validated, refreshing users"),u(!0)}catch(e){console.error("[useUsers] Session validation failed:",e),u(!0)}}}),[u]),t.useEffect((()=>{const e=s((()=>{var e;null==(e=g.current)||e.call(g)}),1e3);return window.addEventListener("app-resume",e),window.addEventListener("supabase-session-refreshed",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-session-refreshed",e)}}),[]),{users:o,loading:n,error:i,refreshUsers:()=>u(!0),deleteUser:async t=>{try{c(null),await async function(t){try{const{data:{user:r}}=await e.auth.getUser();if(!r)throw new Error("Unauthorized: You must be logged in");const{data:s,error:n}=await e.from("users").select("role, section_id").eq("id",r.id).single();if(n||!s)throw console.error("Error fetching user role:",n),new Error("Failed to get user role");const{data:a,error:i}=await e.from("users").select("section_id").eq("id",t).single();if(i)throw console.error("Error fetching target user:",i),new Error("Failed to get target user information");if("section-admin"===(o=s.role)||"section_admin"===o){if(s.section_id!==(null==a?void 0:a.section_id))throw new Error("You can only delete users from your own section");console.log("Attempting to delete user as section admin:",{userId:t,adminSection:s.section_id,targetSection:null==a?void 0:a.section_id});const{error:o}=await e.rpc("delete_section_user",{user_id:t});if(o)throw console.error("Error deleting user as section admin:",o),new Error(o.message||"Failed to delete user")}else{if("admin"!==s.role&&"super-admin"!==s.role)throw new Error("Unauthorized: Only administrators can delete users");{const{error:o}=await e.from("users").delete().eq("id",t);if(o)throw console.error("Error deleting user as admin:",o),new Error(o.message||"Failed to delete user")}}}catch(i){throw console.error("Error deleting user:",i),new Error(i.message||"Failed to delete user")}var o}(t),r((e=>e.filter((e=>e.id!==t))))}catch(o){throw c(o.message),await u(!0),o}},promoteUser:async(t,o)=>{try{c(null),await async function(t,o){try{const{data:{user:r}}=await e.auth.getUser();if(!r)throw new Error("Unauthorized: You must be logged in");const{data:s}=await e.from("users").select("role").eq("id",r.id).single();if("admin"!==(null==s?void 0:s.role)&&"super-admin"!==(null==s?void 0:s.role))throw new Error("Unauthorized: Only admins can promote users");const{error:n}=await e.from("users").update({role:o}).eq("id",t);if(n)throw console.error("Error promoting user:",n),new Error(n.message||"Failed to promote user")}catch(i){throw console.error("Error promoting user:",i),new Error(i.message||"Failed to promote user")}}(t,o),r((e=>e.map((e=>e.id===t?{...e,role:o}:e))))}catch(s){throw c(s.message),await u(!0),s}},demoteUser:async(t,o)=>{try{c(null),await async function(t,o){try{const{data:{user:r}}=await e.auth.getUser();if(!r)throw new Error("Unauthorized: You must be logged in");const{data:s}=await e.from("users").select("role").eq("id",r.id).single();if("admin"!==(null==s?void 0:s.role)&&"super-admin"!==(null==s?void 0:s.role))throw new Error("Unauthorized: Only admins can demote users");const{error:n}=await e.from("users").update({role:o}).eq("id",t);if(n)throw console.error("Error demoting user:",n),new Error(n.message||"Failed to demote user")}catch(i){throw console.error("Error demoting user:",i),new Error(i.message||"Failed to demote user")}}(t,o),r((e=>e.map((e=>e.id===t?{...e,role:o}:e))))}catch(s){throw c(s.message),await u(!0),s}}}}function a(e){return{id:e.id,name:e.name,category:e.category,dueDate:e.due_date,description:e.description,status:e.status,createdAt:e.created_at,isAdminTask:e.is_admin_task,sectionId:e.section_id||null,googleDriveLinks:e.google_drive_links||[],attachments:e.attachments||[]}}async function i(t){try{const o=t.name.split(".").pop(),r=`task-files/${crypto.randomUUID()}.${o}`,{error:s}=await e.storage.from("task-attachments").upload(r,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(s)throw s;const{data:{publicUrl:n}}=e.storage.from("task-attachments").getPublicUrl(r);return{url:n,originalName:t.name,path:r}}catch(o){throw console.error("Error uploading file:",o),o}}const c=new Map;function l(n){const[l,d]=t.useState([]),[u,g]=t.useState(!0),[m,f]=t.useState(null),[h,w]=t.useState(0),p=t.useRef(!1),y=t.useRef(0),k=t.useRef(!0),v=t.useRef(null),b=t.useRef(n),E=t.useRef(!1),_=t.useRef(!1),D=t.useRef(Date.now()),$=t.useRef(0);t.useEffect((()=>{b.current=n}),[n]),t.useEffect((()=>{const e=()=>{if("hidden"===document.visibilityState)_.current=!0,D.current=Date.now();else if("visible"===document.visibilityState){const e=Date.now()-D.current;D.current=Date.now(),p.current&&(console.log("[useTasks] Resetting stuck loading state after visibility change"),p.current=!1,k.current&&g(!1)),e<3e4?(_.current=!0,setTimeout((()=>{_.current=!1}),1e3)):_.current=!1}};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}}),[]);const T=t.useCallback((async(t={})=>{if(!n)return;v.current&&v.current.abort(),v.current=new AbortController;const r=v.current.signal;if(t.force&&(console.log("[useTasks] Force refresh - clearing cache"),c.delete(n),E.current=!0,p.current=!1,k.current&&w(0)),p.current&&!t.force)return void console.log("[useTasks] Loading already in progress, skipping");const s=Date.now(),i=E.current?1e3:3e3;if(!t.force&&s-y.current<i)console.log("Task loading throttled - too soon since last load");else try{const t=l.length>0,s=!_.current||!t;k.current&&s&&g(!0),p.current=!0,k.current&&f(null);let n=!0;{const{data:{user:t}}=await e.auth.getUser();if(n=await o(),!n)throw new Error("Unable to connect to database");const{data:r}=await e.auth.getSession();if(!r.session)throw console.log("No session found during task fetch, skipping reload"),new Error("Session expired - please refresh the page")}if(r.aborted)return void console.log("Task loading aborted");const i=async()=>{const t=await(async()=>{var t,o;try{const r=8e3,s=new AbortController,n=setTimeout((()=>s.abort()),r),{data:{user:i}}=await e.auth.getUser(),c=(null==(t=null==i?void 0:i.user_metadata)||t.role,null==(o=null==i?void 0:i.user_metadata)?void 0:o.section_id);let l=e.from("tasks").select("id,name,description,due_date,status,category,is_admin_task,user_id,section_id,created_at");l=l.order("created_at",{ascending:!1});const{data:d,error:u}=await l;if(clearTimeout(n),u)throw console.error("Error fetching tasks:",u),u;const g=d.map(a);if(c){const e=g.filter((e=>e.sectionId===c));console.log(`[Debug] Found ${e.length} section tasks with sectionId: ${c}`),e.length>0&&console.log("[Debug] Section task IDs:",e.map((e=>e.id)))}return g}catch(m){if("AbortError"===m.name)throw console.error("Task fetch timed out"),new Error("Task fetch timed out. Please try again.");throw console.error("Error in fetchTasks:",m),new Error(`Failed to fetch tasks: ${m.message}`)}})();return t},c=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Task fetch timeout"))),45e3)})),u=await Promise.race([i(),c]);k.current&&!r.aborted&&(d(u),f(null),y.current=Date.now(),w(0),E.current=!1)}catch(u){if(k.current&&(!v.current||!v.current.signal.aborted)){console.error("Error fetching tasks:",u),"Task fetch timeout"===u.message?f("Failed to refresh: Task fetch timeout after 45s. Network may be slow or server overloaded."):f(u.message||"Failed to load tasks");const e="Task fetch timeout"===u.message?5:3;if(h<e){const t=Math.floor(1e3*Math.random()),o=Math.min(1e3*Math.pow(2,h)+t,15e3);console.log(`Retrying task fetch in ${o}ms (attempt ${h+1}/${e})`),setTimeout((()=>{k.current&&w((e=>e+1))}),o)}else h>=e&&(E.current=!0,console.warn(`Maximum retries (${e}) reached for task fetching. Will force refresh next time.`))}}finally{p.current=!1,k.current&&g(!1)}}),[n,h]);t.useEffect((()=>{const e=s((async()=>{const e=Date.now();if(e-$.current<3e3)console.log("[useTasks] Resume refresh throttled");else if($.current=e,b.current){console.log("[useTasks] Resume detected, validating session first...");try{const e=new Promise((e=>{const t=setTimeout((()=>{console.log("[useTasks] Session validation timeout, proceeding anyway"),e()}),2e3),o=()=>{clearTimeout(t),window.removeEventListener("supabase-session-validated",o),console.log("[useTasks] Session validation complete"),e()};window.addEventListener("supabase-session-validated",o,{once:!0})}));window.dispatchEvent(new CustomEvent("request-session-validation")),await e,console.log("[useTasks] Session validated, now fetching tasks"),T({force:!0})}catch(t){console.error("[useTasks] Session validation failed:",t),T({force:!0})}}}),1e3);return window.addEventListener("app-resume",e),window.addEventListener("supabase-session-refreshed",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-session-refreshed",e)}}),[T]),t.useEffect((()=>n?(k.current=!0,g(!0),T(),()=>{k.current=!1,v.current&&v.current.abort()}):(d([]),void g(!1))),[n,T]);const F=t.useCallback((async(e=!1)=>{try{return await T({force:e}),!0}catch(t){return console.error("[useTasks] Refresh failed:",t),!1}}),[T]);return{tasks:l,loading:u,error:m,createTask:async(t,o)=>{if(!n)throw new Error("User ID is required");p.current&&(console.log("[useTasks] Resetting stuck loading state before task creation"),p.current=!1);try{const s=await(async(t,o,s)=>{var n,c,l,d;try{console.log("[Debug] Creating task with data:",{userId:t,task:o,sectionId:s,hasMobileFiles:!!o._mobileFiles,isSectionAdminMobile:!!o._isSectionAdminMobile});const{data:{user:m}}=await e.auth.getUser(),k=null==(n=null==m?void 0:m.user_metadata)?void 0:n.role,v=null==(c=null==m?void 0:m.user_metadata)?void 0:c.section_id;console.log("[Debug] User role and section when creating task:",{userRole:k,userSectionId:v});const b=o._mobileFiles,E=!!b&&b.length>0,_=!!o._isSectionAdminMobile,D=o._sectionId||s;E&&(console.log("[Debug] Processing mobile file upload with",b.length,"files"),_&&console.log("[Debug] This is a section admin mobile upload with section ID:",D));let $=o.description;const T=[];let F=null,U=0;const S=async(t,o=6e4)=>new Promise((async(r,s)=>{const n=new AbortController,a=n.signal,i=setTimeout((()=>{n.abort(),s(new Error(`Upload timed out for file ${t.name} after ${o/1e3}s`))}),o);try{const o=async()=>{if(!t.name||0===t.size)throw new Error(`Invalid file: ${t.name||"unnamed"} (${t.size} bytes)`);if(t.size>26214400)throw new Error(`File too large: ${t.name} (${Math.round(t.size/1024/1024)}MB). Mobile file limit is 25MB.`);const o=t.name.split(".").pop(),r=`task-files/${crypto.randomUUID()}.${o}`;console.log(`[Debug] Starting upload for ${t.name} (${Math.round(t.size/1024)}KB) to ${r}`);const{error:s}=await e.storage.from("task-attachments").upload(r,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(s)throw s;const{data:{publicUrl:n}}=e.storage.from("task-attachments").getPublicUrl(r);return console.log(`[Debug] Successfully uploaded ${t.name} to ${r} (${n.slice(-20)})`),n},s=await o();clearTimeout(i),r(s)}catch(c){clearTimeout(i),a.aborted?s(new Error(`Upload timed out for file ${t.name}`)):s(c)}}));if(E&&b)try{console.log("[Debug] Uploading mobile files",b.map((e=>({name:e.name,size:e.size}))));const e=b.reduce(((e,t)=>e+t.size),0);if(console.log(`[Debug] Total mobile upload size: ${Math.round(e/1024/1024)}MB`),e>104857600)throw new Error(`Total upload size too large: ${Math.round(e/1024/1024)}MB exceeds 100MB limit for mobile uploads`);for(const t of b)if(t.name&&0!==t.size)try{console.log(`[Debug] Uploading mobile file: ${t.name} (${Math.round(t.size/1024)}KB)`);let e=null,o=0,r=null;for(;o<3&&!e;)try{o++;const r=Math.min(3e4+t.size/1024/10,6e4),s=await S(t,r);e={url:s,originalName:t.name,path:new URL(s).pathname.split("/").pop()||""},T.push(e),U+=t.size;break}catch(u){if(console.error(`[Error] Failed to upload mobile file (attempt ${o}/3):`,t.name,u),r=u instanceof Error?u:new Error(String(u)),o<3){const e=1e3*Math.pow(2,o-1);await new Promise((t=>setTimeout(t,e)))}}if(!e)throw F=r||new Error(`Failed to upload file after 3 attempts: ${t.name}`),F;const s=new RegExp(`\\[${t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\]\\(attachment:${t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`,"g"),n=`[${t.name}](${e.url})`,a=$;$=$.replace(s,n),a===$&&(console.warn("[Warning] Failed to find exact attachment reference, trying general pattern"),$=$.replace(/\[(.*?)\]\(attachment:(.*?)\)/g,((o,r,s)=>r===t.name?`[${r}](${e.url})`:o)),a===$&&_&&(console.log("[Debug] Using fallback for section admin mobile file:",t.name),$.includes(`[${t.name}]`)||($+=`\n[${t.name}](${e.url})`))),console.log("[Debug] Replaced attachment reference with permanent URL")}catch(g){console.error("[Error] Failed to upload mobile file:",t.name,g),F||(F=g instanceof Error?g:new Error(String(g)));continue}else console.warn("[Warning] Skipping invalid file",t);if(F&&0===T.length)throw F;F&&console.warn("[Warning] Some files failed to upload, but continuing with successful uploads",{successful:T.length,failed:b.length-T.length}),console.log(`[Debug] Successfully uploaded ${T.length}/${b.length} files, total size: ${Math.round(U/1024/1024)}MB`),$=$.replace(/\n<!-- mobile-uploads -->\n/g,"")}catch(f){console.error("[Error] Mobile file upload process failed:",f);try{T&&T.length>0&&(console.log(`[Debug] Cleaning up ${T.length} uploaded files after error`),await Promise.allSettled(T.map((async t=>{if(t.path)try{const{error:o}=await e.storage.from("task-attachments").remove([`task-files/${t.path}`]);o?console.error(`[Error] Failed to clean up file ${t.path}:`,o):console.log(`[Debug] Successfully cleaned up file: ${t.path}`)}catch(o){console.error(`[Error] Error during file cleanup for ${t.path}:`,o)}}))))}catch(h){console.error("[Error] Failed during cleanup after upload error:",h)}throw f}else{const e=$.match(/\[([^\]]+)\]\((blob:.*?)\)/g)||[];console.log("[Debug] Found file matches in description:",e);for(const t of e)try{const e=t.match(/\[(.*?)\]\((blob:(.*?))\)/);if(!e)continue;const[,o,r]=e;if(console.log("[Debug] Processing file match:",{match:t,fileName:o,blobUrl:r}),o&&r)try{const e=new Promise((async(e,t)=>{try{console.log("[Debug] Fetching blob URL:",r);const o=await fetch(r);if(!o.ok)return void t(new Error(`Failed to fetch blob: ${o.status}`));e(await o.blob())}catch(o){t(o)}})),s=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Blob fetch timed out"))),1e4)})),n=await Promise.race([e,s]),a=new File([n],o,{type:n.type}),c=await i(a);T.push(c),$=$.replace(t,`[${o}](${c.url})`),console.log("[Debug] Uploaded file and replaced URL with:",c.url)}catch(w){console.error("[Error] Processing file failed:",{fileName:o,error:w})}}catch(p){console.error("[Error] Invalid file match format:",{match:t,error:p})}}const M={name:o.name,category:o.category,due_date:o.dueDate,description:$,status:o.status,user_id:t,is_admin_task:"admin"===k||"section_admin"===k||"section-admin"===k||!1};let I,C;T.length>0&&(M.attachments=T.map((e=>e.url)),M.original_file_names=T.map((e=>e.name)),console.log("[Debug] Added attachments to task:",{count:T.length,files:T.map((e=>({name:e.name,url:e.url.slice(-30)})))})),o.googleDriveLinks&&o.googleDriveLinks.length>0&&(M.google_drive_links=o.googleDriveLinks),"section_admin"!==k&&"section-admin"!==k||!v?s?(M.section_id=s,console.log("[Debug] Using provided section_id:",s)):v&&"user"===k&&(M.section_id=v,console.log("[Debug] Regular user creating task for their section:",v)):(M.section_id=v,console.log("[Debug] Section admin creating task for section:",v),$.includes("For section:")||$.includes("Section ID:")||(M.description+=`\n\nFor section: ${v}`)),console.log("[Debug] Final task insert data:",M);try{const t=await e.from("tasks").insert(M).select().single();I=t.data,C=t.error}catch(y){if(!(null==(l=y.message)?void 0:l.includes("google_drive_links"))&&!(null==(d=y.message)?void 0:d.includes("schema cache")))throw y;{console.log("[Debug] Google Drive links column not found, retrying without it...");const{google_drive_links:t,...o}=M,r=await e.from("tasks").insert(o).select().single();I=r.data,C=r.error}}if(C)throw console.error("Error creating task:",C),new Error(`Failed to create task: ${C.message}`);if(!I)throw new Error("No data returned from task creation");console.log("[Debug] Successfully created task with ID:",I.id);const R=a(I);if(R.isAdminTask){console.log("[FCM] Task is admin task, sending notifications...");try{await async function(e){try{const t="https://nglfbbdoyyfslzyjarqs.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbGZiYmRveXlmc2x6eWphcnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTgyMTQsImV4cCI6MjA4MzE3NDIxNH0.3sXujO3rtin57rTcHpXHi6Zfi9XJCEX3-mmcnnB8cJE";console.log("[FCM] Sending push notification for task:",e.id),console.log("[FCM] Supabase URL:",t?"Set":"Missing"),console.log("[FCM] Supabase Anon Key:",o?"Set":"Missing");const r=new Date(e.dueDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),s={taskId:e.id,title:"New Task",body:`${e.name} - Due: ${r}`,sectionId:e.sectionId||void 0,data:{category:e.category,priority:e.priority||"medium"}};console.log("[FCM] Calling edge function with payload:",JSON.stringify(s));const n=await fetch(`${t}/functions/v1/send-fcm-push`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(s)});if(console.log("[FCM] Edge function response status:",n.status),!n.ok){const e=await n.json().catch((()=>({})));throw console.error("[FCM] Push notification failed:",e),new Error(`FCM push failed: ${JSON.stringify(e)}`)}const a=await n.json();console.log(`[FCM] Push notification sent: ${a.sent}/${a.total} devices`,a)}catch(C){throw console.error("[FCM] Error sending FCM push notification:",C),C}}(R),console.log("[FCM] Push notification sent successfully")}catch(w){console.error("[FCM] Failed to send push notification:",w)}await r(R)}else console.log("[FCM] Task is not admin task, skipping push notification");return R}catch(m){throw console.error("Error in createTask:",m),new Error(`Task creation failed: ${m.message}`)}})(n,t,o);if(k.current&&(d((e=>[...e,s])),c.has(n))){const e=c.get(n);c.set(n,{tasks:[...e.tasks,s],timestamp:Date.now()})}return s}catch(s){throw console.error("Error creating task:",s),s}},updateTask:async(t,o)=>{try{const r=await async function(t,o){var r,s;try{const a={};let i,c;void 0!==o.name&&(a.name=o.name),void 0!==o.category&&(a.category=o.category),void 0!==o.dueDate&&(a.due_date=o.dueDate),void 0!==o.description&&(a.description=o.description),void 0!==o.status&&(a.status=o.status),void 0!==o.sectionId&&(a.section_id=o.sectionId),void 0!==o.googleDriveLinks&&o.googleDriveLinks.length>0&&(a.google_drive_links=o.googleDriveLinks);try{const o=await e.from("tasks").update(a).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();i=o.data,c=o.error}catch(n){if(!(null==(r=n.message)?void 0:r.includes("google_drive_links"))&&!(null==(s=n.message)?void 0:s.includes("schema cache")))throw n;{console.log("Google Drive links column not found, retrying update without it...");const{google_drive_links:o,...r}=a,s=await e.from("tasks").update(r).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();i=s.data,c=s.error}}if(c)throw console.error("Database error:",c),new Error("Failed to update task");if(!i)throw new Error("Task not found");return{id:i.id,name:i.name,category:i.category,dueDate:i.due_date,description:i.description,status:i.status,createdAt:i.created_at,isAdminTask:i.is_admin_task,sectionId:i.section_id}}catch(m){throw console.error("Error updating task:",m),m}}(t,o);if(k.current&&(d((e=>e.map((e=>e.id===t?{...e,...r}:e)))),n&&c.has(n))){const e=c.get(n);c.set(n,{tasks:e.tasks.map((e=>e.id===t?{...e,...r}:e)),timestamp:Date.now()})}return r}catch(r){throw console.error("Error updating task:",r),r}},deleteTask:async t=>{try{if(await async function(t){try{const{error:o}=await e.from("tasks").delete().eq("id",t);if(o)throw o}catch(m){throw console.error("Error deleting task:",m),new Error(m.message||"Failed to delete task")}}(t),k.current&&(d((e=>e.filter((e=>e.id!==t)))),n&&c.has(n))){const e=c.get(n);c.set(n,{tasks:e.tasks.filter((e=>e.id!==t)),timestamp:Date.now()})}return!0}catch(o){throw console.error("Error deleting task:",o),o}},refreshTasks:F}}export{l as a,n as u};
