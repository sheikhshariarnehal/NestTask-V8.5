const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/web.Dsjlmvc0.js","assets/js/index.BsUn6o1f.js","assets/css/index.JTvkVYmA.css"])))=>i.map(i=>d[i]);
import{s as h,C as P,d as V,_ as j,r as b,t as H}from"./index.BsUn6o1f.js";import{c as B,d as A}from"./dataCache.CcjqYMC_.js";import{g as q}from"./authErrors.D8KAnYp0.js";const z="nesttask-auth-storage",G=1,O="auth";async function $(){return new Promise((e,n)=>{const l=indexedDB.open(z,G);l.onerror=()=>{console.error("Error opening IndexedDB:",l.error),n(l.error)},l.onupgradeneeded=i=>{const f=i.target.result;f.objectStoreNames.contains(O)||(f.createObjectStore(O),console.log("Created auth store in IndexedDB"))},l.onsuccess=()=>{const i=l.result;e(i)}})}async function T(e,n){try{const l=await $();return new Promise((i,f)=>{const u=l.transaction(O,"readwrite"),w=u.objectStore(O).put(n,e);w.onerror=()=>{console.error("Error storing in IndexedDB:",w.error),f(w.error)},w.onsuccess=()=>{i()},u.oncomplete=()=>{l.close()}})}catch(l){console.warn("Failed to store in IndexedDB:",l)}}async function Y({email:e,password:n}){var l,i,f,u,I,w;try{if(!e||!n)throw new Error("Email and password are required");console.log(`Attempting login for email: ${e}`);const m=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",_=["test@example.com","admin@example.com","demo@nesttask.com","test@nesttask.com","user@nesttask.com","superadmin@nesttask.com","admin@diu.edu.bd"];console.log("ðŸ“¡ Attempting Supabase authentication for:",e),await h.auth.setSession({access_token:"",refresh_token:""}),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",e);const{data:g,error:d}=await h.auth.signInWithPassword({email:e,password:n});if(d){console.error("Login error:",d);let S=q(d);throw d.message&&d.message.includes("Invalid login credentials")&&(S="Invalid email or password. Please try again."),d.message&&d.message.includes("fetch")&&(S="Network error. Please check your internet connection."),new Error(S)}if(!(g!=null&&g.user))throw new Error("No user data received");if(g.session){Z(g.session.refresh_token),localStorage.setItem("supabase.auth.token",JSON.stringify(g.session));try{await T("session",JSON.stringify(g.session)),await T("email",e),await T("remember_me",!0)}catch(S){console.warn("IndexedDB storage failed, falling back to localStorage only",S)}}await new Promise(S=>setTimeout(S,1e3));const{data:k,error:y}=await h.from("users").select().eq("id",g.user.id).maybeSingle();if(y){console.error("Error fetching user profile:",y);const S={id:g.user.id,email:g.user.email,name:((l=g.user.user_metadata)==null?void 0:l.name)||((i=g.user.email)==null?void 0:i.split("@")[0])||"",role:((f=g.user.user_metadata)==null?void 0:f.role)||"user",created_at:new Date().toISOString(),last_active:new Date().toISOString()},{data:E,error:R}=await h.from("users").insert(S).select().single();if(R)throw new Error("Failed to create user profile");if(!E)throw new Error("No profile data received after creation");return W(E)}if(!k){const S={id:g.user.id,email:g.user.email,name:((u=g.user.user_metadata)==null?void 0:u.name)||((I=g.user.email)==null?void 0:I.split("@")[0])||"",role:((w=g.user.user_metadata)==null?void 0:w.role)||"user",created_at:new Date().toISOString(),last_active:new Date().toISOString()},{data:E,error:R}=await h.from("users").insert(S).select().single();if(R)throw new Error("Failed to create user profile");if(!E)throw new Error("No profile data received after creation");return W(E)}return W(k)}catch(m){console.error("Login error:",m),m.message&&console.error("Error message:",m.message),m.code&&console.error("Error code:",m.code),m.status&&console.error("Error status:",m.status),m.details&&console.error("Error details:",m.details);let _=q(m);throw m.message&&m.message.includes("Invalid login credentials")&&(_="Invalid email or password. Please try again."),m.message&&m.message.includes("fetch")&&(_="Network error. Please check your internet connection."),new Error(_)}}async function Q({email:e,password:n,name:l,phone:i,studentId:f,departmentId:u,batchId:I,sectionId:w}){try{if(!e||!n||!l)throw new Error("All fields are required");if(!u||!I||!w)throw console.error("Missing required IDs:",{departmentId:u,batchId:I,sectionId:w}),new Error("Please select your department, batch, and section before signing up");if(!(e.endsWith("@diu.edu.bd")||e.includes("@gmail.com")||e.includes("@test.com")||e==="superadmin@nesttask.com"))throw new Error("Please use a valid email address (@diu.edu.bd, or test email)");console.log("Signup data:",{email:e,name:l,phone:i,studentId:f,departmentId:u,batchId:I,sectionId:w});const{data:_,error:g}=await h.auth.signUp({email:e,password:n,options:{emailRedirectTo:window.location.origin,data:{name:l,phone:i||"",studentId:f||"",role:"user",departmentId:u,batchId:I,sectionId:w}}});if(g)throw g;if(!(_!=null&&_.user))throw new Error("Failed to create user");console.log("User created in auth, session:",_.session?"Active":"Pending confirmation"),console.log("Relying on database trigger to create profile"),await new Promise(y=>setTimeout(y,2e3));const{data:d,error:k}=await h.from("users_with_full_info").select("*").eq("id",_.user.id).single();if(k){console.error("Error fetching user data after signup:",k);const{data:y,error:S}=await h.from("users").select("*").eq("id",_.user.id).single();return S?(console.error("Second attempt failed to fetch user data:",S),{id:_.user.id,email:e,name:l,phone:i,studentId:f,role:"user",createdAt:new Date().toISOString(),departmentId:u,batchId:I,sectionId:w}):W(y)}return{id:d.id,email:d.email,name:d.name,role:d.role,phone:d.phone,studentId:d.studentId,createdAt:d.createdAt,lastActive:d.lastActive,departmentId:d.departmentId,departmentName:d.departmentName,batchId:d.batchId,batchName:d.batchName,sectionId:d.sectionId,sectionName:d.sectionName}}catch(m){throw console.error("Signup error:",m),new Error(m.message||"Failed to create account")}}async function X(){try{const e=localStorage.getItem("nesttask_refresh_interval");e&&clearInterval(parseInt(e)),window.removeEventListener("focus",K);const n=h.auth.signOut({scope:"local"}).then(({error:i})=>{i&&console.error("Supabase signOut error:",i)}),l=$().then(i=>new Promise((f,u)=>{const m=i.transaction(O,"readwrite").objectStore(O).clear();m.onsuccess=()=>{i.close(),f()},m.onerror=()=>{i.close(),u(m.error)}})).catch(i=>{console.warn("Failed to clear IndexedDB:",i)});await Promise.all([n,l])}catch(e){console.error("Logout error:",e)}}async function K(){try{const{data:e}=await h.auth.getSession();e!=null&&e.session&&await h.auth.refreshSession({refresh_token:e.session.refresh_token})}catch(e){console.error("Failed to refresh token on focus:",e)}}function Z(e){const l=setInterval(async()=>{try{const{data:i}=await h.auth.getSession();if(i!=null&&i.session){const{data:f,error:u}=await h.auth.refreshSession({refresh_token:i.session.refresh_token});if(u){console.error("Error refreshing token:",u);return}f!=null&&f.session&&(localStorage.setItem("supabase.auth.token",JSON.stringify(f.session)),await T("session",JSON.stringify(f.session)))}}catch(i){console.error("Failed to refresh token:",i)}},432e5);localStorage.setItem("nesttask_refresh_interval",l.toString()),window.addEventListener("focus",K)}function U(e){switch(e){case"admin":return"admin";case"super-admin":case"super_admin":return"super-admin";case"section-admin":case"section_admin":return"section_admin";default:return"user"}}function W(e){return console.log("Mapping DB user to User:",e),{id:e.id,email:e.email,name:e.name||e.username||e.email.split("@")[0],role:U(e.role||"user"),avatar:e.avatar,phone:e.phone,createdAt:e.created_at||new Date().toISOString(),lastActive:e.last_active,studentId:e.student_id,departmentId:e.department_id,batchId:e.batch_id,sectionId:e.section_id}}async function ee(e){try{if(!e)throw new Error("Email is required");console.log("Sending password reset email to:",e);const{error:n}=await h.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/#auth/recovery`});if(n)throw console.error("Supabase resetPasswordForEmail error:",n),n;console.log("Password reset email sent successfully")}catch(n){throw console.error("Password reset error:",n),new Error(q(n)||"Failed to send password reset email. Please try again.")}}function J(){if(P.isNativePlatform())return;const e=window.location.pathname.includes("super-admin")||sessionStorage.getItem("is_super_admin")==="true"||localStorage.getItem("is_super_admin")==="true";if(console.log("Cache cleanup called, isSuperAdmin:",e),e){console.log("Super admin detected - preserving state without cache clearing"),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PRESERVE_ADMIN_CACHES",timestamp:Date.now()});return}"caches"in window&&caches.keys().then(n=>{n.forEach(l=>{l.includes("nesttask")&&(console.log(`Clearing cache: ${l}`),caches.delete(l).then(i=>console.log(`Cache deleted: ${i}`)))})}),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(navigator.serviceWorker.controller.postMessage({type:"CLEAR_ALL_CACHES",timestamp:Date.now()}),navigator.serviceWorker.addEventListener("message",n=>{n.data&&n.data.type==="CACHES_CLEARED"&&console.log("Service worker cleared caches")},{once:!0}))}function F(e){P.isNativePlatform()||"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"AUTH_STATE_CHANGED",event:e?"SIGNED_IN":"SIGNED_OUT",timestamp:Date.now()})}const D=V("Network",{web:()=>j(()=>import("./web.Dsjlmvc0.js"),__vite__mapDeps([0,1,2])).then(e=>new e.NetworkWeb)}),M="nesttask_remember_me",L="nesttask_saved_email";function ce(){const[e,n]=b.useState(null),[l,i]=b.useState(!0),[f,u]=b.useState(null),[I,w]=b.useState(null),[m,_]=b.useState(0),[g,d]=b.useState(!0);b.useEffect(()=>{let o=!0;const a=localStorage.getItem(L);a&&w(a);const c=localStorage.getItem("nesttask_cached_user");if(c&&o)try{const s=JSON.parse(c);n(s)}catch(s){console.error("Failed to parse cached user on mount:",s)}k();const{data:{subscription:r}}=h.auth.onAuthStateChange(y);return()=>{o=!1,r.unsubscribe()}},[]);const k=async()=>{try{let o=navigator.onLine;if(P.isNativePlatform())try{o=(await D.getStatus()).connected}catch(s){console.warn("Failed to get network status, using navigator.onLine")}if(!o){console.log("Offline mode: Loading cached user data");const s=localStorage.getItem("nesttask_cached_user");if(s)try{const p=JSON.parse(s);n(p),console.log("Successfully loaded cached user:",p.email),d(!1),i(!1);return}catch(p){console.error("Failed to parse cached user:",p)}console.log("No cached user found for offline mode"),d(!1),i(!1);return}if(!await H()){console.warn("Database connection test failed");const s=localStorage.getItem("nesttask_cached_user");if(s)try{const p=JSON.parse(s);n(p),console.log("Using cached user due to connection issues"),i(!1);return}catch(p){console.error("Failed to parse cached user:",p)}}const{data:{session:c},error:r}=await h.auth.getSession();if(r){console.error("Error getting auth session:",r.message);const s=localStorage.getItem("nesttask_cached_user");if(s)try{const p=JSON.parse(s);n(p),console.log("Using cached user due to session error")}catch(p){console.error("Failed to parse cached user:",p)}i(!1);return}c!=null&&c.user?await E(c.user):(console.log("No active session found"),d(!1))}catch(o){console.error("Session check error:",o);let a=navigator.onLine;if(P.isNativePlatform())try{a=(await D.getStatus()).connected}catch(c){}if(a){if(u("Failed to check authentication status"),m<3){const c=Math.min(1e3*Math.pow(2,m),1e4);console.log(`Will retry session check in ${c}ms`),setTimeout(()=>{_(r=>r+1),k()},c);return}}else{console.log("Offline mode: Attempting to load cached user");const c=localStorage.getItem("nesttask_cached_user");if(c)try{const r=JSON.parse(c);n(r),console.log("Loaded cached user for offline use")}catch(r){console.error("Failed to parse cached user:",r)}}}finally{i(!1)}},y=async(o,a)=>{if(!(a!=null&&a.user)&&g){console.log("No session on initial load, checking if we should preserve cached user");let c=navigator.onLine;if(P.isNativePlatform())try{c=(await D.getStatus()).connected}catch(r){}if(!c&&e){console.log("Preserving cached user while offline"),d(!1),i(!1);return}}if(d(!1),a!=null&&a.user)try{await E(a.user)}catch(c){console.error("Error updating user state:",c);let r=navigator.onLine;if(P.isNativePlatform())try{r=(await D.getStatus()).connected}catch(s){}r?await S():console.log("Error updating user state while offline, keeping cached user")}else{let c=navigator.onLine;if(P.isNativePlatform())try{c=(await D.getStatus()).connected}catch(r){}c?(console.log("No session and online, clearing user"),n(null)):console.log("No session but offline, keeping cached user")}i(!1)},S=async()=>{n(null),F(!1),localStorage.removeItem("supabase.auth.token"),localStorage.removeItem("nesttask_user"),localStorage.removeItem("nesttask_cached_user"),sessionStorage.removeItem("supabase.auth.token"),localStorage.getItem(M)!=="true"&&localStorage.removeItem(L),document.cookie.split(";").forEach(function(o){document.cookie=o.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),J()},E=async o=>{var a,c,r;try{const s=B.userWithFullInfo(o.id),p=A.get(s);let t;if(p)t=p;else{const{data:C,error:x}=await h.from("users_with_full_info").select("*").eq("id",o.id).single();if(x)throw console.error("Error fetching user data:",x),x;t=C,A.set(s,t)}let N=(t==null?void 0:t.role)||((a=o.user_metadata)==null?void 0:a.role)||"user";(N==="super_admin"||N==="super-admin")&&(N="super-admin");const v={id:o.id,email:o.email,name:(t==null?void 0:t.name)||((c=o.user_metadata)==null?void 0:c.name)||((r=o.email)==null?void 0:r.split("@")[0])||"",role:N,createdAt:(t==null?void 0:t.createdAt)||o.created_at,avatar:t==null?void 0:t.avatar,phone:t==null?void 0:t.phone,studentId:t==null?void 0:t.studentId,departmentId:t==null?void 0:t.departmentId,batchId:t==null?void 0:t.batchId,sectionId:t==null?void 0:t.sectionId,departmentName:t==null?void 0:t.departmentName,batchName:t==null?void 0:t.batchName,sectionName:t==null?void 0:t.sectionName};n(v);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(v))}catch(C){console.warn("Failed to cache user data:",C)}}catch(s){throw console.error("Error updating user state:",s),s}};return{user:e,loading:l,error:f,login:async(o,a=!1)=>{try{if(u(null),a?(localStorage.setItem(M,"true"),localStorage.setItem(L,o.email)):(localStorage.removeItem(M),localStorage.removeItem(L)),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&localStorage.getItem("nesttask_demo_user"))try{const t=JSON.parse(localStorage.getItem("nesttask_demo_user")||"{}");if(t&&t.email===o.email)return console.log("Using cached demo user from localStorage:",t),n(t),F(!0),(t.role==="super-admin"||t.email==="superadmin@nesttask.com")&&(console.log("Demo super admin detected"),localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true")),t}catch(t){console.warn("Failed to parse demo user from localStorage")}const r=await Y(o);if(console.log("User after login:",r),F(!0),r.role==="super-admin"||o.email==="superadmin@nesttask.com"||r.email==="superadmin@nesttask.com"){console.log("Super admin login detected"),r.role="super-admin";const t=B.userWithFullInfo(r.id||r.email),N=A.get(t);if(N&&N.name)r.name=N.name;else try{const{data:v,error:C}=await h.from("users_with_full_info").select("*").eq("email",r.email).single();!C&&v&&(console.log("Super admin data from database:",v),v.name&&(r.name=v.name),A.set(t,v))}catch(v){console.warn("Error fetching super admin data, using default values",v)}localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true"),n(r);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(r)),console.log("Super-admin user cached after login for offline access")}catch(v){console.warn("Failed to cache super-admin user after login:",v)}return r}const{data:s,error:p}=await h.from("users").select("*").eq("id",r.id).single();p?console.error("Error fetching user data after login:",p):(console.log("User data from database after login:",s),s&&(s.role&&(r.role=s.role,console.log("Updated user role from database:",r.role)),s.department_id&&(r.departmentId=s.department_id,console.log("Updated user department ID:",r.departmentId)),s.batch_id&&(r.batchId=s.batch_id,console.log("Updated user batch ID:",r.batchId)),s.section_id&&(r.sectionId=s.section_id,console.log("Updated user section ID:",r.sectionId)),s.phone&&(r.phone=s.phone),s.student_id&&(r.studentId=s.student_id),s.avatar&&(r.avatar=s.avatar))),n(r);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(r)),console.log("User cached after login for offline access")}catch(t){console.warn("Failed to cache user after login:",t)}return J(),r}catch(c){throw u(c.message),c}},signup:async o=>{try{u(null),console.log("Starting signup process with credentials:",{...o,password:"[REDACTED]"}),o.departmentId&&console.log(`Department selected: ${o.departmentId}`),o.batchId&&console.log(`Batch selected: ${o.batchId}`),o.sectionId&&console.log(`Section selected: ${o.sectionId}`);const a=await Q(o);console.log("Signup successful, user data:",{id:a.id,email:a.email,name:a.name,role:a.role,departmentId:a.departmentId,batchId:a.batchId,sectionId:a.sectionId}),n(a);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(a)),localStorage.setItem("nesttask_user",JSON.stringify(a)),console.log("User cached after signup")}catch(c){console.warn("Failed to cache user after signup:",c)}return F(!0),a}catch(a){throw console.error("Signup error:",a),u(a.message),a}},logout:async()=>{try{console.log("Starting optimized logout..."),u(null),n(null),F(!1);const o=localStorage.getItem(M)==="true";A.clear();const a=["supabase.auth.token","nesttask_user","nesttask_cached_user","nesttask_refresh_interval","is_super_admin","auth_completed"];o||a.push(L),a.forEach(s=>localStorage.removeItem(s)),sessionStorage.removeItem("supabase.auth.token"),sessionStorage.removeItem("is_super_admin"),document.cookie.split(";").forEach(s=>{document.cookie=s.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")});const c=X(),r=J();return await Promise.all([c,r]),console.log("Logout completed"),!0}catch(o){return console.error("Logout error:",o),u(o.message),!1}},forgotPassword:async o=>{try{u(null),await ee(o)}catch(a){throw u(a.message),a}},savedEmail:I,refreshUser:async()=>{try{const{data:{session:o}}=await h.auth.getSession();if(o!=null&&o.user){const a=B.userWithFullInfo(o.user.id);A.clear(),await E(o.user)}}catch(o){console.error("Error refreshing user:",o)}}}}export{D as N,ce as u};
