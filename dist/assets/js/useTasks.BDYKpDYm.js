import{s as e,r as t,t as r}from"./index.B83KeBCs.js";import{s as a}from"./telegram.service.BTr96-Tu.js";function n(e,t){let r=null,a=!1;return()=>{r&&clearTimeout(r),a||(r=setTimeout((async()=>{a=!0;try{await e()}finally{a=!1}}),t))}}async function s(e=2e3){"undefined"!=typeof window&&await new Promise((t=>{let r=!1;const a=()=>{r||(r=!0,window.clearTimeout(s),window.removeEventListener("supabase-session-validated",n),t())},n=()=>{a()},s=window.setTimeout((()=>{a()}),e);window.addEventListener("supabase-session-validated",n,{once:!0}),window.dispatchEvent(new CustomEvent("request-session-validation"))}))}function o(){const[r,a]=t.useState([]),[o,i]=t.useState(!0),[c,d]=t.useState(null),u=t.useRef(0),l=t.useRef(!1),m=t.useCallback((async(t=!1)=>{if(l.current&&!t)return;const r=Date.now();if(t||!(r-u.current<1e4))try{l.current=!0,i(!0),d(null),await s(2500);const t=await async function(){try{const{data:{user:t}}=await e.auth.getUser();if(!t)return[];const{data:r}=await e.from("users").select("role, section_id").eq("id",t.id).single();let a=e.from("users").select("\n        id, \n        email, \n        name, \n        role, \n        created_at, \n        last_active, \n        phone,\n        student_id,\n        section_id\n      ").order("created_at",{ascending:!1});"admin"!==(null==r?void 0:r.role)&&"super-admin"!==(null==r?void 0:r.role)&&(null==r?void 0:r.section_id)&&(a=a.eq("section_id",r.section_id));const{data:n,error:s}=await a;if(s)return[];const o=(null==n?void 0:n.filter((e=>e.section_id)).map((e=>e.section_id)))||[];let i={};if(o.length>0){const{data:t,error:r}=await e.from("sections").select("id, name").in("id",o);!r&&t&&(i=t.reduce(((e,t)=>(e[t.id]=t.name,e)),{}))}return(null==n?void 0:n.map((e=>{var t;return{id:e.id,email:e.email||"",name:e.name||(null==(t=e.email)?void 0:t.split("@")[0])||"",role:e.role||"user",createdAt:e.created_at,lastActive:e.last_active,phone:e.phone||"",studentId:e.student_id||"",sectionId:e.section_id||"",sectionName:e.section_id&&i[e.section_id]||""}})))||[]}catch(c){return[]}}();a(t),u.current=Date.now()}catch(n){d(n.message)}finally{i(!1),l.current=!1}}),[]);t.useEffect((()=>{m(!0)}),[m]);const w=t.useRef();return t.useEffect((()=>{w.current=async()=>{try{const e=new Promise((e=>{const t=setTimeout((()=>e()),2e3),r=()=>{clearTimeout(t),window.removeEventListener("supabase-session-validated",r),e()};window.addEventListener("supabase-session-validated",r,{once:!0})}));window.dispatchEvent(new CustomEvent("request-session-validation")),await e,m(!0)}catch(e){m(!0)}}}),[m]),t.useEffect((()=>{const e=n((()=>{var e;null==(e=w.current)||e.call(w)}),1e3);return window.addEventListener("app-resume",e),window.addEventListener("supabase-session-refreshed",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-session-refreshed",e)}}),[]),{users:r,loading:o,error:c,refreshUsers:()=>m(!0),deleteUser:async t=>{try{d(null),await async function(t){try{const{data:{user:a}}=await e.auth.getUser();if(!a)throw new Error("Unauthorized: You must be logged in");const{data:n,error:s}=await e.from("users").select("role, section_id").eq("id",a.id).single();if(s||!n)throw new Error("Failed to get user role");const{data:o,error:i}=await e.from("users").select("section_id").eq("id",t).single();if(i)throw new Error("Failed to get target user information");if("section-admin"===(r=n.role)||"section_admin"===r){if(n.section_id!==(null==o?void 0:o.section_id))throw new Error("You can only delete users from your own section");const{error:r}=await e.rpc("delete_section_user",{user_id:t});if(r)throw new Error(r.message||"Failed to delete user")}else{if("admin"!==n.role&&"super-admin"!==n.role)throw new Error("Unauthorized: Only administrators can delete users");{const{error:r}=await e.from("users").delete().eq("id",t);if(r)throw new Error(r.message||"Failed to delete user")}}}catch(c){throw new Error(c.message||"Failed to delete user")}var r}(t),a((e=>e.filter((e=>e.id!==t))))}catch(r){throw d(r.message),await m(!0),r}},promoteUser:async(t,r)=>{try{d(null),await async function(t,r){try{const{data:{user:a}}=await e.auth.getUser();if(!a)throw new Error("Unauthorized: You must be logged in");const{data:n}=await e.from("users").select("role").eq("id",a.id).single();if("admin"!==(null==n?void 0:n.role)&&"super-admin"!==(null==n?void 0:n.role))throw new Error("Unauthorized: Only admins can promote users");const{error:s}=await e.from("users").update({role:r}).eq("id",t);if(s)throw new Error(s.message||"Failed to promote user")}catch(c){throw new Error(c.message||"Failed to promote user")}}(t,r),a((e=>e.map((e=>e.id===t?{...e,role:r}:e))))}catch(n){throw d(n.message),await m(!0),n}},demoteUser:async(t,r)=>{try{d(null),await async function(t,r){try{const{data:{user:a}}=await e.auth.getUser();if(!a)throw new Error("Unauthorized: You must be logged in");const{data:n}=await e.from("users").select("role").eq("id",a.id).single();if("admin"!==(null==n?void 0:n.role)&&"super-admin"!==(null==n?void 0:n.role))throw new Error("Unauthorized: Only admins can demote users");const{error:s}=await e.from("users").update({role:r}).eq("id",t);if(s)throw new Error(s.message||"Failed to demote user")}catch(c){throw new Error(c.message||"Failed to demote user")}}(t,r),a((e=>e.map((e=>e.id===t?{...e,role:r}:e))))}catch(n){throw d(n.message),await m(!0),n}}}}function i(e){return{id:e.id,name:e.name,category:e.category,dueDate:e.due_date,description:e.description,status:e.status,createdAt:e.created_at,isAdminTask:e.is_admin_task,sectionId:e.section_id||null,googleDriveLinks:e.google_drive_links||[],attachments:e.attachments||[]}}async function c(t){try{const r=t.name.split(".").pop(),a=`task-files/${crypto.randomUUID()}.${r}`,{error:n}=await e.storage.from("task-attachments").upload(a,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(n)throw n;const{data:{publicUrl:s}}=e.storage.from("task-attachments").getPublicUrl(a);return{url:s,originalName:t.name,path:a}}catch(r){throw r}}const d=new Map;function u(o){const[u,l]=t.useState([]),[m,w]=t.useState(!0),[f,h]=t.useState(null),[g,p]=t.useState(0),y=t.useRef(!1),v=t.useRef(0),_=t.useRef(!0),E=t.useRef(null),k=t.useRef(o),b=t.useRef(!1),T=t.useRef(!1),$=t.useRef(Date.now()),D=t.useRef(0);t.useEffect((()=>{k.current=o}),[o]),t.useEffect((()=>{const e=()=>{if("hidden"===document.visibilityState)T.current=!0,$.current=Date.now();else if("visible"===document.visibilityState){const e=Date.now()-$.current;$.current=Date.now(),e<3e4?(T.current=!0,setTimeout((()=>{T.current=!1}),1e3)):T.current=!1}};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}}),[]);const I=t.useCallback((async(t={})=>{if(!o)return;E.current&&E.current.abort(),E.current=new AbortController;const a=E.current.signal;if(t.force&&(b.current=!0,y.current=!1,_.current&&p(0)),y.current&&!t.force)return;const n=Date.now(),c=b.current?1e3:3e3;if(t.force||!(n-v.current<c))try{const t=u.length>0,n=!T.current||!t;_.current&&n&&w(!0),y.current=!0,_.current&&h(null);let o=!0;{if(await s(2500),o=await r(),!o)throw new Error("Unable to connect to database");const t=async()=>{const t=e.auth.getSession(),r=new Promise((e=>setTimeout((()=>e({data:{session:null}})),4e3)));return await Promise.race([t,r])};let{data:a}=await t();if(a.session||(await s(2500),({data:a}=await t())),!a.session)throw new Error("Session not ready - please try again")}if(a.aborted)return;const c=async()=>{const t=await(async()=>{var t,r,a,n;try{const s=14e3,o=new AbortController,c=setTimeout((()=>o.abort()),s),{data:{session:d}}=await Promise.race([e.auth.getSession(),new Promise((e=>setTimeout((()=>e({data:{session:null}})),3e3)))]),u=(null==(r=null==(t=null==d?void 0:d.user)?void 0:t.user_metadata)||r.role,null==(n=null==(a=null==d?void 0:d.user)?void 0:a.user_metadata)?void 0:n.section_id);let l=e.from("tasks").select("id,name,description,due_date,status,category,is_admin_task,user_id,section_id,created_at").abortSignal(o.signal);l=l.order("created_at",{ascending:!1});const{data:m,error:w}=await l;if(clearTimeout(c),w)throw w;const f=m.map(i);return u&&f.filter((e=>e.sectionId===u)).length,f}catch(f){if("AbortError"===f.name)throw new Error("Task fetch timed out. Please try again.");throw new Error(`Failed to fetch tasks: ${f.message}`)}})();return t},d=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Task fetch timeout"))),1e4)})),m=await Promise.race([c(),d]);_.current&&!a.aborted&&(l(m),h(null),v.current=Date.now(),p(0),b.current=!1)}catch(d){if(_.current&&(!E.current||!E.current.signal.aborted)){"Task fetch timeout"===d.message?h("Failed to refresh: Task fetch timeout after 10s. Network may be slow or server overloaded."):h(d.message||"Failed to load tasks");const e="Task fetch timeout"===d.message?2:3;if(g<e){const e=Math.floor(1e3*Math.random()),t=Math.min(1e3*Math.pow(2,g)+e,15e3);setTimeout((()=>{_.current&&p((e=>e+1))}),t)}else g>=e&&(b.current=!0)}}finally{y.current=!1,_.current&&w(!1)}}),[o,g]);t.useEffect((()=>{const e=n((async()=>{const e=Date.now();if(!(e-D.current<3e3)&&(D.current=e,k.current))try{const e=new Promise((e=>{const t=setTimeout((()=>{e()}),1e4),r=()=>{clearTimeout(t),window.removeEventListener("supabase-session-validated",r),e()};window.addEventListener("supabase-session-validated",r,{once:!0})}));window.dispatchEvent(new CustomEvent("request-session-validation")),await e,I({force:!0})}catch(t){I({force:!0})}}),1e3);return window.addEventListener("app-resume",e),window.addEventListener("supabase-session-refreshed",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-session-refreshed",e)}}),[I]),t.useEffect((()=>o?(_.current=!0,w(!0),I(),()=>{_.current=!1,E.current&&E.current.abort()}):(l([]),void w(!1))),[o,I]);const U=t.useCallback((async(e=!1)=>{try{return await I({force:e}),!0}catch(t){return!1}}),[I]);return{tasks:u,loading:m,error:f,createTask:async(t,r)=>{if(!o)throw new Error("User ID is required");y.current&&(y.current=!1);try{const n=await(async(t,r,n)=>{var s,o,d,u;try{const{data:{user:f}}=await e.auth.getUser(),v=null==(s=null==f?void 0:f.user_metadata)?void 0:s.role,_=null==(o=null==f?void 0:f.user_metadata)?void 0:o.section_id,E=r._mobileFiles,k=!!E&&E.length>0,b=!!r._isSectionAdminMobile;r._sectionId;let T=r.description;const $=[];let D=null,I=0;const U=async(t,r=6e4)=>new Promise((async(a,n)=>{const s=new AbortController,o=s.signal,i=setTimeout((()=>{s.abort(),n(new Error(`Upload timed out for file ${t.name} after ${r/1e3}s`))}),r);try{const r=async()=>{if(!t.name||0===t.size)throw new Error(`Invalid file: ${t.name||"unnamed"} (${t.size} bytes)`);if(t.size>26214400)throw new Error(`File too large: ${t.name} (${Math.round(t.size/1024/1024)}MB). Mobile file limit is 25MB.`);const r=t.name.split(".").pop(),a=`task-files/${crypto.randomUUID()}.${r}`,{error:n}=await e.storage.from("task-attachments").upload(a,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(n)throw n;const{data:{publicUrl:s}}=e.storage.from("task-attachments").getPublicUrl(a);return s},n=await r();clearTimeout(i),a(n)}catch(c){clearTimeout(i),o.aborted?n(new Error(`Upload timed out for file ${t.name}`)):n(c)}}));if(k&&E)try{const e=E.reduce(((e,t)=>e+t.size),0);if(e>104857600)throw new Error(`Total upload size too large: ${Math.round(e/1024/1024)}MB exceeds 100MB limit for mobile uploads`);for(const t of E)if(t.name&&0!==t.size)try{let e=null,r=0,a=null;for(;r<3&&!e;)try{r++;const a=Math.min(3e4+t.size/1024/10,6e4),n=await U(t,a);e={url:n,originalName:t.name,path:new URL(n).pathname.split("/").pop()||""},$.push(e),I+=t.size;break}catch(l){if(a=l instanceof Error?l:new Error(String(l)),r<3){const e=1e3*Math.pow(2,r-1);await new Promise((t=>setTimeout(t,e)))}}if(!e)throw D=a||new Error(`Failed to upload file after 3 attempts: ${t.name}`),D;const n=new RegExp(`\\[${t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\]\\(attachment:${t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`,"g"),s=`[${t.name}](${e.url})`,o=T;T=T.replace(n,s),o===T&&(T=T.replace(/\[(.*?)\]\(attachment:(.*?)\)/g,((r,a,n)=>a===t.name?`[${a}](${e.url})`:r)),o===T&&b&&(T.includes(`[${t.name}]`)||(T+=`\n[${t.name}](${e.url})`)))}catch(m){D||(D=m instanceof Error?m:new Error(String(m)));continue}if(D&&0===$.length)throw D;T=T.replace(/\n<!-- mobile-uploads -->\n/g,"")}catch(w){try{$&&$.length>0&&await Promise.allSettled($.map((async t=>{if(t.path)try{const{error:r}=await e.storage.from("task-attachments").remove([`task-files/${t.path}`])}catch(r){}})))}catch(h){}throw w}else{const e=T.match(/\[([^\]]+)\]\((blob:.*?)\)/g)||[];for(const t of e)try{const e=t.match(/\[(.*?)\]\((blob:(.*?))\)/);if(!e)continue;const[,r,a]=e;if(r&&a)try{const e=new Promise((async(e,t)=>{try{const r=await fetch(a);if(!r.ok)return void t(new Error(`Failed to fetch blob: ${r.status}`));e(await r.blob())}catch(r){t(r)}})),n=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Blob fetch timed out"))),1e4)})),s=await Promise.race([e,n]),o=new File([s],r,{type:s.type}),i=await c(o);$.push(i),T=T.replace(t,`[${r}](${i.url})`)}catch(g){}}catch(p){}}const F={name:r.name,category:r.category,due_date:r.dueDate,description:T,status:r.status,user_id:t,is_admin_task:"admin"===v||"section_admin"===v||"section-admin"===v||!1};let L,S;$.length>0&&(F.attachments=$.map((e=>e.url)),F.original_file_names=$.map((e=>e.name))),r.googleDriveLinks&&r.googleDriveLinks.length>0&&(F.google_drive_links=r.googleDriveLinks),"section_admin"!==v&&"section-admin"!==v||!_?n?F.section_id=n:_&&"user"===v&&(F.section_id=_):(F.section_id=_,T.includes("For section:")||T.includes("Section ID:")||(F.description+=`\n\nFor section: ${_}`));try{const t=await e.from("tasks").insert(F).select().single();L=t.data,S=t.error}catch(y){if(!(null==(d=y.message)?void 0:d.includes("google_drive_links"))&&!(null==(u=y.message)?void 0:u.includes("schema cache")))throw y;{const{google_drive_links:t,...r}=F,a=await e.from("tasks").insert(r).select().single();L=a.data,S=a.error}}if(S)throw new Error(`Failed to create task: ${S.message}`);if(!L)throw new Error("No data returned from task creation");const z=i(L);if(z.isAdminTask){try{await async function(e){try{const t="https://nglfbbdoyyfslzyjarqs.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbGZiYmRveXlmc2x6eWphcnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTgyMTQsImV4cCI6MjA4MzE3NDIxNH0.3sXujO3rtin57rTcHpXHi6Zfi9XJCEX3-mmcnnB8cJE",a=new Date(e.dueDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),n={taskId:e.id,title:"New Task",body:`${e.name} - Due: ${a}`,sectionId:e.sectionId||void 0,data:{category:e.category,priority:e.priority||"medium"}},s=await fetch(`${t}/functions/v1/send-fcm-push`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(n)});if(!s.ok){const e=await s.json().catch((()=>({})));throw new Error(`FCM push failed: ${JSON.stringify(e)}`)}await s.json()}catch(S){throw S}}(z)}catch(g){}await a(z)}return z}catch(f){throw new Error(`Task creation failed: ${f.message}`)}})(o,t,r);if(_.current&&(l((e=>[...e,n])),d.has(o))){const e=d.get(o);d.set(o,{tasks:[...e.tasks,n],timestamp:Date.now()})}return n}catch(n){throw n}},updateTask:async(t,r)=>{try{const a=await async function(t,r){var a,n;try{const o={};let i,c;void 0!==r.name&&(o.name=r.name),void 0!==r.category&&(o.category=r.category),void 0!==r.dueDate&&(o.due_date=r.dueDate),void 0!==r.description&&(o.description=r.description),void 0!==r.status&&(o.status=r.status),void 0!==r.sectionId&&(o.section_id=r.sectionId),void 0!==r.googleDriveLinks&&r.googleDriveLinks.length>0&&(o.google_drive_links=r.googleDriveLinks);try{const r=await e.from("tasks").update(o).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();i=r.data,c=r.error}catch(s){if(!(null==(a=s.message)?void 0:a.includes("google_drive_links"))&&!(null==(n=s.message)?void 0:n.includes("schema cache")))throw s;{const{google_drive_links:r,...a}=o,n=await e.from("tasks").update(a).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();i=n.data,c=n.error}}if(c)throw new Error("Failed to update task");if(!i)throw new Error("Task not found");return{id:i.id,name:i.name,category:i.category,dueDate:i.due_date,description:i.description,status:i.status,createdAt:i.created_at,isAdminTask:i.is_admin_task,sectionId:i.section_id}}catch(f){throw f}}(t,r);if(_.current&&(l((e=>e.map((e=>e.id===t?{...e,...a}:e)))),o&&d.has(o))){const e=d.get(o);d.set(o,{tasks:e.tasks.map((e=>e.id===t?{...e,...a}:e)),timestamp:Date.now()})}return a}catch(a){throw a}},deleteTask:async t=>{try{if(await async function(t){try{const{error:r}=await e.from("tasks").delete().eq("id",t);if(r)throw r}catch(f){throw new Error(f.message||"Failed to delete task")}}(t),_.current&&(l((e=>e.filter((e=>e.id!==t)))),o&&d.has(o))){const e=d.get(o);d.set(o,{tasks:e.tasks.filter((e=>e.id!==t)),timestamp:Date.now()})}return!0}catch(r){throw r}},refreshTasks:U}}export{u as a,o as u};
