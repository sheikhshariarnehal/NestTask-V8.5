import{s as e,f as t,r as o,t as r}from"./index.D5HgYyae.js";import{s}from"./telegram.service.BTr96-Tu.js";function n(e,t){let o=null,r=!1;return()=>{o&&clearTimeout(o),r?console.log("[EventDebounce] Handler already processing, skipping"):o=setTimeout((async()=>{r=!0;try{await e()}finally{r=!1}}),t)}}function a(){const{isSessionReady:r,isValidating:s}=t(),[a,i]=o.useState([]),[c,l]=o.useState(!0),[d,u]=o.useState(null),g=o.useRef(0),m=o.useRef(!1),f=o.useCallback((async(t=!1)=>{if(r){if(!m.current||t){if(t)console.log("[useUsers] Force refresh - bypassing throttle and cache");else if(Date.now()-g.current<1e4)return void console.log("[useUsers] Refresh throttled");try{m.current=!0,l(!0),u(null),console.log("[useUsers] Fetching users from database...");const t=await async function(){try{const{data:{user:t}}=await e.auth.getUser();if(!t)return console.warn("No authenticated user found"),[];const{data:o}=await e.from("users").select("role, section_id").eq("id",t.id).single();let r=e.from("users").select("\n        id, \n        email, \n        name, \n        role, \n        created_at, \n        last_active, \n        phone,\n        student_id,\n        section_id\n      ").order("created_at",{ascending:!1});"admin"!==(null==o?void 0:o.role)&&"super-admin"!==(null==o?void 0:o.role)&&(null==o?void 0:o.section_id)&&(r=r.eq("section_id",o.section_id));const{data:s,error:n}=await r;if(n)return console.error("Error fetching users:",n),[];const a=(null==s?void 0:s.filter((e=>e.section_id)).map((e=>e.section_id)))||[];let i={};if(a.length>0){const{data:t,error:o}=await e.from("sections").select("id, name").in("id",a);!o&&t&&(i=t.reduce(((e,t)=>(e[t.id]=t.name,e)),{}))}return(null==s?void 0:s.map((e=>{var t;return{id:e.id,email:e.email||"",name:e.name||(null==(t=e.email)?void 0:t.split("@")[0])||"",role:e.role||"user",createdAt:e.created_at,lastActive:e.last_active,phone:e.phone||"",studentId:e.student_id||"",sectionId:e.section_id||"",sectionName:e.section_id&&i[e.section_id]||""}})))||[]}catch(d){return console.error("Error fetching users:",d),[]}}();i(t),g.current=Date.now(),console.log(`[useUsers] Successfully loaded ${t.length} users`)}catch(o){console.error("[useUsers] Failed to load users:",o),u(o.message)}finally{l(!1),m.current=!1}}}else console.log("[useUsers] Session not ready, waiting for validation...")}),[r]);o.useEffect((()=>{r&&(console.log("[useUsers] Session ready, starting initial load"),f(!0))}),[f,r]);const h=o.useRef();return o.useEffect((()=>{h.current=async()=>{console.log("[useUsers] Resume detected, validating session first...");try{const e=new Promise((e=>{const t=setTimeout((()=>e()),2e3),o=()=>{clearTimeout(t),window.removeEventListener("supabase-session-validated",o),e()};window.addEventListener("supabase-session-validated",o,{once:!0})}));window.dispatchEvent(new CustomEvent("request-session-validation")),await e,console.log("[useUsers] Session validated, refreshing users"),f(!0)}catch(e){console.error("[useUsers] Session validation failed:",e),f(!0)}}}),[f]),o.useEffect((()=>{const e=n((()=>{var e;null==(e=h.current)||e.call(h)}),1e3);return window.addEventListener("app-resume",e),window.addEventListener("supabase-session-refreshed",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-session-refreshed",e)}}),[]),{users:a,loading:c||s,error:d,refreshUsers:()=>f(!0),deleteUser:async t=>{try{u(null),await async function(t){try{const{data:{user:r}}=await e.auth.getUser();if(!r)throw new Error("Unauthorized: You must be logged in");const{data:s,error:n}=await e.from("users").select("role, section_id").eq("id",r.id).single();if(n||!s)throw console.error("Error fetching user role:",n),new Error("Failed to get user role");const{data:a,error:i}=await e.from("users").select("section_id").eq("id",t).single();if(i)throw console.error("Error fetching target user:",i),new Error("Failed to get target user information");if("section-admin"===(o=s.role)||"section_admin"===o){if(s.section_id!==(null==a?void 0:a.section_id))throw new Error("You can only delete users from your own section");console.log("Attempting to delete user as section admin:",{userId:t,adminSection:s.section_id,targetSection:null==a?void 0:a.section_id});const{error:o}=await e.rpc("delete_section_user",{user_id:t});if(o)throw console.error("Error deleting user as section admin:",o),new Error(o.message||"Failed to delete user")}else{if("admin"!==s.role&&"super-admin"!==s.role)throw new Error("Unauthorized: Only administrators can delete users");{const{error:o}=await e.from("users").delete().eq("id",t);if(o)throw console.error("Error deleting user as admin:",o),new Error(o.message||"Failed to delete user")}}}catch(d){throw console.error("Error deleting user:",d),new Error(d.message||"Failed to delete user")}var o}(t),i((e=>e.filter((e=>e.id!==t))))}catch(o){throw u(o.message),await f(!0),o}},promoteUser:async(t,o)=>{try{u(null),await async function(t,o){try{const{data:{user:r}}=await e.auth.getUser();if(!r)throw new Error("Unauthorized: You must be logged in");const{data:s}=await e.from("users").select("role").eq("id",r.id).single();if("admin"!==(null==s?void 0:s.role)&&"super-admin"!==(null==s?void 0:s.role))throw new Error("Unauthorized: Only admins can promote users");const{error:n}=await e.from("users").update({role:o}).eq("id",t);if(n)throw console.error("Error promoting user:",n),new Error(n.message||"Failed to promote user")}catch(d){throw console.error("Error promoting user:",d),new Error(d.message||"Failed to promote user")}}(t,o),i((e=>e.map((e=>e.id===t?{...e,role:o}:e))))}catch(r){throw u(r.message),await f(!0),r}},demoteUser:async(t,o)=>{try{u(null),await async function(t,o){try{const{data:{user:r}}=await e.auth.getUser();if(!r)throw new Error("Unauthorized: You must be logged in");const{data:s}=await e.from("users").select("role").eq("id",r.id).single();if("admin"!==(null==s?void 0:s.role)&&"super-admin"!==(null==s?void 0:s.role))throw new Error("Unauthorized: Only admins can demote users");const{error:n}=await e.from("users").update({role:o}).eq("id",t);if(n)throw console.error("Error demoting user:",n),new Error(n.message||"Failed to demote user")}catch(d){throw console.error("Error demoting user:",d),new Error(d.message||"Failed to demote user")}}(t,o),i((e=>e.map((e=>e.id===t?{...e,role:o}:e))))}catch(r){throw u(r.message),await f(!0),r}}}}function i(e){return{id:e.id,name:e.name,category:e.category,dueDate:e.due_date,description:e.description,status:e.status,createdAt:e.created_at,isAdminTask:e.is_admin_task,sectionId:e.section_id||null,googleDriveLinks:e.google_drive_links||[],attachments:e.attachments||[]}}async function c(t){try{const o=t.name.split(".").pop(),r=`task-files/${crypto.randomUUID()}.${o}`,{error:s}=await e.storage.from("task-attachments").upload(r,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(s)throw s;const{data:{publicUrl:n}}=e.storage.from("task-attachments").getPublicUrl(r);return{url:n,originalName:t.name,path:r}}catch(o){throw console.error("Error uploading file:",o),o}}const l=new Map;function d(a){const{isSessionReady:d,isValidating:u}=t(),[g,m]=o.useState([]),[f,h]=o.useState(!0),[w,p]=o.useState(null),[y,k]=o.useState(0),v=o.useRef(!1),b=o.useRef(0),E=o.useRef(!0),_=o.useRef(null),D=o.useRef(a),$=o.useRef(!1),T=o.useRef(!1),S=o.useRef(Date.now()),F=o.useRef(0);o.useEffect((()=>{D.current=a}),[a]),o.useEffect((()=>{const e=()=>{if("hidden"===document.visibilityState)T.current=!0,S.current=Date.now();else if("visible"===document.visibilityState){const e=Date.now()-S.current;S.current=Date.now(),v.current&&(console.log("[useTasks] Resetting stuck loading state after visibility change"),v.current=!1,E.current&&h(!1)),e<3e4?(T.current=!0,setTimeout((()=>{T.current=!1}),1e3)):T.current=!1}};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}}),[]);const U=o.useCallback((async(t={})=>{if(!d)return void console.log("[useTasks] Session not ready, waiting for validation...");if(!a)return;_.current&&_.current.abort(),_.current=new AbortController;const o=_.current.signal;if(t.force&&(console.log("[useTasks] Force refresh - clearing cache"),l.delete(a),$.current=!0,v.current=!1,E.current&&k(0)),v.current&&!t.force)return void console.log("[useTasks] Loading already in progress, skipping");const s=Date.now(),n=$.current?1e3:3e3;if(!t.force&&s-b.current<n)console.log("Task loading throttled - too soon since last load");else try{const t=g.length>0,s=!T.current||!t;E.current&&s&&h(!0),v.current=!0,E.current&&p(null);let n=!0;{const{data:{user:t}}=await e.auth.getUser();if(n=await r(),!n)throw new Error("Unable to connect to database");const{data:o}=await e.auth.getSession();if(!o.session)throw console.log("No session found during task fetch, skipping reload"),new Error("Session expired - please refresh the page")}if(o.aborted)return void console.log("Task loading aborted");const a=async()=>{const t=await(async()=>{var t,o;try{const r=8e3,s=new AbortController,n=setTimeout((()=>s.abort()),r),{data:{user:a}}=await e.auth.getUser(),c=(null==(t=null==a?void 0:a.user_metadata)||t.role,null==(o=null==a?void 0:a.user_metadata)?void 0:o.section_id);let l=e.from("tasks").select("id,name,description,due_date,status,category,is_admin_task,user_id,section_id,created_at");l=l.order("created_at",{ascending:!1});const{data:d,error:u}=await l;if(clearTimeout(n),u)throw console.error("Error fetching tasks:",u),u;const g=d.map(i);if(c){const e=g.filter((e=>e.sectionId===c));console.log(`[Debug] Found ${e.length} section tasks with sectionId: ${c}`),e.length>0&&console.log("[Debug] Section task IDs:",e.map((e=>e.id)))}return g}catch(w){if("AbortError"===w.name)throw console.error("Task fetch timed out"),new Error("Task fetch timed out. Please try again.");throw console.error("Error in fetchTasks:",w),new Error(`Failed to fetch tasks: ${w.message}`)}})();return t},c=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Task fetch timeout"))),45e3)})),l=await Promise.race([a(),c]);E.current&&!o.aborted&&(m(l),p(null),b.current=Date.now(),k(0),$.current=!1)}catch(c){if(E.current&&(!_.current||!_.current.signal.aborted)){console.error("Error fetching tasks:",c),"Task fetch timeout"===c.message?p("Failed to refresh: Task fetch timeout after 45s. Network may be slow or server overloaded."):p(c.message||"Failed to load tasks");const e="Task fetch timeout"===c.message?5:3;if(y<e){const t=Math.floor(1e3*Math.random()),o=Math.min(1e3*Math.pow(2,y)+t,15e3);console.log(`Retrying task fetch in ${o}ms (attempt ${y+1}/${e})`),setTimeout((()=>{E.current&&k((e=>e+1))}),o)}else y>=e&&($.current=!0,console.warn(`Maximum retries (${e}) reached for task fetching. Will force refresh next time.`))}}finally{v.current=!1,E.current&&h(!1)}}),[a,y,d]);o.useEffect((()=>{const e=n((async()=>{const e=Date.now();if(e-F.current<3e3)console.log("[useTasks] Resume refresh throttled");else if(F.current=e,D.current){console.log("[useTasks] Resume detected, validating session first...");try{const e=new Promise((e=>{const t=setTimeout((()=>{console.log("[useTasks] Session validation timeout, proceeding anyway"),e()}),2e3),o=()=>{clearTimeout(t),window.removeEventListener("supabase-session-validated",o),console.log("[useTasks] Session validation complete"),e()};window.addEventListener("supabase-session-validated",o,{once:!0})}));window.dispatchEvent(new CustomEvent("request-session-validation")),await e,console.log("[useTasks] Session validated, now fetching tasks"),U({force:!0})}catch(t){console.error("[useTasks] Session validation failed:",t),U({force:!0})}}}),1e3);return window.addEventListener("app-resume",e),window.addEventListener("supabase-session-refreshed",e),window.addEventListener("session-ready",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-session-refreshed",e),window.removeEventListener("session-ready",e)}}),[U]),o.useEffect((()=>a?(E.current=!0,d?(console.log("[useTasks] Session ready, starting initial load for user:",a),h(!0),U(),()=>{E.current=!1,_.current&&_.current.abort()}):(console.log("[useTasks] Waiting for session ready before initial load..."),void h(!0))):(m([]),void h(!1))),[a,U,d]);const M=o.useCallback((async(e=!1)=>{try{return await U({force:e}),!0}catch(t){return console.error("[useTasks] Refresh failed:",t),!1}}),[U]);return{tasks:g,loading:f||u,error:w,createTask:async(t,o)=>{if(!a)throw new Error("User ID is required");v.current&&(console.log("[useTasks] Resetting stuck loading state before task creation"),v.current=!1);try{const r=await(async(t,o,r)=>{var n,a,l,d;try{console.log("[Debug] Creating task with data:",{userId:t,task:o,sectionId:r,hasMobileFiles:!!o._mobileFiles,isSectionAdminMobile:!!o._isSectionAdminMobile});const{data:{user:w}}=await e.auth.getUser(),k=null==(n=null==w?void 0:w.user_metadata)?void 0:n.role,v=null==(a=null==w?void 0:w.user_metadata)?void 0:a.section_id;console.log("[Debug] User role and section when creating task:",{userRole:k,userSectionId:v});const b=o._mobileFiles,E=!!b&&b.length>0,_=!!o._isSectionAdminMobile,D=o._sectionId||r;E&&(console.log("[Debug] Processing mobile file upload with",b.length,"files"),_&&console.log("[Debug] This is a section admin mobile upload with section ID:",D));let $=o.description;const T=[];let S=null,F=0;const U=async(t,o=6e4)=>new Promise((async(r,s)=>{const n=new AbortController,a=n.signal,i=setTimeout((()=>{n.abort(),s(new Error(`Upload timed out for file ${t.name} after ${o/1e3}s`))}),o);try{const o=async()=>{if(!t.name||0===t.size)throw new Error(`Invalid file: ${t.name||"unnamed"} (${t.size} bytes)`);if(t.size>26214400)throw new Error(`File too large: ${t.name} (${Math.round(t.size/1024/1024)}MB). Mobile file limit is 25MB.`);const o=t.name.split(".").pop(),r=`task-files/${crypto.randomUUID()}.${o}`;console.log(`[Debug] Starting upload for ${t.name} (${Math.round(t.size/1024)}KB) to ${r}`);const{error:s}=await e.storage.from("task-attachments").upload(r,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(s)throw s;const{data:{publicUrl:n}}=e.storage.from("task-attachments").getPublicUrl(r);return console.log(`[Debug] Successfully uploaded ${t.name} to ${r} (${n.slice(-20)})`),n},s=await o();clearTimeout(i),r(s)}catch(c){clearTimeout(i),a.aborted?s(new Error(`Upload timed out for file ${t.name}`)):s(c)}}));if(E&&b)try{console.log("[Debug] Uploading mobile files",b.map((e=>({name:e.name,size:e.size}))));const e=b.reduce(((e,t)=>e+t.size),0);if(console.log(`[Debug] Total mobile upload size: ${Math.round(e/1024/1024)}MB`),e>104857600)throw new Error(`Total upload size too large: ${Math.round(e/1024/1024)}MB exceeds 100MB limit for mobile uploads`);for(const t of b)if(t.name&&0!==t.size)try{console.log(`[Debug] Uploading mobile file: ${t.name} (${Math.round(t.size/1024)}KB)`);let e=null,o=0,r=null;for(;o<3&&!e;)try{o++;const r=Math.min(3e4+t.size/1024/10,6e4),s=await U(t,r);e={url:s,originalName:t.name,path:new URL(s).pathname.split("/").pop()||""},T.push(e),F+=t.size;break}catch(u){if(console.error(`[Error] Failed to upload mobile file (attempt ${o}/3):`,t.name,u),r=u instanceof Error?u:new Error(String(u)),o<3){const e=1e3*Math.pow(2,o-1);await new Promise((t=>setTimeout(t,e)))}}if(!e)throw S=r||new Error(`Failed to upload file after 3 attempts: ${t.name}`),S;const s=new RegExp(`\\[${t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\]\\(attachment:${t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`,"g"),n=`[${t.name}](${e.url})`,a=$;$=$.replace(s,n),a===$&&(console.warn("[Warning] Failed to find exact attachment reference, trying general pattern"),$=$.replace(/\[(.*?)\]\(attachment:(.*?)\)/g,((o,r,s)=>r===t.name?`[${r}](${e.url})`:o)),a===$&&_&&(console.log("[Debug] Using fallback for section admin mobile file:",t.name),$.includes(`[${t.name}]`)||($+=`\n[${t.name}](${e.url})`))),console.log("[Debug] Replaced attachment reference with permanent URL")}catch(g){console.error("[Error] Failed to upload mobile file:",t.name,g),S||(S=g instanceof Error?g:new Error(String(g)));continue}else console.warn("[Warning] Skipping invalid file",t);if(S&&0===T.length)throw S;S&&console.warn("[Warning] Some files failed to upload, but continuing with successful uploads",{successful:T.length,failed:b.length-T.length}),console.log(`[Debug] Successfully uploaded ${T.length}/${b.length} files, total size: ${Math.round(F/1024/1024)}MB`),$=$.replace(/\n<!-- mobile-uploads -->\n/g,"")}catch(m){console.error("[Error] Mobile file upload process failed:",m);try{T&&T.length>0&&(console.log(`[Debug] Cleaning up ${T.length} uploaded files after error`),await Promise.allSettled(T.map((async t=>{if(t.path)try{const{error:o}=await e.storage.from("task-attachments").remove([`task-files/${t.path}`]);o?console.error(`[Error] Failed to clean up file ${t.path}:`,o):console.log(`[Debug] Successfully cleaned up file: ${t.path}`)}catch(o){console.error(`[Error] Error during file cleanup for ${t.path}:`,o)}}))))}catch(f){console.error("[Error] Failed during cleanup after upload error:",f)}throw m}else{const e=$.match(/\[([^\]]+)\]\((blob:.*?)\)/g)||[];console.log("[Debug] Found file matches in description:",e);for(const t of e)try{const e=t.match(/\[(.*?)\]\((blob:(.*?))\)/);if(!e)continue;const[,o,r]=e;if(console.log("[Debug] Processing file match:",{match:t,fileName:o,blobUrl:r}),o&&r)try{const e=new Promise((async(e,t)=>{try{console.log("[Debug] Fetching blob URL:",r);const o=await fetch(r);if(!o.ok)return void t(new Error(`Failed to fetch blob: ${o.status}`));e(await o.blob())}catch(o){t(o)}})),s=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Blob fetch timed out"))),1e4)})),n=await Promise.race([e,s]),a=new File([n],o,{type:n.type}),i=await c(a);T.push(i),$=$.replace(t,`[${o}](${i.url})`),console.log("[Debug] Uploaded file and replaced URL with:",i.url)}catch(h){console.error("[Error] Processing file failed:",{fileName:o,error:h})}}catch(p){console.error("[Error] Invalid file match format:",{match:t,error:p})}}const M={name:o.name,category:o.category,due_date:o.dueDate,description:$,status:o.status,user_id:t,is_admin_task:"admin"===k||"section_admin"===k||"section-admin"===k||!1};let I,C;T.length>0&&(M.attachments=T.map((e=>e.url)),M.original_file_names=T.map((e=>e.name)),console.log("[Debug] Added attachments to task:",{count:T.length,files:T.map((e=>({name:e.name,url:e.url.slice(-30)})))})),o.googleDriveLinks&&o.googleDriveLinks.length>0&&(M.google_drive_links=o.googleDriveLinks),"section_admin"!==k&&"section-admin"!==k||!v?r?(M.section_id=r,console.log("[Debug] Using provided section_id:",r)):v&&"user"===k&&(M.section_id=v,console.log("[Debug] Regular user creating task for their section:",v)):(M.section_id=v,console.log("[Debug] Section admin creating task for section:",v),$.includes("For section:")||$.includes("Section ID:")||(M.description+=`\n\nFor section: ${v}`)),console.log("[Debug] Final task insert data:",M);try{const t=await e.from("tasks").insert(M).select().single();I=t.data,C=t.error}catch(y){if(!(null==(l=y.message)?void 0:l.includes("google_drive_links"))&&!(null==(d=y.message)?void 0:d.includes("schema cache")))throw y;{console.log("[Debug] Google Drive links column not found, retrying without it...");const{google_drive_links:t,...o}=M,r=await e.from("tasks").insert(o).select().single();I=r.data,C=r.error}}if(C)throw console.error("Error creating task:",C),new Error(`Failed to create task: ${C.message}`);if(!I)throw new Error("No data returned from task creation");console.log("[Debug] Successfully created task with ID:",I.id);const R=i(I);if(R.isAdminTask){console.log("[FCM] Task is admin task, sending notifications...");try{await async function(e){try{const t="https://nglfbbdoyyfslzyjarqs.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbGZiYmRveXlmc2x6eWphcnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTgyMTQsImV4cCI6MjA4MzE3NDIxNH0.3sXujO3rtin57rTcHpXHi6Zfi9XJCEX3-mmcnnB8cJE";console.log("[FCM] Sending push notification for task:",e.id),console.log("[FCM] Supabase URL:",t?"Set":"Missing"),console.log("[FCM] Supabase Anon Key:",o?"Set":"Missing");const r=new Date(e.dueDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),s={taskId:e.id,title:"New Task",body:`${e.name} - Due: ${r}`,sectionId:e.sectionId||void 0,data:{category:e.category,priority:e.priority||"medium"}};console.log("[FCM] Calling edge function with payload:",JSON.stringify(s));const n=await fetch(`${t}/functions/v1/send-fcm-push`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(s)});if(console.log("[FCM] Edge function response status:",n.status),!n.ok){const e=await n.json().catch((()=>({})));throw console.error("[FCM] Push notification failed:",e),new Error(`FCM push failed: ${JSON.stringify(e)}`)}const a=await n.json();console.log(`[FCM] Push notification sent: ${a.sent}/${a.total} devices`,a)}catch(C){throw console.error("[FCM] Error sending FCM push notification:",C),C}}(R),console.log("[FCM] Push notification sent successfully")}catch(h){console.error("[FCM] Failed to send push notification:",h)}await s(R)}else console.log("[FCM] Task is not admin task, skipping push notification");return R}catch(w){throw console.error("Error in createTask:",w),new Error(`Task creation failed: ${w.message}`)}})(a,t,o);if(E.current&&(m((e=>[...e,r])),l.has(a))){const e=l.get(a);l.set(a,{tasks:[...e.tasks,r],timestamp:Date.now()})}return r}catch(r){throw console.error("Error creating task:",r),r}},updateTask:async(t,o)=>{try{const r=await async function(t,o){var r,s;try{const a={};let i,c;void 0!==o.name&&(a.name=o.name),void 0!==o.category&&(a.category=o.category),void 0!==o.dueDate&&(a.due_date=o.dueDate),void 0!==o.description&&(a.description=o.description),void 0!==o.status&&(a.status=o.status),void 0!==o.sectionId&&(a.section_id=o.sectionId),void 0!==o.googleDriveLinks&&o.googleDriveLinks.length>0&&(a.google_drive_links=o.googleDriveLinks);try{const o=await e.from("tasks").update(a).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();i=o.data,c=o.error}catch(n){if(!(null==(r=n.message)?void 0:r.includes("google_drive_links"))&&!(null==(s=n.message)?void 0:s.includes("schema cache")))throw n;{console.log("Google Drive links column not found, retrying update without it...");const{google_drive_links:o,...r}=a,s=await e.from("tasks").update(r).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();i=s.data,c=s.error}}if(c)throw console.error("Database error:",c),new Error("Failed to update task");if(!i)throw new Error("Task not found");return{id:i.id,name:i.name,category:i.category,dueDate:i.due_date,description:i.description,status:i.status,createdAt:i.created_at,isAdminTask:i.is_admin_task,sectionId:i.section_id}}catch(w){throw console.error("Error updating task:",w),w}}(t,o);if(E.current&&(m((e=>e.map((e=>e.id===t?{...e,...r}:e)))),a&&l.has(a))){const e=l.get(a);l.set(a,{tasks:e.tasks.map((e=>e.id===t?{...e,...r}:e)),timestamp:Date.now()})}return r}catch(r){throw console.error("Error updating task:",r),r}},deleteTask:async t=>{try{if(await async function(t){try{const{error:o}=await e.from("tasks").delete().eq("id",t);if(o)throw o}catch(w){throw console.error("Error deleting task:",w),new Error(w.message||"Failed to delete task")}}(t),E.current&&(m((e=>e.filter((e=>e.id!==t)))),a&&l.has(a))){const e=l.get(a);l.set(a,{tasks:e.tasks.filter((e=>e.id!==t)),timestamp:Date.now()})}return!0}catch(o){throw console.error("Error deleting task:",o),o}},refreshTasks:M}}export{d as a,a as u};
