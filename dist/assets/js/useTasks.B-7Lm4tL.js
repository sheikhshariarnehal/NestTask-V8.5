import{s as g,r as h,t as J}from"./index.D6B7_sTU.js";import{s as W}from"./telegram.service.B5vX6-Oo.js";async function X(){try{const{data:{user:t}}=await g.auth.getUser();if(!t)return console.warn("No authenticated user found"),[];const{data:e}=await g.from("users").select("role, section_id").eq("id",t.id).single();let i=g.from("users").select(`
        id, 
        email, 
        name, 
        role, 
        created_at, 
        last_active, 
        phone,
        student_id,
        section_id
      `).order("created_at",{ascending:!1});(e==null?void 0:e.role)!=="admin"&&(e==null?void 0:e.role)!=="super-admin"&&(e!=null&&e.section_id)&&(i=i.eq("section_id",e.section_id));const{data:l,error:n}=await i;if(n)return console.error("Error fetching users:",n),[];const u=(l==null?void 0:l.filter(o=>o.section_id).map(o=>o.section_id))||[];let y={};if(u.length>0){const{data:o,error:w}=await g.from("sections").select("id, name").in("id",u);!w&&o&&(y=o.reduce((m,b)=>(m[b.id]=b.name,m),{}))}return(l==null?void 0:l.map(o=>{var w;return{id:o.id,email:o.email||"",name:o.name||((w=o.email)==null?void 0:w.split("@")[0])||"",role:o.role||"user",createdAt:o.created_at,lastActive:o.last_active,phone:o.phone||"",studentId:o.student_id||"",sectionId:o.section_id||"",sectionName:o.section_id&&y[o.section_id]||""}}))||[]}catch(t){return console.error("Error fetching users:",t),[]}}async function H(t){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("Unauthorized: You must be logged in");const{data:i,error:l}=await g.from("users").select("role, section_id").eq("id",e.id).single();if(l||!i)throw console.error("Error fetching user role:",l),new Error("Failed to get user role");const{data:n,error:u}=await g.from("users").select("section_id").eq("id",t).single();if(u)throw console.error("Error fetching target user:",u),new Error("Failed to get target user information");if((o=>o==="section-admin"||o==="section_admin")(i.role)){if(i.section_id!==(n==null?void 0:n.section_id))throw new Error("You can only delete users from your own section");console.log("Attempting to delete user as section admin:",{userId:t,adminSection:i.section_id,targetSection:n==null?void 0:n.section_id});const{error:o}=await g.rpc("delete_section_user",{user_id:t});if(o)throw console.error("Error deleting user as section admin:",o),new Error(o.message||"Failed to delete user")}else if(i.role==="admin"||i.role==="super-admin"){const{error:o}=await g.from("users").delete().eq("id",t);if(o)throw console.error("Error deleting user as admin:",o),new Error(o.message||"Failed to delete user")}else throw new Error("Unauthorized: Only administrators can delete users")}catch(e){throw console.error("Error deleting user:",e),new Error(e.message||"Failed to delete user")}}async function Y(t,e){try{const{data:{user:i}}=await g.auth.getUser();if(!i)throw new Error("Unauthorized: You must be logged in");const{data:l}=await g.from("users").select("role").eq("id",i.id).single();if((l==null?void 0:l.role)!=="admin"&&(l==null?void 0:l.role)!=="super-admin")throw new Error("Unauthorized: Only admins can promote users");const{error:n}=await g.from("users").update({role:e}).eq("id",t);if(n)throw console.error("Error promoting user:",n),new Error(n.message||"Failed to promote user")}catch(i){throw console.error("Error promoting user:",i),new Error(i.message||"Failed to promote user")}}async function G(t,e){try{const{data:{user:i}}=await g.auth.getUser();if(!i)throw new Error("Unauthorized: You must be logged in");const{data:l}=await g.from("users").select("role").eq("id",i.id).single();if((l==null?void 0:l.role)!=="admin"&&(l==null?void 0:l.role)!=="super-admin")throw new Error("Unauthorized: Only admins can demote users");const{error:n}=await g.from("users").update({role:e}).eq("id",t);if(n)throw console.error("Error demoting user:",n),new Error(n.message||"Failed to demote user")}catch(i){throw console.error("Error demoting user:",i),new Error(i.message||"Failed to demote user")}}function I(t,e){let i=null,l=!1;return()=>{if(i&&clearTimeout(i),l){console.log("[EventDebounce] Handler already processing, skipping");return}i=setTimeout(async()=>{l=!0;try{await t()}finally{l=!1}},e)}}function ne(){const[t,e]=h.useState([]),[i,l]=h.useState(!0),[n,u]=h.useState(null),y=h.useRef(0),o=h.useRef(!1),w=h.useCallback(async(E=!1)=>{if(!(o.current&&!E)){if(E)console.log("[useUsers] Force refresh - bypassing throttle and cache");else if(Date.now()-y.current<1e4){console.log("[useUsers] Refresh throttled");return}try{o.current=!0,l(!0),u(null),console.log("[useUsers] Fetching users from database...");const a=await X();e(a),y.current=Date.now(),console.log(`[useUsers] Successfully loaded ${a.length} users`)}catch(a){console.error("[useUsers] Failed to load users:",a),u(a.message)}finally{l(!1),o.current=!1}}},[]);h.useEffect(()=>{w(!0)},[w]);const m=h.useRef();return h.useEffect(()=>{m.current=async()=>{console.log("[useUsers] Resume detected, validating session first...");try{const E=new Promise(a=>{const d=setTimeout(()=>a(),2e3),k=()=>{clearTimeout(d),window.removeEventListener("supabase-session-validated",k),a()};window.addEventListener("supabase-session-validated",k,{once:!0})});window.dispatchEvent(new CustomEvent("request-session-validation")),await E,console.log("[useUsers] Session validated, refreshing users"),w(!0)}catch(E){console.error("[useUsers] Session validation failed:",E),w(!0)}}},[w]),h.useEffect(()=>{const a=I(()=>{var d;(d=m.current)==null||d.call(m)},1e3);return window.addEventListener("app-resume",a),window.addEventListener("supabase-session-refreshed",a),()=>{window.removeEventListener("app-resume",a),window.removeEventListener("supabase-session-refreshed",a)}},[]),{users:t,loading:i,error:n,refreshUsers:()=>w(!0),deleteUser:async E=>{try{u(null),await H(E),e(a=>a.filter(d=>d.id!==E))}catch(a){throw u(a.message),await w(!0),a}},promoteUser:async(E,a)=>{try{u(null),await Y(E,a),e(d=>d.map(k=>k.id===E?{...k,role:a}:k))}catch(d){throw u(d.message),await w(!0),d}},demoteUser:async(E,a)=>{try{u(null),await G(E,a),e(d=>d.map(k=>k.id===E?{...k,role:a}:k))}catch(d){throw u(d.message),await w(!0),d}}}}function B(t){return{id:t.id,name:t.name,category:t.category,dueDate:t.due_date,description:t.description,status:t.status,createdAt:t.created_at,isAdminTask:t.is_admin_task,sectionId:t.section_id||null,googleDriveLinks:t.google_drive_links||[],attachments:t.attachments||[]}}const V=async(t,e)=>{var i,l;try{const n=8e3,u=new AbortController,y=setTimeout(()=>u.abort(),n),{data:{user:o}}=await g.auth.getUser(),w=(i=o==null?void 0:o.user_metadata)==null?void 0:i.role,m=e||((l=o==null?void 0:o.user_metadata)==null?void 0:l.section_id);let b=g.from("tasks").select("id,name,description,due_date,status,category,is_admin_task,user_id,section_id,created_at");b=b.order("created_at",{ascending:!1});const{data:_,error:v}=await b;if(clearTimeout(y),v)throw console.error("Error fetching tasks:",v),v;const E=_.map(B);if(m){const a=E.filter(d=>d.sectionId===m);console.log(`[Debug] Found ${a.length} section tasks with sectionId: ${m}`),a.length>0&&console.log("[Debug] Section task IDs:",a.map(d=>d.id))}return E}catch(n){throw n.name==="AbortError"?(console.error("Task fetch timed out"),new Error("Task fetch timed out. Please try again.")):(console.error("Error in fetchTasks:",n),new Error(`Failed to fetch tasks: ${n.message}`))}};async function j(t){try{const e=t.name.split(".").pop(),l=`task-files/${`${crypto.randomUUID()}.${e}`}`,{error:n}=await g.storage.from("task-attachments").upload(l,t,{contentType:t.type,cacheControl:"3600",upsert:!1});if(n)throw n;const{data:{publicUrl:u}}=g.storage.from("task-attachments").getPublicUrl(l);return{url:u,originalName:t.name,path:l}}catch(e){throw console.error("Error uploading file:",e),e}}const K=async(t,e,i)=>{var l,n,u,y;try{console.log("[Debug] Creating task with data:",{userId:t,task:e,sectionId:i,hasMobileFiles:!!e._mobileFiles,isSectionAdminMobile:!!e._isSectionAdminMobile});const{data:{user:o}}=await g.auth.getUser(),w=(l=o==null?void 0:o.user_metadata)==null?void 0:l.role,m=(n=o==null?void 0:o.user_metadata)==null?void 0:n.section_id;console.log("[Debug] User role and section when creating task:",{userRole:w,userSectionId:m});const b=e._mobileFiles,_=!!b&&b.length>0,v=!!e._isSectionAdminMobile,E=e._sectionId||i;_&&(console.log("[Debug] Processing mobile file upload with",b.length,"files"),v&&console.log("[Debug] This is a section admin mobile upload with section ID:",E));let a=e.description;const d=[];let k=null,q=0;const C=async(s,r=6e4)=>new Promise(async(c,f)=>{const p=new AbortController,T=p.signal,R=setTimeout(()=>{p.abort(),f(new Error(`Upload timed out for file ${s.name} after ${r/1e3}s`))},r);try{const D=await(async()=>{if(!s.name||s.size===0)throw new Error(`Invalid file: ${s.name||"unnamed"} (${s.size} bytes)`);if(s.size>26214400)throw new Error(`File too large: ${s.name} (${Math.round(s.size/1024/1024)}MB). Mobile file limit is 25MB.`);const $=s.name.split(".").pop(),U=`task-files/${`${crypto.randomUUID()}.${$}`}`;console.log(`[Debug] Starting upload for ${s.name} (${Math.round(s.size/1024)}KB) to ${U}`);const{error:P}=await g.storage.from("task-attachments").upload(U,s,{contentType:s.type,cacheControl:"3600",upsert:!1});if(P)throw P;const{data:{publicUrl:O}}=g.storage.from("task-attachments").getPublicUrl(U);return console.log(`[Debug] Successfully uploaded ${s.name} to ${U} (${O.slice(-20)})`),O})();clearTimeout(R),c(D)}catch(S){clearTimeout(R),T.aborted?f(new Error(`Upload timed out for file ${s.name}`)):f(S)}});if(_&&b)try{console.log("[Debug] Uploading mobile files",b.map(r=>({name:r.name,size:r.size})));const s=b.reduce((r,c)=>r+c.size,0);if(console.log(`[Debug] Total mobile upload size: ${Math.round(s/1024/1024)}MB`),s>100*1024*1024)throw new Error(`Total upload size too large: ${Math.round(s/1024/1024)}MB exceeds 100MB limit for mobile uploads`);for(const r of b){if(!r.name||r.size===0){console.warn("[Warning] Skipping invalid file",r);continue}try{console.log(`[Debug] Uploading mobile file: ${r.name} (${Math.round(r.size/1024)}KB)`);let c=null,f=0,p=null;for(;f<3&&!c;)try{f++;const D=Math.min(3e4+r.size/1024/10,6e4),$=await C(r,D);c={url:$,originalName:r.name,path:new URL($).pathname.split("/").pop()||""},d.push(c),q+=r.size;break}catch(D){if(console.error(`[Error] Failed to upload mobile file (attempt ${f}/3):`,r.name,D),p=D instanceof Error?D:new Error(String(D)),f<3){const $=1e3*Math.pow(2,f-1);await new Promise(L=>setTimeout(L,$))}}if(!c)throw k=p||new Error(`Failed to upload file after 3 attempts: ${r.name}`),k;const T=new RegExp(`\\[${r.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\]\\(attachment:${r.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`,"g"),R=`[${r.name}](${c.url})`,S=a;a=a.replace(T,R),S===a&&(console.warn("[Warning] Failed to find exact attachment reference, trying general pattern"),a=a.replace(/\[(.*?)\]\(attachment:(.*?)\)/g,(D,$,L)=>$===r.name?`[${$}](${c.url})`:D),S===a&&v&&(console.log("[Debug] Using fallback for section admin mobile file:",r.name),a.includes(`[${r.name}]`)||(a+=`
[${r.name}](${c.url})`))),console.log("[Debug] Replaced attachment reference with permanent URL")}catch(c){console.error("[Error] Failed to upload mobile file:",r.name,c),k||(k=c instanceof Error?c:new Error(String(c)));continue}}if(k&&d.length===0)throw k;k&&console.warn("[Warning] Some files failed to upload, but continuing with successful uploads",{successful:d.length,failed:b.length-d.length}),console.log(`[Debug] Successfully uploaded ${d.length}/${b.length} files, total size: ${Math.round(q/1024/1024)}MB`),a=a.replace(/\n<!-- mobile-uploads -->\n/g,"")}catch(s){console.error("[Error] Mobile file upload process failed:",s);try{d&&d.length>0&&(console.log(`[Debug] Cleaning up ${d.length} uploaded files after error`),await Promise.allSettled(d.map(async r=>{if(r.path)try{const{error:c}=await g.storage.from("task-attachments").remove([`task-files/${r.path}`]);c?console.error(`[Error] Failed to clean up file ${r.path}:`,c):console.log(`[Debug] Successfully cleaned up file: ${r.path}`)}catch(c){console.error(`[Error] Error during file cleanup for ${r.path}:`,c)}})))}catch(r){console.error("[Error] Failed during cleanup after upload error:",r)}throw s}else{const s=a.match(/\[([^\]]+)\]\((blob:.*?)\)/g)||[];console.log("[Debug] Found file matches in description:",s);for(const r of s)try{const c=r.match(/\[(.*?)\]\((blob:(.*?))\)/);if(!c)continue;const[,f,p]=c;if(console.log("[Debug] Processing file match:",{match:r,fileName:f,blobUrl:p}),f&&p)try{const T=new Promise(async(L,U)=>{try{console.log("[Debug] Fetching blob URL:",p);const P=await fetch(p);if(!P.ok){U(new Error(`Failed to fetch blob: ${P.status}`));return}const O=await P.blob();L(O)}catch(P){U(P)}}),R=new Promise((L,U)=>{setTimeout(()=>U(new Error("Blob fetch timed out")),1e4)}),S=await Promise.race([T,R]),D=new File([S],f,{type:S.type}),$=await j(D);d.push($),a=a.replace(r,`[${f}](${$.url})`),console.log("[Debug] Uploaded file and replaced URL with:",$.url)}catch(T){console.error("[Error] Processing file failed:",{fileName:f,error:T})}}catch(c){console.error("[Error] Invalid file match format:",{match:r,error:c})}}const F={name:e.name,category:e.category,due_date:e.dueDate,description:a,status:e.status,user_id:t,is_admin_task:w==="admin"||w==="section_admin"||w==="section-admin"||!1};d.length>0&&(F.attachments=d.map(s=>s.url),F.original_file_names=d.map(s=>s.name),console.log("[Debug] Added attachments to task:",{count:d.length,files:d.map(s=>({name:s.name,url:s.url.slice(-30)}))})),e.googleDriveLinks&&e.googleDriveLinks.length>0&&(F.google_drive_links=e.googleDriveLinks),(w==="section_admin"||w==="section-admin")&&m?(F.section_id=m,console.log("[Debug] Section admin creating task for section:",m),!a.includes("For section:")&&!a.includes("Section ID:")&&(F.description+=`

For section: ${m}`)):i?(F.section_id=i,console.log("[Debug] Using provided section_id:",i)):m&&w==="user"&&(F.section_id=m,console.log("[Debug] Regular user creating task for their section:",m)),console.log("[Debug] Final task insert data:",F);let z,A;try{const s=await g.from("tasks").insert(F).select().single();z=s.data,A=s.error}catch(s){if((u=s.message)!=null&&u.includes("google_drive_links")||(y=s.message)!=null&&y.includes("schema cache")){console.log("[Debug] Google Drive links column not found, retrying without it...");const{google_drive_links:r,...c}=F,f=await g.from("tasks").insert(c).select().single();z=f.data,A=f.error}else throw s}if(A)throw console.error("Error creating task:",A),new Error(`Failed to create task: ${A.message}`);if(!z)throw new Error("No data returned from task creation");console.log("[Debug] Successfully created task with ID:",z.id);const N=B(z);if(N.isAdminTask){console.log("[FCM] Task is admin task, sending notifications...");try{await ee(N),console.log("[FCM] Push notification sent successfully")}catch(s){console.error("[FCM] Failed to send push notification:",s)}await W(N)}else console.log("[FCM] Task is not admin task, skipping push notification");return N}catch(o){throw console.error("Error in createTask:",o),new Error(`Task creation failed: ${o.message}`)}};async function Z(t,e){var i,l;try{const n={};e.name!==void 0&&(n.name=e.name),e.category!==void 0&&(n.category=e.category),e.dueDate!==void 0&&(n.due_date=e.dueDate),e.description!==void 0&&(n.description=e.description),e.status!==void 0&&(n.status=e.status),e.sectionId!==void 0&&(n.section_id=e.sectionId),e.googleDriveLinks!==void 0&&e.googleDriveLinks.length>0&&(n.google_drive_links=e.googleDriveLinks);let u,y;try{const o=await g.from("tasks").update(n).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();u=o.data,y=o.error}catch(o){if((i=o.message)!=null&&i.includes("google_drive_links")||(l=o.message)!=null&&l.includes("schema cache")){console.log("Google Drive links column not found, retrying update without it...");const{google_drive_links:w,...m}=n,b=await g.from("tasks").update(m).eq("id",t).select("id, name, category, due_date, description, status, created_at, is_admin_task, section_id").single();u=b.data,y=b.error}else throw o}if(y)throw console.error("Database error:",y),new Error("Failed to update task");if(!u)throw new Error("Task not found");return{id:u.id,name:u.name,category:u.category,dueDate:u.due_date,description:u.description,status:u.status,createdAt:u.created_at,isAdminTask:u.is_admin_task,sectionId:u.section_id}}catch(n){throw console.error("Error updating task:",n),n}}async function Q(t){try{const{error:e}=await g.from("tasks").delete().eq("id",t);if(e)throw e}catch(e){throw console.error("Error deleting task:",e),new Error(e.message||"Failed to delete task")}}async function ee(t){try{const e="https://nglfbbdoyyfslzyjarqs.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbGZiYmRveXlmc2x6eWphcnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTgyMTQsImV4cCI6MjA4MzE3NDIxNH0.3sXujO3rtin57rTcHpXHi6Zfi9XJCEX3-mmcnnB8cJE";console.log("[FCM] Sending push notification for task:",t.id),console.log("[FCM] Supabase URL:",e?"Set":"Missing"),console.log("[FCM] Supabase Anon Key:",i?"Set":"Missing");const l=new Date(t.dueDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),n={taskId:t.id,title:"New Task",body:`${t.name} - Due: ${l}`,sectionId:t.sectionId||void 0,data:{category:t.category,priority:t.priority||"medium"}};console.log("[FCM] Calling edge function with payload:",JSON.stringify(n));const u=await fetch(`${e}/functions/v1/send-fcm-push`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(n)});if(console.log("[FCM] Edge function response status:",u.status),!u.ok){const o=await u.json().catch(()=>({}));throw console.error("[FCM] Push notification failed:",o),new Error(`FCM push failed: ${JSON.stringify(o)}`)}const y=await u.json();console.log(`[FCM] Push notification sent: ${y.sent}/${y.total} devices`,y)}catch(e){throw console.error("[FCM] Error sending FCM push notification:",e),e}}const x=45e3,M=new Map,te=5,oe=3;function ae(t){const[e,i]=h.useState([]),[l,n]=h.useState(!0),[u,y]=h.useState(null),[o,w]=h.useState(0),m=h.useRef(!1),b=h.useRef(0),_=h.useRef(!0),v=h.useRef(null),E=h.useRef(t),a=h.useRef(!1),d=h.useRef(!1),k=h.useRef(Date.now()),q=h.useRef(0);h.useEffect(()=>{E.current=t},[t]),h.useEffect(()=>{const s=()=>{if(document.visibilityState==="hidden")d.current=!0,k.current=Date.now();else if(document.visibilityState==="visible"){const r=Date.now()-k.current;k.current=Date.now(),m.current&&(console.log("[useTasks] Resetting stuck loading state after visibility change"),m.current=!1,_.current&&n(!1)),r<3e4?(d.current=!0,setTimeout(()=>{d.current=!1},1e3)):d.current=!1}};return document.addEventListener("visibilitychange",s),()=>{document.removeEventListener("visibilitychange",s)}},[]);const C=h.useCallback(async(s={})=>{if(!t)return;v.current&&v.current.abort(),v.current=new AbortController;const r=v.current.signal;if(s.force&&(console.log("[useTasks] Force refresh - clearing cache"),M.delete(t),a.current=!0,m.current=!1,_.current&&w(0)),m.current&&!s.force){console.log("[useTasks] Loading already in progress, skipping");return}const c=Date.now(),f=a.current?1e3:3e3;if(!s.force&&c-b.current<f){console.log("Task loading throttled - too soon since last load");return}try{const p=e.length>0,T=!d.current||!p;_.current&&T&&n(!0),m.current=!0,_.current&&y(null);let R=!0;{const{data:{user:L}}=await g.auth.getUser();if(R=await J(),!R)throw new Error("Unable to connect to database");const{data:U}=await g.auth.getSession();if(!U.session)throw console.log("No session found during task fetch, skipping reload"),new Error("Session expired - please refresh the page")}if(r.aborted){console.log("Task loading aborted");return}const S=async()=>await V(t,void 0),D=new Promise((L,U)=>{setTimeout(()=>U(new Error("Task fetch timeout")),x)}),$=await Promise.race([S(),D]);_.current&&!r.aborted&&(i($),y(null),b.current=Date.now(),w(0),a.current=!1)}catch(p){if(_.current&&(!v.current||!v.current.signal.aborted)){console.error("Error fetching tasks:",p),p.message==="Task fetch timeout"?y(`Failed to refresh: Task fetch timeout after ${x/1e3}s. Network may be slow or server overloaded.`):y(p.message||"Failed to load tasks");const T=p.message==="Task fetch timeout"?te:oe;if(o<T){const R=Math.floor(Math.random()*1e3),S=Math.min(1e3*Math.pow(2,o)+R,15e3);console.log(`Retrying task fetch in ${S}ms (attempt ${o+1}/${T})`),setTimeout(()=>{_.current&&w(D=>D+1)},S)}else o>=T&&(a.current=!0,console.warn(`Maximum retries (${T}) reached for task fetching. Will force refresh next time.`))}}finally{m.current=!1,_.current&&n(!1)}},[t,o]);h.useEffect(()=>{const r=I(async()=>{const c=Date.now();if(c-q.current<3e3){console.log("[useTasks] Resume refresh throttled");return}if(q.current=c,!!E.current){console.log("[useTasks] Resume detected, validating session first...");try{const f=new Promise(p=>{const T=setTimeout(()=>{console.log("[useTasks] Session validation timeout, proceeding anyway"),p()},2e3),R=()=>{clearTimeout(T),window.removeEventListener("supabase-session-validated",R),console.log("[useTasks] Session validation complete"),p()};window.addEventListener("supabase-session-validated",R,{once:!0})});window.dispatchEvent(new CustomEvent("request-session-validation")),await f,console.log("[useTasks] Session validated, now fetching tasks"),C({force:!0})}catch(f){console.error("[useTasks] Session validation failed:",f),C({force:!0})}}},1e3);return window.addEventListener("app-resume",r),window.addEventListener("supabase-session-refreshed",r),()=>{window.removeEventListener("app-resume",r),window.removeEventListener("supabase-session-refreshed",r)}},[C]),h.useEffect(()=>{if(!t){i([]),n(!1);return}return _.current=!0,n(!0),C(),()=>{_.current=!1,v.current&&v.current.abort()}},[t,C]);const F=async(s,r)=>{if(!t)throw new Error("User ID is required");m.current&&(console.log("[useTasks] Resetting stuck loading state before task creation"),m.current=!1);try{const c=await K(t,s,r);if(_.current&&(i(f=>[...f,c]),M.has(t))){const f=M.get(t);M.set(t,{tasks:[...f.tasks,c],timestamp:Date.now()})}return c}catch(c){throw console.error("Error creating task:",c),c}},z=async(s,r)=>{try{const c=await Z(s,r);if(_.current&&(i(f=>f.map(p=>p.id===s?{...p,...c}:p)),t&&M.has(t))){const f=M.get(t);M.set(t,{tasks:f.tasks.map(p=>p.id===s?{...p,...c}:p),timestamp:Date.now()})}return c}catch(c){throw console.error("Error updating task:",c),c}},A=async s=>{try{if(await Q(s),_.current&&(i(r=>r.filter(c=>c.id!==s)),t&&M.has(t))){const r=M.get(t);M.set(t,{tasks:r.tasks.filter(c=>c.id!==s),timestamp:Date.now()})}return!0}catch(r){throw console.error("Error deleting task:",r),r}},N=h.useCallback(async(s=!1)=>{try{return await C({force:s}),!0}catch(r){return console.error("[useTasks] Refresh failed:",r),!1}},[C]);return{tasks:e,loading:l,error:u,createTask:F,updateTask:z,deleteTask:A,refreshTasks:N}}export{ae as a,ne as u};
