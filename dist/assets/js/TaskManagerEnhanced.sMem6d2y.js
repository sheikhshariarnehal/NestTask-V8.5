import{s as e,r as t,d as a,j as r,R as s}from"./index.D5HgYyae.js";import{d as l,c as n}from"./dataCache.jSzv44up.js";import{X as i}from"./x.T9mnuWR1.js";import{A as d}from"./alert-circle.CQKj6s3K.js";import{R as o}from"./refresh-cw.CHATMbGT.js";import{U as c}from"./upload.9KbqQAm-.js";import{F as x}from"./file-text.DSlNaGRz.js";import{T as m}from"./trash-2.BqyRYTpe.js";import{L as g}from"./link.BW2TzQyJ.js";import{C as u}from"./calendar.DuEmmdvM.js";import{E as h}from"./eye.CdqVfnmX.js";import{P as p}from"./pen.vWE_zFfb.js";import{C as b}from"./chevron-up.BHl-PrSC.js";import{C as y}from"./chevron-down.DkmtW88p.js";import{M as f,H as k}from"./message-square.C0yt4thK.js";import{S as j}from"./send.Db-Xwmwb.js";import{C as v}from"./check-circle-2.FY7KOIHK.js";import{C as w}from"./clock.B25PmJRC.js";import{U as N}from"./user.DbKNDHVL.js";import{U as C}from"./users.28Zp3XK7.js";import{T as D}from"./tag.BBEq3Fec.js";import{D as S}from"./download.RjYYxeRK.js";import{S as E}from"./search.CIutKDVd.js";import{F as T}from"./filter.CkQ8bkvn.js";import{C as _}from"./check-square.B23TFc9X.js";import{P as F}from"./plus.D47O1wvq.js";import"./createLucideIcon.CgqYSU6F.js";class I{static async execute(e,t="Operation",a){var r,s;let l=null;for(let i=0;i<=2;i++)try{if(null==a?void 0:a.aborted)throw new Error("Operation cancelled");const{data:r,error:s}=await e();if(s)throw new Error(s.message||`${t} failed`);if(null===r)throw new Error(`${t}: No data returned`);return r}catch(n){if(l=n,"Operation cancelled"===n.message||(null==a?void 0:a.aborted))throw new Error("Operation cancelled");if((null==(r=n.message)?void 0:r.includes("JWT"))||(null==(s=n.message)?void 0:s.includes("session")))throw new Error("Session expired. Please refresh the page.");if(i<2){await new Promise((e=>setTimeout(e,1e3)));continue}}throw l||new Error(`${t} failed`)}static async executeVoid(e,t="Operation"){var a,r;let s=null;for(let n=0;n<=2;n++)try{const{error:a}=await e();if(a)throw new Error(a.message||`${t} failed`);return}catch(l){if(s=l,(null==(a=l.message)?void 0:a.includes("JWT"))||(null==(r=l.message)?void 0:r.includes("session")))throw new Error("Session expired. Please refresh the page.");if(n<2){await new Promise((e=>setTimeout(e,1e3)));continue}}throw s||new Error(`${t} failed`)}}function L(e,t){if(!t)return e;const a=e;return"function"==typeof(null==a?void 0:a.abortSignal)?a.abortSignal(t):e}async function $(t,a){var r,s;const{page:l,pageSize:n,filters:i,sort:d,sectionId:o,abortSignal:c}=a,x=(l-1)*n,m=x+n-1;let g=e.from("tasks").select("*",{count:"exact"});if(o&&(g=g.eq("section_id",o)),i.search&&(g=g.or(`name.ilike.%${i.search}%,description.ilike.%${i.search}%`)),i.category&&"all"!==i.category&&(g=g.eq("category",i.category)),i.status&&"all"!==i.status&&(g=g.eq("status",i.status)),i.priority&&"all"!==i.priority&&(g=g.eq("priority",i.priority)),i.assignedTo&&(g=g.eq("assigned_to",i.assignedTo)),i.tags&&i.tags.length>0&&(g=g.contains("tags",i.tags)),(null==(r=i.dateRange)?void 0:r.start)&&(g=g.gte("due_date",i.dateRange.start)),(null==(s=i.dateRange)?void 0:s.end)&&(g=g.lte("due_date",i.dateRange.end)),i.overdue){const e=(new Date).toISOString().split("T")[0];g=g.lt("due_date",e).neq("status","completed")}if(d){const e="dueDate"===d.field?"due_date":"createdAt"===d.field?"created_at":d.field;g=g.order(e,{ascending:"asc"===d.direction})}else g=g.order("created_at",{ascending:!1});g=g.range(x,m);const u=L(g,c),{data:h,error:p,count:b}=await u;if(p)throw new Error(`Failed to fetch tasks: ${p.message}`);return{tasks:(h||[]).map(M),total:b||0,page:l,pageSize:n,hasMore:!!b&&b>m+1}}async function z(t,a,r){const s={};return void 0!==a.name&&(s.name=a.name),void 0!==a.description&&(s.description=a.description),void 0!==a.category&&(s.category=a.category),void 0!==a.dueDate&&(s.due_date=a.dueDate),void 0!==a.status&&(s.status=a.status,"completed"===a.status&&(s.completed_at=(new Date).toISOString())),void 0!==a.priority&&(s.priority=a.priority),void 0!==a.tags&&(s.tags=a.tags),void 0!==a.assignedTo&&(s.assigned_to=a.assignedTo),void 0!==a.attachments&&(s.attachments=a.attachments),void 0!==a.googleDriveLinks&&(s.google_drive_links=a.googleDriveLinks),M(await I.execute((()=>L(e.from("tasks").update(s).eq("id",t).select("*").single(),r)),"Update task"))}async function A(t){await I.executeVoid((()=>e.from("tasks").delete().eq("id",t)),"Delete task")}function M(e){return{id:e.id,name:e.name,category:e.category,dueDate:e.due_date,description:e.description,status:e.status,createdAt:e.created_at,updatedAt:e.updated_at,isAdminTask:e.is_admin_task||!1,sectionId:e.section_id,departmentId:e.department_id,batchId:e.batch_id,priority:e.priority||"medium",tags:e.tags||[],assignedTo:e.assigned_to,assignedBy:e.assigned_by,completedAt:e.completed_at,completedBy:e.completed_by,attachments:e.attachments||[],googleDriveLinks:e.google_drive_links||[],isTemplate:e.is_template||!1,templateName:e.template_name,userId:e.user_id,assignedToUser:e.assignedToUser,assignedByUser:e.assignedByUser,section:e.section,department:e.department,batch:e.batch}}function U(e){return{id:e.id,taskId:e.task_id,userId:e.user_id,comment:e.comment,createdAt:e.created_at,updatedAt:e.updated_at,isEdited:e.is_edited||!1,user:e.user}}function O(e){return{id:e.id,taskId:e.task_id,userId:e.user_id,action:e.action,fieldName:e.field_name,oldValue:e.old_value,newValue:e.new_value,metadata:e.metadata,createdAt:e.created_at,user:e.user}}const P=t.memo((({userId:s,sectionId:l,task:n,onClose:u,onTaskCreated:h,onTaskUpdated:p})=>{var b,y;const f=!!n,k=t.useRef(!0),j=t.useRef(),v=t.useRef(!1),[w,N]=t.useState({name:(null==n?void 0:n.name)||"",description:(null==n?void 0:n.description)||"",category:(null==n?void 0:n.category)||"assignment",dueDate:(null==n?void 0:n.dueDate)||"",priority:(null==n?void 0:n.priority)||"medium",googleDriveLinks:(null==(b=null==n?void 0:n.googleDriveLinks)?void 0:b.join("\n"))||""}),[C,D]=t.useState(!1),[S,E]=t.useState(!1),[T,_]=t.useState(null),[F,$]=t.useState({}),[A,U]=t.useState((null==(y=null==n?void 0:n.attachments)?void 0:y.map((e=>{var t;return{url:e,name:(null==(t=e.split("/").pop())?void 0:t.split("_").slice(0,-2).join("_"))||"file",size:0}})))||[]),O=t.useRef(null),P=t.useRef(null);t.useEffect((()=>(k.current=!0,E(!1),D(!1),()=>{k.current=!1,j.current&&j.current.abort()})),[]),t.useEffect((()=>{v.current=S}),[S]),t.useEffect((()=>{const e=()=>{"visible"===document.visibilityState&&S&&P.current&&Date.now()-P.current>2e4&&(console.warn("[TaskEnhancedForm] Resetting stuck saving state after visibility change"),E(!1),_("Operation may have timed out. Please try again."),j.current&&j.current.abort())};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}}),[S]),t.useEffect((()=>{const e=()=>{var e;v.current&&P.current&&Date.now()-P.current>2e4&&(console.warn("[TaskEnhancedForm] Resetting stuck saving state after app resume"),E(!1),_("Operation may have timed out. Please try again."),null==(e=j.current)||e.abort())};return window.addEventListener("app-resume",e),window.addEventListener("supabase-resume",e),window.addEventListener("supabase-session-refreshed",e),()=>{window.removeEventListener("app-resume",e),window.removeEventListener("supabase-resume",e),window.removeEventListener("supabase-session-refreshed",e)}}),[]),t.useEffect((()=>{P.current=S?Date.now():null}),[S]);const R=t.useCallback((e=>{U((t=>t.filter(((t,a)=>a!==e))))}),[]),q=e=>{if(0===e)return"Unknown size";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]},B=t.useCallback((async t=>{if(t.preventDefault(),S)return void console.log("[TaskEnhancedForm] Already saving, ignoring submit");E(!0),_(null),P.current=Date.now(),j.current=new AbortController;const a=3e4,r=setTimeout((()=>{var e;if(!k.current)return;if(!v.current)return;const t=P.current;(t?Date.now()-t:a)>=a&&(console.warn("[TaskEnhancedForm] Safety timeout triggered - resetting saving state"),null==(e=j.current)||e.abort(),E(!1),_("Request timed out. Please try again."))}),a);try{const t=w.googleDriveLinks.split("\n").map((e=>e.trim())).filter(Boolean);if(f){const e={name:w.name,description:w.description,category:w.category,dueDate:w.dueDate,priority:w.priority,attachments:A.map((e=>e.url)),googleDriveLinks:t},a=await z(n.id,e,j.current.signal);clearTimeout(r),k.current&&(null==p||p(a),u())}else{const a={name:w.name,description:w.description,category:w.category,dueDate:w.dueDate,priority:w.priority,status:"in-progress",sectionId:l,attachments:A.map((e=>e.url)),googleDriveLinks:t},n=await async function(t,a,r,s){const l={name:a.name,description:a.description,category:a.category,due_date:a.dueDate,priority:a.priority||"medium",tags:a.tags||[],assigned_to:a.assignedTo||null,assigned_by:a.assignedTo?t:null,section_id:r||a.sectionId||null,attachments:a.attachments||[],google_drive_links:a.googleDriveLinks||[],status:a.status||"pending",user_id:t,is_admin_task:!!r,is_template:!1},n=M(await I.execute((()=>L(e.from("tasks").insert(l).select("*").single(),s)),"Create task",s));return n.isAdminTask&&async function(e){try{const t="https://nglfbbdoyyfslzyjarqs.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nbGZiYmRveXlmc2x6eWphcnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTgyMTQsImV4cCI6MjA4MzE3NDIxNH0.3sXujO3rtin57rTcHpXHi6Zfi9XJCEX3-mmcnnB8cJE";console.log("[FCM Enhanced] Sending push notification for task:",e.id),console.log("[FCM Enhanced] Supabase URL:",t?"Set":"Missing"),console.log("[FCM Enhanced] Supabase Anon Key:",a?"Set":"Missing");const r=new Date(e.dueDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),s={presentation:"ðŸ“Š",assignment:"ðŸ“",quiz:"â“","lab-report":"ðŸ”¬","lab-final":"ðŸ§ª","lab-performance":"âš—ï¸",task:"âœ“",documents:"ðŸ“„",blc:"ðŸ“š",groups:"ðŸ‘¥",project:"ðŸš€",midterm:"ðŸ“–","final-exam":"ðŸŽ“",others:"ðŸ“Œ"},l=e.category.split("-").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "),n=s[e.category]||"ðŸ“Œ",i={taskId:e.id,title:`${n} New ${l}`,body:`${e.name}\nðŸ“… Due: ${r}`,sectionId:e.sectionId||void 0,data:{taskId:e.id,category:e.category,categoryName:l,priority:e.priority||"medium",dueDate:e.dueDate,taskName:e.name}};console.log("[FCM Enhanced] Calling edge function with payload:",JSON.stringify(i));const d=await fetch(`${t}/functions/v1/send-fcm-push`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(i)});if(console.log("[FCM Enhanced] Edge function response status:",d.status),!d.ok){const e=await d.json().catch((()=>({})));throw console.error("[FCM Enhanced] Push notification failed:",e),new Error(`FCM push failed: ${JSON.stringify(e)}`)}const o=await d.json();console.log("[FCM Enhanced] Push notification result:",o)}catch(T){throw console.error("[FCM Enhanced] Error sending push notification:",T),T}}(n).catch((()=>{})),n}(s,a,l,j.current.signal);clearTimeout(r),k.current&&(E(!1),null==h||h(n),u())}}catch(i){if(clearTimeout(r),"Operation cancelled"===(null==i?void 0:i.message))return void console.log("[TaskEnhancedForm] Operation was cancelled");if(console.error("[TaskEnhancedForm] Error saving task:",i),k.current){const e=(null==i?void 0:i.message)||"Failed to save task. Please try again.";_(e),E(!1)}}}),[S,w,f,n,A,s,l,h,p,u]);return a.createPortal(r.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-2 sm:p-4 animate-in fade-in duration-200",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-xl border border-gray-200 dark:border-gray-700 flex flex-col",children:[r.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-4 py-2.5 sm:py-3 border-b border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 shrink-0",children:[r.jsx("div",{children:r.jsx("h2",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-white",children:f?"Edit Task":"Create New Task"})}),r.jsx("button",{onClick:u,disabled:S,className:"p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-200","aria-label":"Close form",children:r.jsx(i,{className:"w-4 h-4"})})]}),T&&r.jsxs("div",{className:"mx-3 sm:mx-4 mt-2 p-2.5 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md flex items-start gap-2 shrink-0",children:[r.jsx(d,{className:"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-xs font-medium text-red-700 dark:text-red-300",children:T}),r.jsxs("button",{type:"button",onClick:()=>_(null),className:"mt-1 text-xs text-red-600 dark:text-red-400 hover:underline flex items-center gap-1 font-medium",children:[r.jsx(o,{className:"w-3 h-3"}),"Dismiss and try again"]})]})]}),r.jsx("div",{className:"overflow-y-auto flex-1 admin-scrollbar",children:r.jsxs("form",{onSubmit:B,className:"p-3 sm:p-4 space-y-3",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:["Task Name ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("input",{type:"text",required:!0,value:w.name,onChange:e=>N({...w,name:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:border-blue-500 dark:focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 transition-all outline-none shadow-sm placeholder:text-gray-400",placeholder:"Enter a clear and concise task name"})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:["Category ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("div",{className:"relative",children:[r.jsxs("select",{required:!0,value:w.category,onChange:e=>N({...w,category:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:border-blue-500 dark:focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 transition-all outline-none shadow-sm appearance-none",children:[r.jsx("option",{value:"assignment",children:"ðŸ“ Assignment"}),r.jsx("option",{value:"quiz",children:"â“ Quiz"}),r.jsx("option",{value:"presentation",children:"ðŸŽ¯ Presentation"}),r.jsx("option",{value:"project",children:"ðŸ› ï¸ Project"}),r.jsx("option",{value:"lab-report",children:"ðŸ”¬ Lab Report"}),r.jsx("option",{value:"lab-final",children:"ðŸ† Lab Final"}),r.jsx("option",{value:"lab-performance",children:"ðŸ“ˆ Lab Performance"}),r.jsx("option",{value:"task",children:"âœ”ï¸ Task"}),r.jsx("option",{value:"documents",children:"ðŸ“„ Documents"}),r.jsx("option",{value:"blc",children:"ðŸ“š BLC"}),r.jsx("option",{value:"groups",children:"ðŸ‘¥ Groups"}),r.jsx("option",{value:"midterm",children:"ðŸ“Š Midterm"}),r.jsx("option",{value:"final-exam",children:"ðŸŽ“ Final Exam"}),r.jsx("option",{value:"others",children:"ðŸ”¹ Others"})]}),r.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500",children:r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})})]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:["Priority ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("div",{className:"relative",children:[r.jsxs("select",{required:!0,value:w.priority,onChange:e=>N({...w,priority:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:border-blue-500 dark:focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 transition-all outline-none shadow-sm appearance-none",children:[r.jsx("option",{value:"low",children:"ðŸŸ¢ Low Priority"}),r.jsx("option",{value:"medium",children:"ðŸ”µ Medium Priority"}),r.jsx("option",{value:"high",children:"ðŸŸ  High Priority"}),r.jsx("option",{value:"urgent",children:"ðŸ”´ Urgent Priority"})]}),r.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500",children:r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})})]})]}),r.jsxs("div",{className:"sm:col-span-2 lg:col-span-1",children:[r.jsxs("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:["Due Date ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("input",{type:"date",required:!0,value:w.dueDate,onChange:e=>N({...w,dueDate:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:border-blue-500 dark:focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 transition-all outline-none shadow-sm"})]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:["Description ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("textarea",{required:!0,value:w.description,onChange:e=>N({...w,description:e.target.value}),rows:3,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:border-blue-500 dark:focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 transition-all outline-none shadow-sm resize-none placeholder:text-gray-400",placeholder:"Provide detailed information about the task..."})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("span",{className:"flex items-center gap-1.5",children:[r.jsx(c,{className:"w-3.5 h-3.5"}),"Attachments"]}),r.jsx("span",{className:"text-xs text-gray-500 font-normal",children:"Max 10 files, 50MB each"})]})}),r.jsxs("div",{className:"relative group",children:[r.jsx("input",{ref:O,type:"file",multiple:!0,onChange:async t=>{const a=t.target.files;if(!a||0===a.length)return;const r=A.length+a.length;if(r>10)return void _(`Maximum 10 files allowed. You're trying to upload ${r} files.`);D(!0),_(null);const s={};try{const t=Array.from(a).map((async t=>{const a=`${t.name}-${Date.now()}`;s[a]=0,$({...s});try{const r=await async function(t,a,r){var s;const l=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt","csv","jpg","jpeg","png","gif","svg","zip","rar","7z","mp4","mp3","wav"];if(t.size>52428800)throw new Error(`File size exceeds 50MB limit. Your file: ${(t.size/1024/1024).toFixed(2)}MB`);const n=null==(s=t.name.split(".").pop())?void 0:s.toLowerCase();if(!n||!l.includes(n))throw new Error(`File type .${n} is not allowed. Allowed types: ${l.join(", ")}`);const i=Date.now();var d;const o=`${(d=t.name).substring(0,d.lastIndexOf(".")).replace(/[^a-zA-Z0-9._-]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")||"file"}_${i}_${Math.random().toString(36).substring(2,8)}.${n}`,c=a?`tasks/${a}/${o}`:`temp/${o}`;try{const{data:a,error:s}=await e.storage.from("task-attachments").upload(c,t,{cacheControl:"3600",upsert:!1});if(s){if(s.message.includes("already exists"))throw new Error("A file with this name already exists. Please rename and try again.");throw new Error(`Upload failed: ${s.message}`)}const{data:l}=e.storage.from("task-attachments").getPublicUrl(a.path);return r&&r(100),{url:l.publicUrl,name:t.name,size:t.size}}catch(T){throw new Error(T.message||"Failed to upload file. Please try again.")}}(t,null==n?void 0:n.id,(e=>{k.current&&(s[a]=e,$({...s}))}));return r}catch(r){throw new Error(`${t.name}: ${r.message}`)}})),r=await Promise.all(t);k.current&&(U((e=>[...e,...r])),$({}),O.current&&(O.current.value=""))}catch(l){k.current&&(_((null==l?void 0:l.message)||"Failed to upload files. Please try again."),$({}))}finally{k.current&&D(!1)}},disabled:C||A.length>=10,accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.svg,.zip,.rar,.7z,.mp4,.mp3,.wav",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10 disabled:cursor-not-allowed"}),r.jsx("div",{className:"w-full px-4 py-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-800/50 text-center group-hover:border-blue-500 dark:group-hover:border-blue-400 group-hover:bg-blue-50/50 dark:group-hover:bg-blue-900/10 transition-all duration-200",children:r.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[r.jsx("div",{className:"p-2 bg-white dark:bg-gray-700 rounded-full shadow-sm group-hover:scale-110 transition-transform duration-200",children:r.jsx(c,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"})}),r.jsxs("div",{children:[r.jsx("p",{className:"text-xs font-medium text-gray-900 dark:text-white",children:"Click to upload or drag and drop"}),r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-0.5",children:"Support for documents, images, and archives"})]})]})})]}),C&&Object.keys(F).length>0&&r.jsx("div",{className:"mt-2 space-y-2",children:Object.entries(F).map((([e,t])=>r.jsxs("div",{className:"space-y-1",children:[r.jsxs("div",{className:"flex items-center justify-between text-xs",children:[r.jsx("span",{className:"text-gray-600 dark:text-gray-400 truncate flex-1",children:e.split("-")[0]}),r.jsxs("span",{className:"text-blue-600 dark:text-blue-400 font-semibold ml-2",children:[t,"%"]})]}),r.jsx("div",{className:"w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1 overflow-hidden",children:r.jsx("div",{className:"bg-blue-600 dark:bg-blue-500 h-full transition-all duration-300 ease-out",style:{width:`${t}%`}})})]},e)))}),A.length>0&&r.jsx("div",{className:"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2",children:A.map(((e,t)=>r.jsxs("div",{className:"group flex items-center gap-2 bg-white dark:bg-gray-700/50 px-2 py-2 rounded-md border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 transition-all duration-200",children:[r.jsx("div",{className:"p-1.5 bg-blue-50 dark:bg-blue-900/20 rounded-md",children:r.jsx(x,{className:"w-3.5 h-3.5 text-blue-600 dark:text-blue-400"})}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"text-xs font-medium text-gray-900 dark:text-white truncate",children:e.name}),e.size>0&&r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:q(e.size)})]}),r.jsx("button",{type:"button",onClick:()=>R(t),disabled:S,className:"p-1 text-gray-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-all duration-200 opacity-0 group-hover:opacity-100 disabled:opacity-50 disabled:cursor-not-allowed",title:"Remove file",children:r.jsx(m,{className:"w-3.5 h-3.5"})})]},t)))})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1",children:r.jsxs("span",{className:"flex items-center gap-1.5",children:[r.jsx(g,{className:"w-3.5 h-3.5"}),"Google Drive Links"]})}),r.jsx("textarea",{value:w.googleDriveLinks,onChange:e=>N({...w,googleDriveLinks:e.target.value}),rows:2,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:border-blue-500 dark:focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 transition-all outline-none shadow-sm resize-none placeholder:text-gray-400 font-mono",placeholder:"https://drive.google.com/file/d/..."}),r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Enter one link per line. Supported: Drive files, folders, Docs, Sheets, Slides."})]})]})}),r.jsx("div",{className:"p-3 sm:p-4 border-t border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50 shrink-0",children:r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",onClick:()=>{E(!1),u()},className:"px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-white dark:hover:bg-gray-700 font-medium transition-all duration-200 disabled:opacity-50 shadow-sm hover:shadow text-sm",disabled:S,children:"Cancel"}),r.jsx("button",{onClick:e=>B(e),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium shadow-md shadow-blue-500/20 hover:shadow-blue-500/30 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 flex items-center gap-1.5 text-sm",disabled:S||C,children:S?r.jsxs(r.Fragment,{children:[r.jsx(o,{className:"w-3.5 h-3.5 animate-spin"}),"Saving..."]}):f?"Update Task":"Create Task"})]})})]})}),document.body)})),R=s.memo((function({tasks:e,selectedTaskIds:t,onSelectTasks:a,onTaskClick:s,onTaskEdit:l,onTaskDelete:n,sort:i,onSortChange:d}){const o=e=>{i.field===e?d({field:e,direction:"asc"===i.direction?"desc":"asc"}):d({field:e,direction:"asc"})},c=async e=>{if(confirm("Delete this task?"))try{await A(e),n(e)}catch(t){alert("Failed to delete task")}},g={low:"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300",medium:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",high:"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",urgent:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300"},f={"my-tasks":"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300",pending:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300","in-progress":"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",completed:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300"},k=({field:e})=>i.field!==e?null:"asc"===i.direction?r.jsx(b,{className:"w-4 h-4"}):r.jsx(y,{className:"w-4 h-4"});return 0===e.length?r.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-4",children:[r.jsxs("div",{className:"relative mb-3",children:[r.jsx("div",{className:"w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/30 flex items-center justify-center",children:r.jsx(x,{className:"w-8 h-8 text-blue-600 dark:text-blue-400"})}),r.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center shadow-lg",children:r.jsx("span",{className:"text-white text-sm",children:"âœ¨"})})]}),r.jsx("h3",{className:"text-base font-bold text-gray-900 dark:text-white mb-1",children:"No Tasks Found"}),r.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 text-center max-w-md",children:"Try adjusting your search or filters, or create your first task to get started"})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"md:hidden space-y-2",children:e.map(((e,t)=>{const a=new Date(e.dueDate)<new Date&&"completed"!==e.status;return r.jsxs("div",{className:"group relative bg-white dark:bg-gray-800 rounded-lg border transition-all duration-200 shadow-sm hover:shadow-md "+(a?"border-red-200 dark:border-red-800 bg-red-50/40 dark:bg-red-900/15":"border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-600"),children:[a&&r.jsx("div",{className:"absolute top-0 right-0 bg-gradient-to-l from-red-500 to-red-600 text-white px-2 py-0.5 rounded-bl-lg text-xs font-semibold",children:"Overdue"}),r.jsx("div",{className:"p-3",children:r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("button",{onClick:()=>s(e),className:"font-semibold text-sm text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 text-left mb-1 line-clamp-2 transition-colors",children:e.name}),e.description&&r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-2 line-clamp-1 leading-relaxed",children:e.description}),r.jsxs("div",{className:"flex flex-wrap items-center gap-1.5 mb-2",children:[r.jsx("span",{className:"inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 capitalize",children:e.category.replace("-"," ")}),r.jsx("span",{className:`inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full capitalize whitespace-nowrap ${f[e.status]||f["my-tasks"]}`,children:"my-tasks"===e.status?"To Do":"pending"===e.status?"Pending":e.status.replace("-"," ")}),r.jsx("span",{className:`inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full capitalize ${g[e.priority]}`,children:e.priority})]}),r.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-700",children:[r.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-gray-600 dark:text-gray-400 font-medium",children:[r.jsx(u,{className:"w-3 h-3"}),r.jsx("span",{children:new Date(e.dueDate).toLocaleDateString()}),a&&r.jsxs("span",{className:"ml-1 inline-flex items-center gap-1 text-red-600 dark:text-red-400 font-medium",children:[r.jsx("span",{className:"w-1 h-1 bg-red-600 dark:bg-red-400 rounded-full animate-pulse"}),"Overdue"]})]}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("button",{onClick:()=>s(e),className:"p-1.5 text-gray-600 hover:text-blue-600 hover:bg-blue-50 dark:text-gray-400 dark:hover:text-blue-400 dark:hover:bg-blue-900/20 rounded-md transition-all duration-200 touch-manipulation active:scale-95",title:"View details",children:r.jsx(h,{className:"w-3.5 h-3.5"})}),r.jsx("button",{onClick:()=>l(e),className:"p-1.5 text-gray-600 hover:text-green-600 hover:bg-green-50 dark:text-gray-400 dark:hover:text-green-400 dark:hover:bg-green-900/20 rounded-md transition-all duration-200 touch-manipulation active:scale-95",title:"Edit task",children:r.jsx(p,{className:"w-3.5 h-3.5"})}),r.jsx("button",{onClick:()=>c(e.id),className:"p-1.5 text-gray-600 hover:text-red-600 hover:bg-red-50 dark:text-gray-400 dark:hover:text-red-400 dark:hover:bg-red-900/20 rounded-md transition-all duration-200 touch-manipulation active:scale-95",title:"Delete",children:r.jsx(m,{className:"w-3.5 h-3.5"})})]})]})]})})]},e.id)}))}),r.jsx("div",{className:"hidden md:block",children:r.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-md shadow-gray-200/30 dark:shadow-gray-900/30 overflow-hidden",children:r.jsx("div",{className:"overflow-x-auto",children:r.jsxs("table",{className:"w-full table-fixed",children:[r.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800/80 border-b border-gray-200 dark:border-gray-700",children:r.jsxs("tr",{children:[r.jsx("th",{className:"w-10 px-3 py-2 text-left",children:r.jsx("input",{type:"checkbox",checked:t.length===e.length,onChange:t=>{return r=t.target.checked,void a(r?e.map((e=>e.id)):[]);var r},className:"w-4 h-4 rounded border-2 border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500"})}),r.jsx("th",{onClick:()=>o("name"),className:"w-auto px-3 py-2 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors select-none",children:r.jsxs("div",{className:"flex items-center gap-1",children:["Task Name",r.jsx(k,{field:"name"})]})}),r.jsx("th",{onClick:()=>o("category"),className:"w-32 px-3 py-2 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors select-none",children:r.jsxs("div",{className:"flex items-center gap-1",children:["Category",r.jsx(k,{field:"category"})]})}),r.jsx("th",{onClick:()=>o("status"),className:"w-24 px-3 py-2 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors select-none",children:r.jsxs("div",{className:"flex items-center gap-1",children:["Status",r.jsx(k,{field:"status"})]})}),r.jsx("th",{onClick:()=>o("priority"),className:"w-24 px-3 py-2 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors select-none",children:r.jsxs("div",{className:"flex items-center gap-1",children:["Priority",r.jsx(k,{field:"priority"})]})}),r.jsx("th",{onClick:()=>o("dueDate"),className:"w-28 px-3 py-2 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors select-none",children:r.jsxs("div",{className:"flex items-center gap-1",children:["Due Date",r.jsx(k,{field:"dueDate"})]})}),r.jsx("th",{className:"w-24 px-3 py-2 text-right text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider",children:"Actions"})]})}),r.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:e.map((e=>{const n=new Date(e.dueDate)<new Date&&"completed"!==e.status;return r.jsxs("tr",{className:"group task-table-row transition-all duration-200 border-b border-gray-100 dark:border-gray-700/50 last:border-0 text-sm "+(n?"bg-red-50/40 dark:bg-red-900/10 hover:bg-red-50/60 dark:hover:bg-red-900/15":"hover:bg-blue-50/30 dark:hover:bg-gray-800/70"),children:[r.jsx("td",{className:"px-3 py-2",children:r.jsx("input",{type:"checkbox",checked:t.includes(e.id),onChange:r=>{return s=e.id,l=r.target.checked,void a(l?[...t,s]:t.filter((e=>e!==s)));var s,l},className:"w-4 h-4 rounded border-2 border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 transition-colors"})}),r.jsx("td",{className:"px-3 py-2",children:r.jsxs("div",{className:"flex flex-col gap-0.5",children:[r.jsx("button",{onClick:()=>s(e),className:"font-semibold text-xs text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 text-left transition-colors line-clamp-1",children:e.name}),e.description&&r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 line-clamp-1",children:e.description})]})}),r.jsx("td",{className:"px-3 py-2",children:r.jsx("span",{className:"inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 capitalize whitespace-nowrap",children:e.category.replace("-"," ")})}),r.jsx("td",{className:"px-3 py-2",children:r.jsx("span",{className:`inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full capitalize whitespace-nowrap ${f[e.status]||f["my-tasks"]}`,children:"my-tasks"===e.status?"To Do":"pending"===e.status?"Pending":e.status.replace("-"," ")})}),r.jsx("td",{className:"px-3 py-2",children:r.jsx("span",{className:`inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full uppercase ${g[e.priority]}`,children:e.priority})}),r.jsx("td",{className:"px-3 py-2",children:r.jsxs("div",{className:"flex flex-col gap-1",children:[r.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-gray-700 dark:text-gray-300",children:[r.jsx(u,{className:"w-3 h-3 text-gray-400 dark:text-gray-500"}),r.jsx("span",{children:new Date(e.dueDate).toLocaleDateString()})]}),n&&r.jsxs("span",{className:"inline-flex items-center gap-1 text-xs text-red-600 dark:text-red-400 font-medium",children:[r.jsx("span",{className:"w-1 h-1 bg-red-600 dark:bg-red-400 rounded-full animate-pulse"}),"Overdue"]})]})}),r.jsx("td",{className:"px-3 py-2 text-right",children:r.jsxs("div",{className:"flex items-center justify-end gap-0.5 task-action-buttons",children:[r.jsx("button",{onClick:()=>s(e),className:"p-1.5 text-gray-600 hover:text-blue-600 hover:bg-blue-50 dark:text-gray-400 dark:hover:text-blue-400 dark:hover:bg-blue-900/20 rounded-md transition-all duration-200",title:"View details","aria-label":"View task details",children:r.jsx(h,{className:"w-3.5 h-3.5"})}),r.jsx("button",{onClick:()=>l(e),className:"p-1.5 text-gray-600 hover:text-green-600 hover:bg-green-50 dark:text-gray-400 dark:hover:text-green-400 dark:hover:bg-green-900/20 rounded-md transition-all duration-200",title:"Edit task","aria-label":"Edit task",children:r.jsx(p,{className:"w-3.5 h-3.5"})}),r.jsx("button",{onClick:()=>c(e.id),className:"p-1.5 text-gray-600 hover:text-red-600 hover:bg-red-50 dark:text-gray-400 dark:hover:text-red-400 dark:hover:bg-red-900/20 rounded-md transition-all duration-200",title:"Delete","aria-label":"Delete task",children:r.jsx(m,{className:"w-3.5 h-3.5"})})]})})]},e.id)}))})]})})})})]})}));function q(){return r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-white dark:bg-gray-900",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"w-12 h-12 border-4 border-blue-600/20 dark:border-blue-400/20 border-t-blue-600 dark:border-t-blue-400 rounded-full animate-spin mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Loading..."})]})})}function B({taskId:a,userId:s,userName:l}){const[n,i]=t.useState([]),[d,o]=t.useState(!0),[c,x]=t.useState(""),[m,g]=t.useState(!1),[u,h]=t.useState(null),[p,b]=t.useState("");t.useEffect((()=>{y()}),[a]),t.useEffect((()=>()=>{g(!1)}),[]);const y=async()=>{try{o(!0);const t=await async function(t){const{data:a,error:r}=await e.from("task_comments").select("\n      *,\n      user:users(id, name, email)\n    ").eq("task_id",t).order("created_at",{ascending:!0});if(r)throw new Error(`Failed to fetch comments: ${r.message}`);return(a||[]).map(U)}(a);i(t)}catch(t){console.error("Failed to load comments:",t)}finally{o(!1)}};return d?r.jsx("div",{className:"flex items-center justify-center h-32",children:r.jsx(q,{})}):r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{className:"flex items-center gap-2 text-gray-900 dark:text-white",children:[r.jsx(f,{className:"w-5 h-5"}),r.jsxs("h3",{className:"font-semibold",children:["Comments (",n.length,")"]})]}),r.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:0===n.length?r.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 text-center py-8",children:"No comments yet. Be the first to comment!"}):n.map((t=>r.jsx(V,{comment:t,isOwner:t.userId===s,isEditing:u===t.id,editText:p,onEditTextChange:b,onStartEdit:()=>{h(t.id),b(t.comment)},onCancelEdit:()=>{h(null),b("")},onSaveEdit:()=>(async t=>{if(p.trim())try{const a=await async function(t,a){const{data:r,error:s}=await e.from("task_comments").update({comment:a,is_edited:!0}).eq("id",t).select("\n      *,\n      user:users(id, name, email)\n    ").single();if(s)throw new Error(`Failed to update comment: ${s.message}`);return U(r)}(t,p.trim());i(n.map((e=>e.id===t?a:e))),h(null),b("")}catch(a){console.error("Failed to update comment:",a),alert("Failed to update comment")}})(t.id),onDelete:()=>(async t=>{if(confirm("Delete this comment?"))try{await async function(t){const{error:a}=await e.from("task_comments").delete().eq("id",t);if(a)throw new Error(`Failed to delete comment: ${a.message}`)}(t),i(n.filter((e=>e.id!==t)))}catch(a){console.error("Failed to delete comment:",a),alert("Failed to delete comment")}})(t.id)},t.id)))}),r.jsxs("form",{onSubmit:async t=>{if(t.preventDefault(),c.trim()&&!m){g(!0);try{const t=await async function(t,a,r){const{data:s,error:l}=await e.from("task_comments").insert({task_id:t,user_id:a,comment:r}).select("\n      *,\n      user:users(id, name, email)\n    ").single();if(l)throw new Error(`Failed to add comment: ${l.message}`);return U(s)}(a,s,c.trim());i([...n,t]),x("")}catch(r){console.error("Failed to add comment:",r),alert("Failed to add comment")}finally{g(!1)}}},className:"flex gap-2",children:[r.jsx("div",{className:"flex-1",children:r.jsx("textarea",{value:c,onChange:e=>x(e.target.value),placeholder:"Write a comment...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:2,disabled:m})}),r.jsxs("button",{type:"submit",disabled:!c.trim()||m,className:"self-end px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2",children:[r.jsx(j,{className:"w-4 h-4"}),m?"Sending...":"Send"]})]})]})}function V({comment:e,isOwner:t,isEditing:a,editText:s,onEditTextChange:l,onStartEdit:n,onCancelEdit:i,onSaveEdit:d,onDelete:o}){var c,x,g;return r.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-4",children:[r.jsxs("div",{className:"flex items-start justify-between mb-2",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium",children:(null==(x=null==(c=e.user)?void 0:c.name)?void 0:x.charAt(0).toUpperCase())||"?"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-medium text-gray-900 dark:text-white text-sm",children:(null==(g=e.user)?void 0:g.name)||"Unknown"}),r.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[(e=>{const t=new Date(e),a=(new Date).getTime()-t.getTime(),r=Math.floor(a/6e4),s=Math.floor(a/36e5),l=Math.floor(a/864e5);return r<1?"Just now":r<60?`${r}m ago`:s<24?`${s}h ago`:l<7?`${l}d ago`:t.toLocaleDateString()})(e.createdAt),e.isEdited&&" (edited)"]})]})]}),t&&!a&&r.jsxs("div",{className:"flex gap-1",children:[r.jsx("button",{onClick:n,className:"p-1 text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors",title:"Edit comment",children:r.jsx(p,{className:"w-4 h-4"})}),r.jsx("button",{onClick:o,className:"p-1 text-gray-500 hover:text-red-600 dark:hover:text-red-400 transition-colors",title:"Delete comment",children:r.jsx(m,{className:"w-4 h-4"})})]})]}),a?r.jsxs("div",{className:"space-y-2",children:[r.jsx("textarea",{value:s,onChange:e=>l(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none",rows:2}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{onClick:d,className:"px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700",children:"Save"}),r.jsx("button",{onClick:i,className:"px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"})]})]}):r.jsx("p",{className:"text-gray-700 dark:text-gray-300 text-sm whitespace-pre-wrap",children:e.comment})]})}function J({task:a,userId:s,onClose:l,onTaskUpdated:n,onTaskDeleted:o}){const[c,x]=t.useState("details"),[h,b]=t.useState(!1),[y,j]=t.useState([]),[E,T]=t.useState(!1),[_,F]=t.useState(!1);t.useEffect((()=>{"history"===c&&I()}),[c]);const I=async()=>{try{T(!0);const t=await async function(t){const{data:a,error:r}=await e.from("task_history").select("\n      *,\n      user:users(id, name, email)\n    ").eq("task_id",t).order("created_at",{ascending:!1});if(r)throw new Error(`Failed to fetch history: ${r.message}`);return(a||[]).map(O)}(a.id);j(t)}catch(t){console.error("Failed to load history:",t)}finally{T(!1)}},L=async e=>{try{F(!0);const t=await z(a.id,{status:e});n(t)}catch(t){console.error("Failed to update status:",t),alert("Failed to update status")}finally{F(!1)}},$=new Date(a.dueDate)<new Date&&"completed"!==a.status;return h?r.jsx(P,{userId:s,task:a,onClose:()=>b(!1),onTaskUpdated:e=>{n(e),b(!1)}}):r.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[r.jsxs("div",{className:"flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700",children:[r.jsxs("div",{className:"flex-1 mr-4",children:[r.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-2",children:a.name}),r.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[r.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${{low:"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300",medium:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",high:"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",urgent:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300"}[a.priority]}`,children:a.priority.toUpperCase()}),r.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${{"my-tasks":"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300","in-progress":"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",completed:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300"}[a.status]}`,children:"my-tasks"===a.status?"To Do":a.status.replace("-"," ")}),$&&r.jsxs("span",{className:"flex items-center gap-1 px-3 py-1 bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300 rounded-full text-xs font-medium",children:[r.jsx(d,{className:"w-3 h-3"}),"Overdue"]})]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{onClick:()=>b(!0),className:"p-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300",title:"Edit task",children:r.jsx(p,{className:"w-5 h-5"})}),r.jsx("button",{onClick:async()=>{if(confirm("Delete this task? This action cannot be undone."))try{await A(a.id),o(a.id),l()}catch(e){console.error("Failed to delete task:",e),alert("Failed to delete task")}},className:"p-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300",title:"Delete task",children:r.jsx(m,{className:"w-5 h-5"})}),r.jsx("button",{onClick:l,className:"p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300",children:r.jsx(i,{className:"w-6 h-6"})})]})]}),r.jsxs("div",{className:"flex border-b border-gray-200 dark:border-gray-700 px-4 sm:px-6 overflow-x-auto no-scrollbar",children:[r.jsx("button",{onClick:()=>x("details"),className:"px-4 py-3 font-medium border-b-2 transition-colors whitespace-nowrap "+("details"===c?"border-blue-600 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"),children:"Details"}),r.jsxs("button",{onClick:()=>x("comments"),className:"flex items-center gap-2 px-4 py-3 font-medium border-b-2 transition-colors whitespace-nowrap "+("comments"===c?"border-blue-600 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"),children:[r.jsx(f,{className:"w-4 h-4"}),"Comments"]}),r.jsxs("button",{onClick:()=>x("history"),className:"flex items-center gap-2 px-4 py-3 font-medium border-b-2 transition-colors whitespace-nowrap "+("history"===c?"border-blue-600 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"),children:[r.jsx(k,{className:"w-4 h-4"}),"History"]})]}),r.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6",children:["details"===c&&r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Description"}),r.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:a.description})]}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Quick Actions"}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:["in-progress"!==a.status&&r.jsx("button",{onClick:()=>L("in-progress"),disabled:_,className:"px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50",children:"Start Working"}),"completed"!==a.status&&r.jsxs("button",{onClick:()=>L("completed"),disabled:_,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center gap-2",children:[r.jsx(v,{className:"w-4 h-4"}),"Mark Complete"]}),"completed"===a.status&&r.jsx("button",{onClick:()=>L("my-tasks"),disabled:_,className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50",children:"Reopen Task"})]})]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsx(X,{icon:r.jsx(u,{className:"w-5 h-5"}),label:"Due Date",value:new Date(a.dueDate).toLocaleDateString()}),r.jsx(X,{icon:r.jsx(w,{className:"w-5 h-5"}),label:"Category",value:a.category.replace("-"," ")}),a.assignedToUser&&r.jsx(X,{icon:r.jsx(N,{className:"w-5 h-5"}),label:"Assigned To",value:a.assignedToUser.name}),a.assignedByUser&&r.jsx(X,{icon:r.jsx(C,{className:"w-5 h-5"}),label:"Assigned By",value:a.assignedByUser.name}),r.jsx(X,{icon:r.jsx(w,{className:"w-5 h-5"}),label:"Created",value:new Date(a.createdAt).toLocaleString()}),a.completedAt&&r.jsx(X,{icon:r.jsx(v,{className:"w-5 h-5"}),label:"Completed",value:new Date(a.completedAt).toLocaleString()})]}),a.tags&&a.tags.length>0&&r.jsxs("div",{children:[r.jsxs("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2",children:[r.jsx(D,{className:"w-4 h-4"}),"Tags"]}),r.jsx("div",{className:"flex flex-wrap gap-2",children:a.tags.map(((e,t)=>r.jsx("span",{className:"px-3 py-1 bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 rounded-full text-sm",children:e},t)))})]}),a.attachments&&a.attachments.length>0&&r.jsxs("div",{children:[r.jsxs("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2",children:[r.jsx(S,{className:"w-4 h-4"}),"Attachments"]}),r.jsx("div",{className:"space-y-2",children:a.attachments.map(((e,t)=>r.jsxs("a",{href:e,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300",children:[r.jsx(S,{className:"w-4 h-4"}),e.split("/").pop()]},t)))})]}),a.googleDriveLinks&&a.googleDriveLinks.length>0&&r.jsxs("div",{children:[r.jsxs("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2",children:[r.jsx(g,{className:"w-4 h-4"}),"Google Drive Links"]}),r.jsx("div",{className:"space-y-2",children:a.googleDriveLinks.map(((e,t)=>r.jsxs("a",{href:e,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 break-all",children:[r.jsx(g,{className:"w-4 h-4 flex-shrink-0"}),e]},t)))})]})]}),"comments"===c&&r.jsx(B,{taskId:a.id,userId:s,userName:"Current User"}),"history"===c&&r.jsx("div",{className:"space-y-4",children:E?r.jsx("p",{className:"text-center text-gray-500 dark:text-gray-400",children:"Loading history..."}):0===y.length?r.jsx("p",{className:"text-center text-gray-500 dark:text-gray-400",children:"No history yet"}):y.map((e=>r.jsx(H,{entry:e},e.id)))})]})]})})}function X({icon:e,label:t,value:a}){return r.jsxs("div",{className:"flex items-start gap-3 p-4 bg-gray-50 dark:bg-gray-750 rounded-lg",children:[r.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:e}),r.jsxs("div",{children:[r.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:t}),r.jsx("p",{className:"text-base font-medium text-gray-900 dark:text-white capitalize",children:a})]})]})}function H({entry:e}){var t,a,s,l,n;return r.jsxs("div",{className:"flex gap-3 p-4 bg-gray-50 dark:bg-gray-750 rounded-lg",children:[r.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium flex-shrink-0",children:(null==(a=null==(t=e.user)?void 0:t.name)?void 0:a.charAt(0).toUpperCase())||"?"}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("div",{className:"flex items-start justify-between gap-2",children:r.jsxs("div",{children:[r.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:(null==(s=e.user)?void 0:s.name)||"Unknown User"}),r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:(n=e.createdAt,new Date(n).toLocaleString())})]})}),r.jsxs("p",{className:"text-sm text-gray-700 dark:text-gray-300 mt-2",children:[(l=e.action,{created:"Created task",status_changed:"Changed status",priority_changed:"Changed priority",assigned:"Assigned task",deleted:"Deleted task"}[l]||l),e.fieldName&&r.jsxs(r.Fragment,{children:[" ",r.jsx("span",{className:"font-medium",children:e.fieldName}),e.oldValue&&e.newValue&&r.jsxs(r.Fragment,{children:[" from ",r.jsx("span",{className:"font-medium text-red-600 dark:text-red-400",children:e.oldValue})," to ",r.jsx("span",{className:"font-medium text-green-600 dark:text-green-400",children:e.newValue})]})]})]})]})]})}const W=()=>r.jsxs("div",{className:"space-y-4 p-4",children:[r.jsx("div",{className:"md:hidden space-y-4",children:[1,2,3,4,5].map((e=>r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-200 dark:border-gray-700 p-5 overflow-hidden relative",style:{animationDelay:.1*e+"s"},children:[r.jsx("div",{className:"absolute inset-0 shimmer"}),r.jsxs("div",{className:"flex items-start gap-3 relative",children:[r.jsx("div",{className:"w-5 h-5 bg-gray-200 dark:bg-gray-700 rounded mt-1"}),r.jsxs("div",{className:"flex-1 space-y-3",children:[r.jsx("div",{className:"h-5 bg-gray-200 dark:bg-gray-700 rounded w-3/4"}),r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-full"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("div",{className:"h-6 bg-gray-200 dark:bg-gray-700 rounded-lg w-20"}),r.jsx("div",{className:"h-6 bg-gray-200 dark:bg-gray-700 rounded-lg w-24"}),r.jsx("div",{className:"h-6 bg-gray-200 dark:bg-gray-700 rounded-lg w-16"})]}),r.jsxs("div",{className:"flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700",children:[r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-32"}),r.jsxs("div",{className:"flex gap-1",children:[r.jsx("div",{className:"w-9 h-9 bg-gray-200 dark:bg-gray-700 rounded-lg"}),r.jsx("div",{className:"w-9 h-9 bg-gray-200 dark:bg-gray-700 rounded-lg"}),r.jsx("div",{className:"w-9 h-9 bg-gray-200 dark:bg-gray-700 rounded-lg"})]})]})]})]})]},e)))}),r.jsx("div",{className:"hidden md:block",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm relative",children:[r.jsx("div",{className:"absolute inset-0 shimmer z-10 pointer-events-none"}),r.jsxs("table",{className:"w-full relative z-0",children:[r.jsx("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-750 border-b-2 border-gray-200 dark:border-gray-700",children:r.jsxs("tr",{children:[r.jsx("th",{className:"px-6 py-4",children:r.jsx("div",{className:"w-5 h-5 bg-gray-200 dark:bg-gray-700 rounded"})}),r.jsx("th",{className:"px-6 py-4 text-left",children:r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-24"})}),r.jsx("th",{className:"px-6 py-4 text-left",children:r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-20"})}),r.jsx("th",{className:"px-6 py-4 text-left",children:r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-16"})}),r.jsx("th",{className:"px-6 py-4 text-left",children:r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-16"})}),r.jsx("th",{className:"px-6 py-4 text-left",children:r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-20"})}),r.jsx("th",{className:"px-6 py-4",children:r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-16 ml-auto"})})]})}),r.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:[1,2,3,4,5,6,7].map((e=>r.jsxs("tr",{style:{animationDelay:.05*e+"s"},children:[r.jsx("td",{className:"px-6 py-4",children:r.jsx("div",{className:"w-5 h-5 bg-gray-200 dark:bg-gray-700 rounded"})}),r.jsx("td",{className:"px-6 py-4",children:r.jsxs("div",{className:"space-y-2",children:[r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-48"}),r.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded w-64"})]})}),r.jsx("td",{className:"px-6 py-4",children:r.jsx("div",{className:"h-6 bg-gray-200 dark:bg-gray-700 rounded-lg w-24"})}),r.jsx("td",{className:"px-6 py-4",children:r.jsx("div",{className:"h-6 bg-gray-200 dark:bg-gray-700 rounded-lg w-20"})}),r.jsx("td",{className:"px-6 py-4",children:r.jsx("div",{className:"h-6 bg-gray-200 dark:bg-gray-700 rounded-lg w-20"})}),r.jsx("td",{className:"px-6 py-4",children:r.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-32"})}),r.jsx("td",{className:"px-6 py-4",children:r.jsxs("div",{className:"flex items-center justify-end gap-1",children:[r.jsx("div",{className:"w-9 h-9 bg-gray-200 dark:bg-gray-700 rounded-lg"}),r.jsx("div",{className:"w-9 h-9 bg-gray-200 dark:bg-gray-700 rounded-lg"}),r.jsx("div",{className:"w-9 h-9 bg-gray-200 dark:bg-gray-700 rounded-lg"})]})})]},e)))})]})]})})]}),Z=t.memo((({userId:a,sectionId:s,isSectionAdmin:i=!1,isAdmin:c=!1,openCreateForm:x=!1,onCloseCreateForm:g})=>{const[u,h]=t.useState(!1),[p,b]=t.useState(x),[y,f]=t.useState(null),[k,j]=t.useState(null),[v,w]=t.useState(0);t.useEffect((()=>{x&&b(!0)}),[x]);const N=t.useCallback((()=>{b(!1),j(null),g&&g()}),[g]),[C,D]=t.useState([]),[L,z]=t.useState(!0),[A,M]=t.useState(null),[U]=t.useState(1),[O,q]=t.useState(0),B=t.useRef(null),V=t.useRef(null),X=t.useRef(!0),[H,Z]=t.useState(""),[G,Y]=t.useState({search:"",category:"all",status:"all",priority:"all"}),[Q,K]=t.useState({field:"createdAt",direction:"desc"}),[ee,te]=t.useState([]),[ae,re]=t.useState(!1),se=t.useCallback((async(e=!1)=>{B.current&&B.current.abort();const t=new AbortController;B.current=t;try{e||z(!0),M(null);const r=await async function(e,t={}){const{page:a=1,pageSize:r=50,filters:s={},sort:i,sectionId:d,abortSignal:o,bypassCache:c=!1}=t,x=JSON.stringify({filters:s,sort:i,sectionId:d,page:a,pageSize:r}),m=n.tasksEnhanced(e,x);if(!c&&!o)try{return await l.getOrFetch(m,(()=>$(0,{page:a,pageSize:r,filters:s,sort:i,sectionId:d,abortSignal:o})),6e4)}catch(A){console.warn("[TaskService] Cache fetch failed, fetching directly:",A)}return $(0,{page:a,pageSize:r,filters:s,sort:i,sectionId:d,abortSignal:o})}(a,{page:U,pageSize:50,filters:G,sort:Q,sectionId:s,abortSignal:t.signal,bypassCache:e});X.current&&!t.signal.aborted&&(D(r.tasks),q(r.total),M(null))}catch(r){if(X.current&&!t.signal.aborted&&"AbortError"!==(null==r?void 0:r.name)&&"Operation cancelled"!==(null==r?void 0:r.message)){const e=r.message||"Failed to load tasks";M(e),console.error("Error loading tasks:",r)}}finally{X.current&&!t.signal.aborted&&z(!1),B.current===t&&(B.current=null)}}),[a,U,G,Q,s]);t.useEffect((()=>(V.current&&clearTimeout(V.current),V.current=setTimeout((()=>{Y((e=>({...e,search:H})))}),300),()=>{V.current&&clearTimeout(V.current)})),[H]),t.useEffect((()=>{se()}),[se]),t.useEffect((()=>(X.current=!0,()=>{X.current=!1,B.current&&(B.current.abort(),B.current=null),V.current&&(clearTimeout(V.current),V.current=null),b(!1)})),[]),t.useEffect((()=>{x&&(w((e=>e+1)),b(!0))}),[x]);const le=t.useCallback((e=>{b(!1),w((e=>e+1)),se(!0)}),[se]),ne=t.useCallback((e=>{X.current&&(D((t=>t.map((t=>t.id===e.id?e:t)))),f((t=>(null==t?void 0:t.id)===e.id?e:t)))}),[]),ie=t.useCallback((e=>{j(e)}),[]),de=t.useCallback((e=>{X.current&&(D((t=>t.filter((t=>t.id!==e)))),q((e=>e-1)),te((t=>t.filter((t=>t!==e)))),f((t=>(null==t?void 0:t.id)===e?null:t)))}),[]),oe=t.useCallback((async()=>{if(0!==ee.length&&!ae&&confirm(`Delete ${ee.length} selected task${ee.length>1?"s":""}?`)){re(!0);try{await async function(t){await I.executeVoid((()=>e.from("tasks").delete().in("id",t)),"Bulk delete tasks")}(ee),X.current&&(D((e=>e.filter((e=>!ee.includes(e.id))))),q((e=>e-ee.length)),te([]),se(!0))}catch(t){X.current&&(M(t.message||"Failed to delete tasks"),se(!0))}finally{X.current&&re(!1)}}}),[ee,ae,se]),ce=t.useCallback((async t=>{if(0!==ee.length&&!ae){re(!0);try{await async function(t,a){const r={status:a};"completed"===a&&(r.completed_at=(new Date).toISOString()),await I.executeVoid((()=>e.from("tasks").update(r).in("id",t)),"Bulk update status")}(ee,t),X.current&&(te([]),await se(!0))}catch(a){X.current&&M(a.message||"Failed to update tasks")}finally{X.current&&re(!1)}}}),[ee,ae,se]),xe=t.useCallback((()=>{const e=[["Name","Category","Status","Priority","Due Date","Created At"],...C.map((e=>[e.name,e.category,e.status,e.priority,e.dueDate,new Date(e.createdAt).toLocaleDateString()]))].map((e=>e.join(","))).join("\n"),t=new Blob([e],{type:"text/csv"}),a=URL.createObjectURL(t),r=document.createElement("a");r.href=a,r.download=`tasks-${(new Date).toISOString().split("T")[0]}.csv`,r.click(),URL.revokeObjectURL(a)}),[C]),me=t.useCallback(((e,t)=>{Y((a=>({...a,[e]:t})))}),[]),ge=t.useCallback((e=>{K(e)}),[]),ue=t.useMemo((()=>{let e=C;if(G.search){const t=G.search.toLowerCase();e=e.filter((e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)))}return"all"!==G.category&&(e=e.filter((e=>e.category===G.category))),"all"!==G.status&&(e=e.filter((e=>e.status===G.status))),"all"!==G.priority&&(e=e.filter((e=>e.priority===G.priority))),e}),[C,G]);return r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"mb-2",children:[r.jsx("div",{className:"pt-2",children:r.jsxs("div",{className:"flex flex-col lg:flex-row items-stretch lg:items-center justify-between gap-2",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 flex-1 lg:max-w-3xl",children:[r.jsx("div",{className:"flex-1 sm:max-w-md",children:r.jsxs("div",{className:"relative group",children:[r.jsx(E,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 group-focus-within:text-blue-600 transition-colors"}),r.jsx("input",{type:"text",placeholder:"Search tasks...",value:H,onChange:e=>Z(e.target.value),className:"w-full pl-9 pr-3 py-2 text-sm border border-gray-300 dark:border-gray-600 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 dark:focus:border-blue-500 dark:focus:ring-blue-900/30 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 transition-all outline-none shadow-sm","aria-label":"Search tasks"})]})}),r.jsxs("div",{className:"flex items-center gap-1.5 overflow-x-auto pb-1 sm:pb-0 no-scrollbar sm:flex-wrap",children:[r.jsxs("button",{onClick:()=>h(!u),className:"flex items-center gap-1.5 px-3 py-2 border rounded-md font-medium transition-all duration-200 whitespace-nowrap shadow-sm text-sm "+(u?"border-blue-600 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-500 shadow-blue-100 dark:shadow-blue-900/20":"border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-500"),"aria-label":u?"Hide filters":"Show filters","aria-expanded":u,children:[r.jsx(T,{className:"w-3.5 h-3.5"}),r.jsx("span",{className:"text-xs font-medium",children:"Filters"})]}),ee.length>0&&r.jsxs(r.Fragment,{children:[r.jsxs("button",{onClick:()=>ce("completed"),disabled:ae,className:"flex items-center gap-1.5 px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-green-400 disabled:cursor-not-allowed font-medium transition-colors duration-200 whitespace-nowrap shadow-sm text-sm","aria-label":`Mark ${ee.length} selected task${ee.length>1?"s":""} as completed`,children:[r.jsx(_,{className:"w-3.5 h-3.5"}),r.jsx("span",{className:"text-xs",children:ae?"Processing...":"Complete"})]}),r.jsxs("button",{onClick:oe,disabled:ae,className:"flex items-center gap-1.5 px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed font-medium transition-colors duration-200 whitespace-nowrap shadow-sm text-sm","aria-label":`Delete ${ee.length} selected task${ee.length>1?"s":""}`,children:[r.jsx(m,{className:"w-3.5 h-3.5"}),r.jsx("span",{className:"text-xs",children:ae?"Deleting...":"Delete"})]})]}),r.jsxs("button",{onClick:xe,className:"flex items-center gap-1.5 px-3 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-500 font-medium transition-all duration-200 whitespace-nowrap shadow-sm text-sm","aria-label":"Export tasks to CSV",children:[r.jsx(S,{className:"w-3.5 h-3.5"}),r.jsx("span",{className:"text-xs font-medium",children:"Export"})]})]})]}),r.jsx("div",{className:"flex items-center justify-end sm:w-auto w-full",children:r.jsxs("button",{onClick:()=>{w((e=>e+1)),b(!0)},className:"w-full sm:w-auto flex items-center justify-center gap-1.5 px-4 py-2 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white rounded-md font-semibold transition-all duration-200 whitespace-nowrap shadow-md hover:shadow-lg text-sm","aria-label":"Create new task",children:[r.jsx(F,{className:"w-4 h-4"}),r.jsx("span",{className:"text-xs",children:"Create Task"})]})})]})}),u&&r.jsx("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600",children:r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"category-filter",className:"block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1",children:"Category"}),r.jsxs("select",{id:"category-filter",value:G.category,onChange:e=>me("category",e.target.value),className:"w-full px-2.5 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 dark:focus:border-blue-500 transition-colors outline-none text-sm","aria-label":"Filter by category",children:[r.jsx("option",{value:"all",children:"All Categories"}),r.jsx("option",{value:"assignment",children:"Assignment"}),r.jsx("option",{value:"quiz",children:"Quiz"}),r.jsx("option",{value:"presentation",children:"Presentation"}),r.jsx("option",{value:"project",children:"Project"}),r.jsx("option",{value:"lab-report",children:"Lab Report"}),r.jsx("option",{value:"midterm",children:"Midterm"}),r.jsx("option",{value:"final-exam",children:"Final Exam"}),r.jsx("option",{value:"task",children:"Task"}),r.jsx("option",{value:"others",children:"Others"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"status-filter",className:"block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1",children:"Status"}),r.jsxs("select",{id:"status-filter",value:G.status,onChange:e=>me("status",e.target.value),className:"w-full px-2.5 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 dark:focus:border-blue-500 transition-colors outline-none text-sm","aria-label":"Filter by status",children:[r.jsx("option",{value:"all",children:"All Status"}),r.jsx("option",{value:"my-tasks",children:"To Do"}),r.jsx("option",{value:"in-progress",children:"In Progress"}),r.jsx("option",{value:"completed",children:"Completed"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"priority-filter",className:"block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1",children:"Priority"}),r.jsxs("select",{id:"priority-filter",value:G.priority,onChange:e=>me("priority",e.target.value),className:"w-full px-2.5 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 dark:focus:border-blue-500 transition-colors outline-none text-sm","aria-label":"Filter by priority",children:[r.jsx("option",{value:"all",children:"All Priorities"}),r.jsx("option",{value:"low",children:"Low"}),r.jsx("option",{value:"medium",children:"Medium"}),r.jsx("option",{value:"high",children:"High"}),r.jsx("option",{value:"urgent",children:"Urgent"})]})]}),r.jsx("div",{className:"flex items-end",children:r.jsx("button",{onClick:()=>{Z(""),Y({search:"",category:"all",status:"all",priority:"all"})},className:"w-full px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition-colors duration-200 text-sm","aria-label":"Reset all filters",children:"Reset"})})]})})]}),A?r.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] gap-3 p-4",children:[r.jsx("div",{className:"flex items-center justify-center w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30",children:r.jsx(d,{className:"w-6 h-6 text-red-600 dark:text-red-400"})}),r.jsxs("div",{className:"text-center space-y-1",children:[r.jsx("h3",{className:"text-base font-semibold text-gray-900 dark:text-white",children:"Failed to Load Tasks"}),r.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 max-w-md",children:A})]}),r.jsxs("button",{onClick:()=>se(!1),disabled:L,className:"flex items-center gap-1.5 px-4 py-1.5 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white rounded-md font-medium transition-colors duration-200 disabled:cursor-not-allowed text-sm",children:[r.jsx(o,{className:"w-3.5 h-3.5 "+(L?"animate-spin":"")}),r.jsx("span",{children:"Retry"})]})]}):L?r.jsx(W,{}):r.jsx(R,{tasks:ue,selectedTaskIds:ee,onSelectTasks:te,onTaskClick:f,onTaskEdit:ie,onTaskDelete:de,sort:Q,onSortChange:ge}),p&&r.jsx(P,{userId:a,sectionId:s,onClose:N,onTaskCreated:le},v),k&&r.jsx(P,{userId:a,sectionId:s,task:k,onClose:N,onTaskUpdated:e=>{ne(e),j(null)}}),y&&r.jsx(J,{task:y,userId:a,onClose:()=>f(null),onTaskUpdated:ne,onTaskDeleted:de})]})}));export{Z as TaskManagerEnhanced};
