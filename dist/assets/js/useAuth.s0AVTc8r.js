import{r as e}from"./react-vendor.BQ9wcLSU.js";import{s as t,t as a}from"./index.OovSQwLB.js";import{c as r,d as s}from"./dataCache.DP4PyhNH.js";import{g as o}from"./authErrors.BDay5vyW.js";import{C as n,N as i}from"./capacitor-vendor.WkpnXCg6.js";const c="auth";async function l(){return new Promise(((e,t)=>{const a=indexedDB.open("nesttask-auth-storage",1);a.onerror=()=>{t(a.error)},a.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(c)||t.createObjectStore(c)},a.onsuccess=()=>{const t=a.result;e(t)}}))}async function d(e,t){try{const a=await l();return new Promise(((r,s)=>{const o=a.transaction(c,"readwrite"),n=o.objectStore(c).put(t,e);n.onerror=()=>{s(n.error)},n.onsuccess=()=>{r()},o.oncomplete=()=>{a.close()}}))}catch(a){}}async function u(){try{const{data:e}=await t.auth.getSession();(null==e?void 0:e.session)&&await t.auth.refreshSession({refresh_token:e.session.refresh_token})}catch(e){}}function m(e){switch(e){case"admin":return"admin";case"super-admin":case"super_admin":return"super-admin";case"section-admin":case"section_admin":return"section_admin";default:return"user"}}function h(e){return{id:e.id,email:e.email,name:e.name||e.username||e.email.split("@")[0],role:m(e.role||"user"),avatar:e.avatar,phone:e.phone,createdAt:e.created_at||(new Date).toISOString(),lastActive:e.last_active,studentId:e.student_id,departmentId:e.department_id,batchId:e.batch_id,sectionId:e.section_id}}function g(){n.isNativePlatform()||(window.location.pathname.includes("super-admin")||"true"===sessionStorage.getItem("is_super_admin")||"true"===localStorage.getItem("is_super_admin")?"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PRESERVE_ADMIN_CACHES",timestamp:Date.now()}):("caches"in window&&caches.keys().then((e=>{e.forEach((e=>{e.includes("nesttask")&&caches.delete(e).then((e=>{}))}))})),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(navigator.serviceWorker.controller.postMessage({type:"CLEAR_ALL_CACHES",timestamp:Date.now()}),navigator.serviceWorker.addEventListener("message",(e=>{e.data&&e.data.type}),{once:!0}))))}function p(e){n.isNativePlatform()||"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"AUTH_STATE_CHANGED",event:e?"SIGNED_IN":"SIGNED_OUT",timestamp:Date.now()})}const w="nesttask_remember_me",f="nesttask_saved_email";function _(){const[m,_]=e.useState(null),[v,S]=e.useState(!0),[I,y]=e.useState(null),[k,b]=e.useState(null),[N,E]=e.useState(0),[O,P]=e.useState(!0);e.useEffect((()=>{let e=!0;const a=localStorage.getItem(f);a&&b(a);const r=localStorage.getItem("nesttask_cached_user");if(r&&e)try{const e=JSON.parse(r);_(e)}catch(o){}A();const{data:{subscription:s}}=t.auth.onAuthStateChange(D);return()=>{e=!1,s.unsubscribe()}}),[]);const A=async()=>{try{let r=navigator.onLine;if(n.isNativePlatform())try{r=(await i.getStatus()).connected}catch(e){}if(!r){const t=localStorage.getItem("nesttask_cached_user");if(t)try{const e=JSON.parse(t);return _(e),P(!1),void S(!1)}catch(e){}return P(!1),void S(!1)}if(!(await a())){const t=localStorage.getItem("nesttask_cached_user");if(t)try{const e=JSON.parse(t);return _(e),void S(!1)}catch(e){}}const{data:{session:s},error:o}=await t.auth.getSession();if(o){const t=localStorage.getItem("nesttask_cached_user");if(t)try{const e=JSON.parse(t);_(e)}catch(e){}return void S(!1)}(null==s?void 0:s.user)?await W(s.user):P(!1)}catch(e){let t=navigator.onLine;if(n.isNativePlatform())try{t=(await i.getStatus()).connected}catch(r){}if(t){if(y("Failed to check authentication status"),N<3){const e=Math.min(1e3*Math.pow(2,N),1e4);return void setTimeout((()=>{E((e=>e+1)),A()}),e)}}else{const e=localStorage.getItem("nesttask_cached_user");if(e)try{const t=JSON.parse(e);_(t)}catch(s){}}}finally{S(!1)}},D=async(e,t)=>{if(!(null==t?void 0:t.user)&&O){let e=navigator.onLine;if(n.isNativePlatform())try{e=(await i.getStatus()).connected}catch(a){}if(!e&&m)return P(!1),void S(!1)}if(P(!1),null==t?void 0:t.user)try{await W(t.user)}catch(r){let e=navigator.onLine;if(n.isNativePlatform())try{e=(await i.getStatus()).connected}catch(a){}e&&await J()}else{let e=navigator.onLine;if(n.isNativePlatform())try{e=(await i.getStatus()).connected}catch(a){}e&&_(null)}S(!1)},J=async()=>{_(null),p(!1),localStorage.removeItem("supabase.auth.token"),localStorage.removeItem("nesttask_user"),localStorage.removeItem("nesttask_cached_user"),sessionStorage.removeItem("supabase.auth.token"),"true"!==localStorage.getItem(w)&&localStorage.removeItem(f),document.cookie.split(";").forEach((function(e){document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")})),g()},W=async e=>{var a,o,n;try{const c=r.userWithFullInfo(e.id),l=s.get(c);let d;if(l)d=l;else{const{data:a,error:r}=await t.from("users_with_full_info").select("*").eq("id",e.id).single();if(r)throw r;d=a,s.set(c,d)}let u=(null==d?void 0:d.role)||(null==(a=e.user_metadata)?void 0:a.role)||"user";"super_admin"!==u&&"super-admin"!==u||(u="super-admin");const m={id:e.id,email:e.email,name:(null==d?void 0:d.name)||(null==(o=e.user_metadata)?void 0:o.name)||(null==(n=e.email)?void 0:n.split("@")[0])||"",role:u,createdAt:(null==d?void 0:d.createdAt)||e.created_at,avatar:null==d?void 0:d.avatar,phone:null==d?void 0:d.phone,studentId:null==d?void 0:d.studentId,departmentId:null==d?void 0:d.departmentId,batchId:null==d?void 0:d.batchId,sectionId:null==d?void 0:d.sectionId,departmentName:null==d?void 0:d.departmentName,batchName:null==d?void 0:d.batchName,sectionName:null==d?void 0:d.sectionName};_(m);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(m))}catch(i){}}catch(i){throw i}};return{user:m,loading:v,error:I,login:async(e,a=!1)=>{try{if(y(null),a?(localStorage.setItem(w,"true"),localStorage.setItem(f,e.email)):(localStorage.removeItem(w),localStorage.removeItem(f)),("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname)&&localStorage.getItem("nesttask_demo_user"))try{const t=JSON.parse(localStorage.getItem("nesttask_demo_user")||"{}");if(t&&t.email===e.email)return _(t),p(!0),"super-admin"!==t.role&&"superadmin@nesttask.com"!==t.email||(localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true")),t}catch(n){}const c=await async function({email:e,password:a}){var r,s,i,c,l,m;try{if(!e||!a)throw new Error("Email and password are required");const p="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname;if(p&&["test@example.com","admin@example.com","demo@nesttask.com","test@nesttask.com","user@nesttask.com","superadmin@nesttask.com","admin@diu.edu.bd"].includes(e)){const t={id:`dev-${Math.random().toString(36).substring(2,9)}`,email:e,name:e.split("@")[0],role:e.includes("superadmin")?"super-admin":e.includes("admin")?"admin":e.includes("section")?"section-admin":"user",createdAt:(new Date).toISOString(),avatar:void 0,phone:"+1234567890",lastActive:(new Date).toISOString(),studentId:"12345",departmentId:"dept-1",batchId:"batch-1",sectionId:"section-1"};return localStorage.setItem("nesttask_demo_user",JSON.stringify(t)),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",e),localStorage.setItem("nesttask_auth_bypass","true"),localStorage.setItem("nesttask_cached_user",JSON.stringify(t)),t}await t.auth.setSession({access_token:"",refresh_token:""}),localStorage.setItem("nesttask_remember_me","true"),localStorage.setItem("nesttask_saved_email",e);const{data:w,error:f}=await t.auth.signInWithPassword({email:e,password:a});if(f){if(p){const t={id:`dev-fallback-${Math.random().toString(36).substring(2,9)}`,email:e,name:e.split("@")[0],role:e.includes("admin")?"admin":"user",createdAt:(new Date).toISOString(),avatar:void 0,phone:"+1234567890",lastActive:(new Date).toISOString(),studentId:"DEV12345",departmentId:"dev-dept-1",batchId:"dev-batch-1",sectionId:"dev-section-1"};return localStorage.setItem("nesttask_demo_user",JSON.stringify(t)),localStorage.setItem("nesttask_auth_bypass","true"),t}let t=o(f);throw f.message&&f.message.includes("Invalid login credentials")&&(t="Invalid email or password. Please try again."),f.message&&f.message.includes("fetch")&&(t="Network error. Please check your internet connection."),new Error(t)}if(!(null==w?void 0:w.user))throw new Error("No user data received");if(w.session){!function(){const e=setInterval((async()=>{try{const{data:e}=await t.auth.getSession();if(null==e?void 0:e.session){const{data:a,error:r}=await t.auth.refreshSession({refresh_token:e.session.refresh_token});if(r)return;(null==a?void 0:a.session)&&(localStorage.setItem("supabase.auth.token",JSON.stringify(a.session)),await d("session",JSON.stringify(a.session)))}}catch(n){}}),432e5);localStorage.setItem("nesttask_refresh_interval",e.toString()),window.addEventListener("focus",u)}(w.session.refresh_token),localStorage.setItem("supabase.auth.token",JSON.stringify(w.session));try{await d("session",JSON.stringify(w.session)),await d("email",e),await d("remember_me",!0)}catch(g){}}await new Promise((e=>setTimeout(e,1e3)));const{data:_,error:v}=await t.from("users").select().eq("id",w.user.id).maybeSingle();if(v){const e={id:w.user.id,email:w.user.email,name:(null==(r=w.user.user_metadata)?void 0:r.name)||(null==(s=w.user.email)?void 0:s.split("@")[0])||"",role:(null==(i=w.user.user_metadata)?void 0:i.role)||"user",created_at:(new Date).toISOString(),last_active:(new Date).toISOString()},{data:a,error:o}=await t.from("users").insert(e).select().single();if(o)throw new Error("Failed to create user profile");if(!a)throw new Error("No profile data received after creation");return h(a)}if(!_){const e={id:w.user.id,email:w.user.email,name:(null==(c=w.user.user_metadata)?void 0:c.name)||(null==(l=w.user.email)?void 0:l.split("@")[0])||"",role:(null==(m=w.user.user_metadata)?void 0:m.role)||"user",created_at:(new Date).toISOString(),last_active:(new Date).toISOString()},{data:a,error:r}=await t.from("users").insert(e).select().single();if(r)throw new Error("Failed to create user profile");if(!a)throw new Error("No profile data received after creation");return h(a)}return h(_)}catch(I){I.message,I.code,I.status,I.details;let t=o(I);throw I.message&&I.message.includes("Invalid login credentials")&&(t="Invalid email or password. Please try again."),I.message&&I.message.includes("fetch")&&(t="Network error. Please check your internet connection."),new Error(t)}}(e);if(p(!0),"super-admin"===c.role||"superadmin@nesttask.com"===e.email||"superadmin@nesttask.com"===c.email){c.role="super-admin";const e=r.userWithFullInfo(c.id||c.email),a=s.get(e);if(a&&a.name)c.name=a.name;else try{const{data:a,error:r}=await t.from("users_with_full_info").select("*").eq("email",c.email).single();!r&&a&&(a.name&&(c.name=a.name),s.set(e,a))}catch(n){}localStorage.setItem("is_super_admin","true"),sessionStorage.setItem("is_super_admin","true"),localStorage.setItem("auth_completed","true"),_(c);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(c))}catch(i){}return c}const{data:l,error:m}=await t.from("users").select("*").eq("id",c.id).single();m||l&&(l.role&&(c.role=l.role),l.department_id&&(c.departmentId=l.department_id),l.batch_id&&(c.batchId=l.batch_id),l.section_id&&(c.sectionId=l.section_id),l.phone&&(c.phone=l.phone),l.student_id&&(c.studentId=l.student_id),l.avatar&&(c.avatar=l.avatar)),_(c);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(c))}catch(i){}return g(),c}catch(n){throw y(n.message),n}},signup:async e=>{try{y(null),e.departmentId,e.batchId,e.sectionId;const r=await async function({email:e,password:a,name:r,phone:s,studentId:o,departmentId:n,batchId:i,sectionId:c}){try{if(!e||!a||!r)throw new Error("All fields are required");if(!n||!i||!c)throw new Error("Please select your department, batch, and section before signing up");if(!(e.endsWith("@diu.edu.bd")||e.includes("@gmail.com")||e.includes("@test.com")||"superadmin@nesttask.com"===e))throw new Error("Please use a valid email address (@diu.edu.bd, or test email)");const{data:l,error:d}=await t.auth.signUp({email:e,password:a,options:{emailRedirectTo:window.location.origin,data:{name:r,phone:s||"",studentId:o||"",role:"user",departmentId:n,batchId:i,sectionId:c}}});if(d)throw d;if(!(null==l?void 0:l.user))throw new Error("Failed to create user");await new Promise((e=>setTimeout(e,2e3)));const{data:u,error:m}=await t.from("users_with_full_info").select("*").eq("id",l.user.id).single();if(m){const{data:a,error:d}=await t.from("users").select("*").eq("id",l.user.id).single();return d?{id:l.user.id,email:e,name:r,phone:s,studentId:o,role:"user",createdAt:(new Date).toISOString(),departmentId:n,batchId:i,sectionId:c}:h(a)}return{id:u.id,email:u.email,name:u.name,role:u.role,phone:u.phone,studentId:u.studentId,createdAt:u.createdAt,lastActive:u.lastActive,departmentId:u.departmentId,departmentName:u.departmentName,batchId:u.batchId,batchName:u.batchName,sectionId:u.sectionId,sectionName:u.sectionName}}catch(I){throw new Error(I.message||"Failed to create account")}}(e);_(r);try{localStorage.setItem("nesttask_cached_user",JSON.stringify(r)),localStorage.setItem("nesttask_user",JSON.stringify(r))}catch(a){}return p(!0),r}catch(r){throw y(r.message),r}},logout:async()=>{try{y(null),_(null),p(!1);const e="true"===localStorage.getItem(w);s.clear();const a=["supabase.auth.token","nesttask_user","nesttask_cached_user","nesttask_refresh_interval","is_super_admin","auth_completed"];e||a.push(f),a.forEach((e=>localStorage.removeItem(e))),sessionStorage.removeItem("supabase.auth.token"),sessionStorage.removeItem("is_super_admin"),document.cookie.split(";").forEach((e=>{document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")}));const r=async function(){try{const e=localStorage.getItem("nesttask_refresh_interval");e&&clearInterval(parseInt(e)),window.removeEventListener("focus",u);const a=t.auth.signOut({scope:"local"}).then((({error:e})=>{})),r=l().then((e=>e.transaction(c,"readwrite").objectStore(c).clear().then((()=>e.close())))).catch((e=>{}));await Promise.all([a,r])}catch(I){}}(),o=g();return await Promise.all([r,o]),!0}catch(e){return y(e.message),!1}},forgotPassword:async e=>{try{y(null),await async function(e){try{if(!e)throw new Error("Email is required");const{error:a}=await t.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/#auth/recovery`});if(a)throw a}catch(I){throw new Error(o(I)||"Failed to send password reset email. Please try again.")}}(e)}catch(a){throw y(a.message),a}},savedEmail:k}}export{_ as u};
